{% load static %}
<!DOCTYPE html>
<html>

<head>
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="icon" type="image/png" href="{% static 'accounts/favicon.png' %}">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <style>
    .ql-editor {
      min-height: 150px;
      font-family: inherit;
      font-size: 14px;
    }

    .program-type-badge {
      display: inline-block;
      padding: 0.25em 0.8em;
      font-size: 0.75em;
      font-weight: 700;
      color: #fff;
      background-color: #4a5568;
      border-radius: 9999px;
      margin-left: 8px;
      vertical-align: middle;
    }

    .nav-badge {
      display: none;
      position: absolute;
      top: 10px;
      left: 30px;
      background-color: #EF4444;
      color: white;
      border-radius: 9999px;
      padding: 1px 6px;
      font-size: 0.7rem;
      min-width: 18px;
      text-align: center;
      font-weight: bold;
      z-index: 5;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<link rel="stylesheet" href="{% static 'accounts/admin_dashboard.css' %}?v=2">

<body>
  <header>
    <h1>ScholarSync Subic</h1>
    <p class="welcome-text">Welcome, {{ admin.admin_name }}!</p>
  </header>

  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <nav>
        <a href="#" class="nav-link active" data-tab="dashboard">
          <i class="fas fa-chart-line"></i> Dashboard
        </a>
        <a href="#" class="nav-link" data-tab="student-registrations">
          <i class="fas fa-user-plus"></i> Student Registration
          <span class="nav-badge" id="badge-registrations">0</span>
        </a>
        <a href="#" class="nav-link" data-tab="student-applications">
          <i class="fas fa-file-alt"></i> Program Applications
          <span class="nav-badge" id="badge-applications">0</span>
        </a>
        <a href="#" class="nav-link" data-tab="notifications">
          <i class="fas fa-bell"></i> Notifications
          <span class="nav-badge" id="badge-notifications">0</span>
        </a>
        <a href="#" class="nav-link" data-tab="students">
          <i class="fas fa-users-cog"></i> Student Management
        </a>
        <a href="#" class="nav-link" data-tab="settings">
          <i class="fas fa-cog"></i> Settings
        </a>
        <a href="#" class="nav-link" data-tab="reports">
          <i class="fas fa-chart-bar"></i> Reports
        </a>
        <a href="#" class="nav-item" data-tab="programs">
          <i class="fas fa-graduation-cap"></i>
          Programs
        </a>
        <a href="#" class="nav-link" data-tab="inbox">
          <i class="fas fa-inbox"></i> Inbox / Support
          <span class="nav-badge" id="badge-inbox">0</span>
        </a>
      </nav>
      <a href="{% url 'accounts:logout' %}" class="logout-btn">Logout</a>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Dashboard Tab -->
      <div id="dashboard" class="tab-content active">
        <div class="card">
          <h3>Dashboard Overview</h3>
          <p>Welcome to your admin dashboard. Use the sidebar to navigate between different sections.</p>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
              <h4>Total Students</h4>
              <span class="stat-number" id="total-students">Loading...</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-bell"></i>
            </div>
            <div class="stat-content">
              <h4>Active Popups</h4>
              <span class="stat-number" id="active-popups">Loading...</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
              <h4>Pending Applications</h4>
              <span class="stat-number" id="pending-applications">Loading...</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-graduation-cap"></i>
            </div>
            <div class="stat-content">
              <h4>Total Programs</h4>
              <span class="stat-number" id="total-programs">Loading...</span>
            </div>
          </div>
        </div>

        <!-- Chart Section -->
        <div class="card chart-card">
          <div class="card-header">
            <h3>Application Trends</h3>
            <div class="chart-controls">
              <select id="chart-period" onchange="updateChart()">
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 90 Days</option>
              </select>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="applicationsChart" width="400" height="200"></canvas>
          </div>
        </div>

        <!-- Student Statistics Bar Chart -->
        <div class="card chart-card">
          <div class="card-header">
            <h3>Student Statistics</h3>
            <div class="chart-controls">
              <select id="student-chart-type" onchange="updateStudentChart()">
                <option value="status" selected>By Status</option>
                <option value="program">By Program</option>
                <option value="monthly">Monthly Registrations</option>
              </select>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="studentChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Student Account Registration Tab -->
      <div id="student-registrations" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>Student Account Registration</h3>
            <div class="application-filters">
              <select id="registration-filter" onchange="filterRegistrations()">
                <option value="all">All Registrations</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
          </div>

          <div class="application-list" id="registration-list">
            <!-- Student registrations will be loaded here via JavaScript -->
          </div>
        </div>
      </div>

      <!-- Student Applications Tab -->
      <div id="student-applications" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>Student Program Applications</h3>
            <div class="application-filters">
              <select id="program-application-filter" onchange="filterProgramApplications()">
                <option value="all">All Applications</option>
                <option value="submitted">Submitted</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
          </div>

          <div class="application-list" id="program-application-list">
            <!-- Program applications will be loaded here via JavaScript -->
          </div>
        </div>
      </div>

      <!-- Notification Center Tab -->
      <div id="notifications" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>Notification Center</h3>
            <button class="btn btn-primary" onclick="openPopupModal()">Create New Popup</button>
          </div>

          <div class="popup-filters">
            <select id="popup-filter" onchange="filterPopups()">
              <option value="all">All Popups</option>
              <option value="active">Active Only</option>
              <option value="inactive">Inactive Only</option>
              <option value="info">Information</option>
              <option value="warning">Warning</option>
              <option value="success">Success</option>
              <option value="error">Error</option>
            </select>
          </div>

          <div class="popup-list" id="popup-list">
            <!-- Popups will be loaded here via JavaScript -->
          </div>
        </div>
      </div>

      <!-- Students Tab -->
      <div id="students" class="tab-content">
        <div class="card">
          <div class="card">
            <div class="card-header">
              <h3>Student Management</h3>
              <div class="application-filters">
                <input type="text" id="student-search" placeholder="Search students..." onkeyup="filterStudents()"
                  class="search-input">
                <select id="student-status-filter" onchange="filterStudents()">
                  <option value="all">All Students</option>
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                  <option value="pending">Pending</option>
                  <option value="rejected">Rejected</option>
                </select>
              </div>
            </div>

            <div class="student-list" id="student-list">
              <!-- Students will be loaded here via JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Inbox / Support Tab -->
      <div id="inbox" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>Inbox / Support Tickets</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
              <button class="btn btn-sm btn-outline" onclick="loadAdminMessages()">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
              <div class="application-filters" style="margin: 0;">
                <select id="inbox-filter" onchange="filterAdminMessages()" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                  <option value="all">All Messages</option>
                  <option value="unread">Unread Only</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="overflow-x-auto" style="margin-top: 15px;">
            <table class="data-table" style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                  <th style="padding: 12px; text-align: left;">Status</th>
                  <th style="padding: 12px; text-align: left;">Student</th>
                  <th style="padding: 12px; text-align: left;">Subject</th>
                  <th style="padding: 12px; text-align: left;">Date</th>
                  <th style="padding: 12px; text-align: center;">Action</th>
                </tr>
              </thead>
              <tbody id="admin-inbox-list">
                <tr><td colspan="5" style="text-align: center; color: #64748b; padding: 20px;">Loading messages...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="settings" class="tab-content">
        <div class="card">
          <h3>Settings</h3>
          <div class="settings-section">
            <h4>Change Password</h4>
            <form id="change-password-form" onsubmit="changeAdminPassword(event)">
              <div class="form-group">
                <label for="new_password">New Password</label>
                <input type="password" id="new_password" name="new_password" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="confirm_password">Retype New Password</label>
                <input type="password" id="confirm_password" name="confirm_password" class="form-control" required>
              </div>
              <button type="submit" class="btn btn-primary">Update Password</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Programs Tab Content -->
      <div id="programs" class="tab-content">
        <div class="card">
          <h3>Program Management</h3>

          <div class="program-actions">
            <button class="btn btn-primary" onclick="showCreateProgram()">
              Create New Program
            </button>
          </div>

          <div id="createProgramForm" class="program-form-wrapper">
            <form class="program-form" method="POST">
              {% csrf_token %}
              <label for="p_name">Program Name</label>
              <input id="p_name" name="program_name" type="text" required>

              <label for="p_type">Program Type</label>
              <select id="p_type" name="program_type" required>
                <option value="Financial Assistance">Financial Assistance</option>
                <option value="Scholarship">Scholarship</option>
                <option value="Other">Other</option>
              </select>

              <label for="p_req">Requirements</label>
              <textarea id="p_req" name="requirements" rows="3"></textarea>

              <div class="form-group" style="margin-top: 15px;">
                <label>Application Period</label>
                <div style="display: flex; gap: 10px;">
                  <div style="flex: 1;">
                    <label for="p_start" style="font-size: 0.9em;">Start Date</label>
                    <input id="p_start" name="application_start_date" type="date">
                  </div>
                  <div style="flex: 1;">
                    <label for="p_end" style="font-size: 0.9em;">End Date</label>
                    <input id="p_end" name="application_end_date" type="date">
                  </div>
                </div>
              </div>

              <label for="p_img" style="margin-top: 15px;">Background Image</label>
              <input id="p_img" name="program_image" type="file" accept="image/*">

              <div class="form-actions">
                <button type="submit" class="btn btn-primary">Create Program</button>
              </div>
            </form>


          </div>

          <div class="programs-list">
            <!-- Programs will load here -->
          </div>
        </div>
      </div>


      <!-- Reports Tab -->
      <div id="reports" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>Generate Reports</h3>
          </div>

          <div class="report-filters"
            style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 20px;">
            <div class="form-group" style="margin-bottom: 0;">
              <label for="report-type" style="display: block; margin-bottom: 5px; font-weight: 600;">Report Type</label>
              <select id="report-type" class="form-control" onchange="toggleReportFilters()"
                style="padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
                <option value="students">Students</option>
                <option value="applications">Program Applications</option>
              </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label for="report-start-date" style="display: block; margin-bottom: 5px; font-weight: 600;">Start
                Date</label>
              <input type="date" id="report-start-date" class="form-control"
                style="padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label for="report-end-date" style="display: block; margin-bottom: 5px; font-weight: 600;">End
                Date</label>
              <input type="date" id="report-end-date" class="form-control"
                style="padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label for="report-status" style="display: block; margin-bottom: 5px; font-weight: 600;">Status</label>
              <select id="report-status" class="form-control"
                style="padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
                <option value="all">All Statuses</option>
                <option value="active">Active</option>
                <option value="pending">Pending</option>
                <option value="rejected">Rejected</option>
                <option value="submitted">Submitted (Applications Only)</option>
                <option value="approved">Approved (Applications Only)</option>
              </select>
            </div>

            <div class="form-group" id="report-program-filter" style="margin-bottom: 0; display: none;">
              <label for="report-program" style="display: block; margin-bottom: 5px; font-weight: 600;">Program</label>
              <select id="report-program" class="form-control"
                style="padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
                <option value="all">All Programs</option>
                {% for program in programs %}
                <option value="{{ program.program_id }}">{{ program.program_name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-actions" style="margin-bottom: 0;">
              <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
              <button class="btn btn-success" onclick="exportReport('csv')">Export CSV</button>
              <button class="btn btn-info" onclick="exportReport('word')">Export Word</button>
            </div>
          </div>

          <div class="report-results" style="overflow-x: auto;">
            <table class="data-table" id="report-table"
              style="width: 100%; border-collapse: collapse; margin-top: 15px;">
              <thead>
                <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                  <!-- Headers will be populated by JS -->
                </tr>
              </thead>
              <tbody>
                <!-- Data will be populated by JS -->
              </tbody>
            </table>
            <p id="no-data-message" style="display: none; text-align: center; margin-top: 20px; color: #6c757d;">No data
              found for the selected criteria.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Reply Modal -->
  <div id="admin-reply-modal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
    <div class="modal-content" style="background-color: #fff; padding: 25px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #1e293b; font-size: 1.25rem;">Reply to Ticket</h3>
        <span class="close" onclick="closeAdminReplyModal()" style="cursor: pointer; font-size: 24px; color: #64748b;">&times;</span>
      </div>
      
      <div style="background-color: #f8fafc; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
        <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-start;">
          <div style="width: 40px; height: 40px; border-radius: 50%; background-color: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem;" id="admin-reply-avatar">S</div>
          <div style="flex: 1;">
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px;">
              <strong style="color: #1e293b; font-size: 1.1rem;" id="admin-reply-sender">Student Name</strong>
              <small style="color: #64748b;" id="admin-reply-date">Date Time</small>
            </div>
            <strong style="color: #334155; display: block; margin-bottom: 8px;" id="admin-reply-subject">Subject</strong>
            <p style="margin: 0; color: #475569; line-height: 1.5; white-space: pre-wrap;" id="admin-reply-body">Message body...</p>
          </div>
        </div>
      </div>
      
      <form id="admin-reply-form" onsubmit="handleAdminReplySubmit(event)">
        <input type="hidden" id="admin-reply-student-id">
        <div id="admin-reply-msg" style="display: none; padding: 10px; border-radius: 6px; margin-bottom: 15px;"></div>
        
        <div class="form-group" style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569;">Your Reply</label>
          <textarea id="admin-reply-text" rows="5" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; resize: vertical;" required placeholder="Type your reply here..."></textarea>
        </div>
        
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" class="btn btn-secondary" onclick="closeAdminReplyModal()" style="padding: 8px 16px; background-color: #e2e8f0; color: #475569; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
          <button type="submit" class="btn btn-primary" id="adminReplyBtn" style="padding: 8px 16px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Send Reply</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Popup Modal -->
  <div id="popup-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Create New Popup</h3>
        <span class="close" onclick="closePopupModal()">&times;</span>
      </div>
      <form id="popup-form">
        <input type="hidden" id="popup-id" name="popup_id">
        <div class="form-group">
          <label for="popup-title">Title:</label>
          <input type="text" id="popup-title" name="title" required>
        </div>
        <div class="form-group">
          <label for="popup-message">Message:</label>
          <textarea id="popup-message" name="message" rows="4" required></textarea>
        </div>
        <div class="form-group">
          <label for="popup-type">Type:</label>
          <select id="popup-type" name="popup_type">
            <option value="info">Information</option>
            <option value="warning">Warning</option>
            <option value="success">Success</option>
            <option value="error">Error</option>
          </select>
        </div>
        <div class="form-group">
          <label for="popup-expires">Expires At (optional):</label>
          <input type="datetime-local" id="popup-expires" name="expires_at">
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="popup-active" name="is_active" checked>
            Active
          </label>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closePopupModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Popup</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Tab switching functionality
    document.addEventListener('DOMContentLoaded', function () {
      const tabs = document.querySelectorAll('.nav-link, .nav-item');
      const contents = document.querySelectorAll('.tab-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          e.preventDefault();

          // Remove active class from all tabs
          tabs.forEach(t => t.classList.remove('active'));

          // Hide all content sections
          contents.forEach(c => c.classList.remove('active'));

          // Add active class to clicked tab
          tab.classList.add('active');

          // Show corresponding content
          const targetId = tab.getAttribute('data-tab');
          document.getElementById(targetId)?.classList.add('active');

          // Lazy-load data when tab is opened
          if (targetId === 'student-registrations') {
            loadStudentRegistrations();
          } else if (targetId === 'student-applications') {
            loadProgramApplications();
          } else if (targetId === 'notifications') {
            loadPopups();
          } else if (targetId === 'dashboard') {
            loadDashboardStats();
          } else if (targetId === 'programs') {
            loadPrograms();
          } else if (targetId === 'students') {
            loadStudents();
          }
        });
      });

      // Initial loads
      loadDashboardStats();
      initChart();
      initStudentChart();
      // Preload student registrations so it's ready when tab opens
      loadStudentRegistrations();

      // Initialize report filters visibility
      toggleReportFilters();
    });

    // Report Functions
    function toggleReportFilters() {
      const type = document.getElementById('report-type').value;
      const programFilter = document.getElementById('report-program-filter');
      const statusSelect = document.getElementById('report-status');

      // Show/Hide Program filter
      if (type === 'applications') {
        programFilter.style.display = 'block';

        // Update status options for applications
        statusSelect.innerHTML = `
                <option value="all">All Statuses</option>
                <option value="submitted">Submitted</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
            `;
      } else {
        programFilter.style.display = 'none';

        // Update status options for students
        statusSelect.innerHTML = `
                <option value="all">All Statuses</option>
                <option value="active">Active</option>
                <option value="pending">Pending</option>
                <option value="rejected">Rejected</option>
                <option value="inactive">Inactive</option>
            `;
      }
    }

    function generateReport() {
      const type = document.getElementById('report-type').value;
      const startDate = document.getElementById('report-start-date').value;
      const endDate = document.getElementById('report-end-date').value;
      const status = document.getElementById('report-status').value;
      const program = document.getElementById('report-program').value;

      let queryParams = new URLSearchParams({
        type: type,
        start_date: startDate,
        end_date: endDate,
        status: status
      });

      if (type === 'applications') {
        queryParams.append('program', program);
      }

      fetch(`/api/admin/reports/?${queryParams.toString()}`)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert('Error generating report: ' + data.error);
            return;
          }
          renderReportTable(data.data, type);
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while generating the report.');
        });
    }

    function renderReportTable(data, type) {
      const table = document.getElementById('report-table');
      const thead = table.querySelector('thead tr');
      const tbody = table.querySelector('tbody');
      const noDataMsg = document.getElementById('no-data-message');

      thead.innerHTML = '';
      tbody.innerHTML = '';

      if (!data || data.length === 0) {
        table.style.display = 'none';
        noDataMsg.style.display = 'block';
        return;
      }

      table.style.display = 'table';
      noDataMsg.style.display = 'none';

      // Set Headers
      let headers = [];
      if (type === 'students') {
        headers = ['ID', 'Username', 'First Name', 'Last Name', 'Email', 'Program', 'Status', 'Date Joined'];
      } else {
        headers = ['App ID', 'Student', 'Program', 'Status', 'Date Submitted'];
      }

      headers.forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        th.style.padding = '12px';
        th.style.textAlign = 'left';
        th.style.fontWeight = '600';
        thead.appendChild(th);
      });

      // Set Rows
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #e9ecef';

        let cells = [];
        if (type === 'students') {
          cells = [
            row.id,
            row.username,
            row.first_name,
            row.last_name,
            row.email,
            row.program,
            `<span class="badge badge-${row.status.toLowerCase()}">${row.status}</span>`,
            row.created_at
          ];
        } else {
          cells = [
            row.id,
            row.student,
            row.program,
            `<span class="badge badge-${row.status.toLowerCase()}">${row.status}</span>`,
            row.created_at
          ];
        }

        cells.forEach(cellContent => {
          const td = document.createElement('td');
          td.innerHTML = cellContent; // Use innerHTML for badge spans
          td.style.padding = '12px';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function exportReport(format = 'csv') {
      const type = document.getElementById('report-type').value;
      const startDate = document.getElementById('report-start-date').value;
      const endDate = document.getElementById('report-end-date').value;
      const status = document.getElementById('report-status').value;
      const program = document.getElementById('report-program').value;

      let queryParams = new URLSearchParams({
        type: type,
        start_date: startDate,
        end_date: endDate,
        status: status,
        export: format
      });

      if (type === 'applications') {
        queryParams.append('program', program);
      }

      // Trigger download
      window.location.href = `/api/admin/reports/?${queryParams.toString()}`;
    }

    // Program form toggle functions
    function showCreateProgram() {
      document.getElementById('createProgramForm').style.display = 'block';
    }

    function hideCreateProgram() {
      document.getElementById('createProgramForm').style.display = 'none';
    }
    // Popup management functions
    function loadPopups() {
      fetch('/admin/popups/')
        .then(response => response.json())
        .then(data => {
          const popupList = document.getElementById('popup-list');
          popupList.innerHTML = '';

          if (data.popups.length === 0) {
            popupList.innerHTML = '<p class="no-popups">No popups found.</p>';
            return;
          }

          data.popups.forEach(popup => {
            const popupElement = createPopupElement(popup);
            popupList.appendChild(popupElement);
          });
        })
        .catch(error => {
          console.error('Error loading popups:', error);
          document.getElementById('popup-list').innerHTML = '<p class="error">Error loading popups.</p>';
        });
    }

    function createPopupElement(popup) {
      const div = document.createElement('div');
      div.className = `popup-item popup-${popup.popup_type} ${popup.is_active ? 'active' : 'inactive'}`;
      div.innerHTML = `
        <div class="popup-header">
          <h4>${popup.title}</h4>
          <div class="popup-actions">
            <button class="btn btn-sm btn-secondary" onclick="editPopup(${popup.id})">Edit</button>
            <button class="btn btn-sm ${popup.is_active ? 'btn-warning' : 'btn-success'}" onclick="togglePopup(${popup.id})">
              ${popup.is_active ? 'Deactivate' : 'Activate'}
            </button>
            <button class="btn btn-sm btn-danger" onclick="deletePopup(${popup.id})">Delete</button>
          </div>
        </div>
        <div class="popup-content">
          <p>${popup.message}</p>
          <div class="popup-meta">
            <span class="popup-type">${popup.popup_type}</span>
            <span class="popup-date">Created: ${new Date(popup.created_at).toLocaleDateString()}</span>
            ${popup.expires_at ? `<span class="popup-expires">Expires: ${new Date(popup.expires_at).toLocaleDateString()}</span>` : ''}
          </div>
        </div>
      `;
      return div;
    }

    function openPopupModal(popupId = null) {
      const modal = document.getElementById('popup-modal');
      const form = document.getElementById('popup-form');
      const title = document.getElementById('modal-title');

      if (popupId) {
        title.textContent = 'Edit Popup';
        // Load popup data for editing
        fetch(`/api/admin/popups/${popupId}/`)
          .then(response => response.json())
          .then(data => {
            document.getElementById('popup-id').value = data.id;
            document.getElementById('popup-title').value = data.title;
            document.getElementById('popup-message').value = data.message;
            document.getElementById('popup-type').value = data.popup_type;
            document.getElementById('popup-active').checked = data.is_active;
            if (data.expires_at) {
              document.getElementById('popup-expires').value = new Date(data.expires_at).toISOString().slice(0, 16);
            }
          });
      } else {
        title.textContent = 'Create New Popup';
        form.reset();
        document.getElementById('popup-id').value = '';
      }

      modal.style.display = 'block';
    }

    function closePopupModal() {
      document.getElementById('popup-modal').style.display = 'none';
    }

    function editPopup(popupId) {
      openPopupModal(popupId);
    }

    function togglePopup(popupId) {
      fetch(`/api/admin/popups/${popupId}/toggle/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json',
        },
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            loadPopups();
          } else {
            alert('Error toggling popup: ' + data.error);
          }
        });
    }

    function changeAdminPassword(event) {
      event.preventDefault();

      const newPassword = document.getElementById('new_password').value;
      const confirmPassword = document.getElementById('confirm_password').value;

      if (newPassword !== confirmPassword) {
        alert("Passwords do not match!");
        return;
      }

      fetch('/api/admin/change-password/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          new_password: newPassword,
          confirm_password: confirmPassword
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(data.message);
            document.getElementById('change-password-form').reset();
          } else {
            alert(data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while changing the password.');
        });
    }

    function deletePopup(popupId) {
      if (confirm('Are you sure you want to delete this popup?')) {
        fetch(`/api/admin/popups/${popupId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
          },
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              loadPopups();
            } else {
              alert('Error deleting popup: ' + data.error);
            }
          });
      }
    }

    function filterPopups() {
      const filter = document.getElementById('popup-filter').value;
      const popupItems = document.querySelectorAll('.popup-item');

      popupItems.forEach(item => {
        if (filter === 'all') {
          item.style.display = 'block';
        } else if (filter === 'active') {
          item.style.display = item.classList.contains('active') ? 'block' : 'none';
        } else if (filter === 'inactive') {
          item.style.display = item.classList.contains('inactive') ? 'block' : 'none';
        } else {
          item.style.display = item.classList.contains(`popup-${filter}`) ? 'block' : 'none';
        }
      });
    }

    function loadDashboardStats() {
      console.log('Loading dashboard stats...');
      fetch('/api/admin/stats/', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
      })
        .then(response => {
          console.log('Stats response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Stats data:', data);
          document.getElementById('total-students').textContent = data.total_students || 0;
          document.getElementById('active-popups').textContent = data.active_popups || 0;
          document.getElementById('pending-applications').textContent = data.pending_program_applications || 0;
          document.getElementById('total-programs').textContent = data.total_programs || 0;

          // Update Badges
          updateBadge('badge-registrations', data.pending_student_registrations);
          updateBadge('badge-applications', data.pending_program_applications);
          updateBadge('badge-notifications', data.active_popups);
          updateBadge('badge-inbox', data.unread_messages);
        })
        .catch(error => {
          console.error('Error loading stats:', error);
        });
    }

    function updateBadge(elementId, count) {
      const badge = document.getElementById(elementId);
      if (badge) {
        badge.textContent = count || 0;
        if (count > 0) {
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    // Chart functionality
    let applicationsChart = null;
    let studentChart = null;

    function initChart() {
      const ctx = document.getElementById('applicationsChart').getContext('2d');
      fetchApplicationTrends(30, ctx);
    }

    function updateChart() {
      const period = document.getElementById('chart-period').value;
      fetchApplicationTrends(period);
    }

    function fetchApplicationTrends(days, ctx = null) {
      fetch(`/api/admin/charts/application-trends/?period=${days}`)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error('Error fetching application trends:', data.error);
            return;
          }

          if (ctx) {
            // Initialize Chart
            applicationsChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: data.labels,
                datasets: [{
                  label: 'Applications',
                  data: data.data,
                  borderColor: '#10B981',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  pointBackgroundColor: '#10B981',
                  pointBorderColor: '#F59E0B',
                  pointBorderWidth: 2,
                  pointRadius: 5,
                  pointHoverRadius: 7
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: {
                      color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                      stepSize: 1
                    }
                  },
                  x: {
                    grid: {
                      display: false
                    }
                  }
                },
                elements: {
                  point: {
                    hoverBackgroundColor: '#764ba2'
                  }
                }
              }
            });
          } else if (applicationsChart) {
            // Update Chart
            applicationsChart.data.labels = data.labels;
            applicationsChart.data.datasets[0].data = data.data;
            applicationsChart.update();
          }
        })
        .catch(error => console.error('Error:', error));
    }

    function initStudentChart() {
      const ctx = document.getElementById('studentChart').getContext('2d');
      fetchStudentStats('status', ctx);
    }

    function updateStudentChart() {
      const chartType = document.getElementById('student-chart-type').value;
      fetchStudentStats(chartType);
    }

    function fetchStudentStats(type, ctx = null) {
      fetch(`/api/admin/charts/student-statistics/?type=${type}`)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error('Error fetching student stats:', data.error);
            return;
          }

          const configData = {
            labels: data.labels,
            datasets: [{
              label: type === 'monthly' ? 'Registrations' : 'Students',
              data: data.data,
              backgroundColor: data.colors || 'rgba(16, 185, 129, 0.8)',
              borderColor: data.colors ? data.colors.map(c => c.replace('0.8', '1')) : '#10B981',
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            }]
          };

          if (ctx) {
            studentChart = new Chart(ctx, {
              type: 'bar',
              data: configData,
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: {
                      color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                      stepSize: 1 // Changed from 5 to 1 for better visibility with low usage
                    }
                  },
                  x: {
                    grid: {
                      display: false
                    }
                  }
                },
                elements: {
                  bar: {
                    borderRadius: 8
                  }
                }
              }
            });
          } else if (studentChart) {
            studentChart.data = configData;
            studentChart.update();
          }
        })
        .catch(error => console.error('Error:', error));
    }

    // Student Registration Management Functions
    function loadStudentRegistrations() {
      console.log('Loading student applications...');
      fetch('/api/admin/student-applications/', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
      })
        .then(response => {
          console.log('Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Registrations data:', data);
          const registrationList = document.getElementById('registration-list');
          registrationList.innerHTML = '';

          if (data.applications.length === 0) {
            registrationList.innerHTML = '<p class="no-applications">No student registrations found.</p>';
            return;
          }

          data.applications.forEach(application => {
            const applicationElement = createApplicationElement(application);
            registrationList.appendChild(applicationElement);
          });
        })
        .catch(error => {
          console.error('Error loading registrations:', error);
          document.getElementById('registration-list').innerHTML = '<p class="error">Error loading registrations: ' + error.message + '</p>';
        });
    }

    function createApplicationElement(application) {
      const div = document.createElement('div');
      div.className = `application-item application-${application.status}`;
      div.innerHTML = `
        <div class="application-header">
          <h4>${application.first_name} ${application.last_name}</h4>
          <div class="application-status">
            <span class="status-badge status-${application.status}">${application.status}</span>
          </div>
        </div>
        <div class="application-content">
          <div class="application-details">
            <div class="detail-row">
              <span class="detail-label">Username:</span>
              <span class="detail-value">${application.username}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Email:</span>
              <span class="detail-value">${application.email}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Program & Year:</span>
              <span class="detail-value">${application.program_and_yr}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Contact:</span>
              <span class="detail-value">${application.contact_num}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Address:</span>
              <span class="detail-value">${application.address}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Birthday:</span>
              <span class="detail-value">${new Date(application.bday).toLocaleDateString()}</span>
            </div>
            ${application.doc_submitted ? `
            <div class="detail-row">
              <span class="detail-label">Document:</span>
              <span class="detail-value">
                <a href="/media/${application.doc_submitted}" target="_blank" class="document-link">View Document</a>
              </span>
            </div>
            ` : ''}
          </div>
          <div class="application-meta">
            <span class="application-date">Applied: ${new Date(application.created_at || Date.now()).toLocaleDateString()}</span>
          </div>
          <div class="application-actions">
            ${application.status === 'pending' ? `
              <button class="btn btn-success btn-sm" onclick="approveStudent(${application.id})">Approve</button>
              <button class="btn btn-danger btn-sm" onclick="rejectStudent(${application.id})">Reject</button>
            ` : `
              <span class="action-completed">Action completed</span>
            `}
          </div>
        </div>
      `;
      return div;
    }

    function approveStudent(studentId) {
      if (confirm('Are you sure you want to approve this student application?')) {
        fetch(`/api/admin/student-applications/${studentId}/approve/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
          },
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              loadStudentRegistrations();
              loadDashboardStats(); // Refresh stats
            } else {
              alert('Error approving student: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error approving student application');
          });
      }
    }

    function rejectStudent(studentId) {
      if (confirm('Are you sure you want to reject this student application?')) {
        fetch(`/api/admin/student-applications/${studentId}/reject/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
          },
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              loadStudentRegistrations();
              loadDashboardStats(); // Refresh stats
            } else {
              alert('Error rejecting student: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error rejecting student application');
          });
      }
    }

    function filterRegistrations() {
      const filter = document.getElementById('registration-filter').value;
      const applicationItems = document.querySelectorAll('.application-item');

      applicationItems.forEach(item => {
        if (filter === 'all') {
          item.style.display = 'block';
        } else {
          item.style.display = item.classList.contains(`application-${filter}`) ? 'block' : 'none';
        }
      });
    }

    // Program Application Management Functions
    let currentApplications = []; // Store fetched applications

    function loadProgramApplications() {
      console.log('Loading program applications...');
      fetch('/api/admin/program-applications/', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
      })
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then(data => {
          currentApplications = data.applications || []; // Store for modal access
          const applicationList = document.getElementById('program-application-list');
          applicationList.innerHTML = '';

          if (currentApplications.length === 0) {
            applicationList.innerHTML = '<p class="no-applications">No program applications found.</p>';
            return;
          }

          currentApplications.forEach(application => {
            const applicationElement = createProgramApplicationElement(application);
            applicationList.appendChild(applicationElement);
          });
        })
        .catch(error => {
          console.error('Error loading program applications:', error);
          document.getElementById('program-application-list').innerHTML = '<p class="error">Error loading program applications.</p>';
        });
    }

    function createProgramApplicationElement(application) {
      const div = document.createElement('div');
      div.className = `application-item application-${application.requirement_status}`;
      div.innerHTML = `
        <div class="application-header">
          <h4>${application.student.first_name} ${application.student.last_name}</h4>
          <div class="application-status">
            <span class="status-badge status-${application.requirement_status}">${application.requirement_status}</span>
          </div>
        </div>
        <div class="application-content">
          <div class="application-details">
            <div class="detail-row">
              <span class="detail-label">Student:</span>
              <span class="detail-value">${application.student.username}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Program:</span>
              <span class="detail-value">${application.program.program_name}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Applied:</span>
              <span class="detail-value">${application.created_at ? new Date(application.created_at).toLocaleDateString() : 'Date not available'}</span>
            </div>
          </div>
          <div class="application-actions">
            <button class="btn btn-primary btn-sm" onclick="viewApplication(${application.app_id})">View</button>
            ${application.requirement_status === 'submitted' ? `
              <button class="btn btn-success btn-sm" onclick="approveProgramApplication(${application.app_id})">Approve</button>
              <button class="btn btn-danger btn-sm" onclick="rejectProgramApplication(${application.app_id})">Reject</button>
            ` : ''}
          </div>
        </div>
      `;
      return div;
    }

    function viewApplication(appId) {
      const app = currentApplications.find(a => a.app_id === appId);
      if (!app) return;

      document.getElementById('app-modal-student').textContent = `${app.student.first_name} ${app.student.last_name} (@${app.student.username})`;
      document.getElementById('app-modal-program').textContent = app.program.program_name;
      document.getElementById('app-modal-status').textContent = app.requirement_status;
      document.getElementById('app-modal-email').textContent = app.student.email;
      document.getElementById('app-modal-date').textContent = app.created_at ? new Date(app.created_at).toLocaleString() : 'N/A';

      const docContainer = document.getElementById('app-modal-document');
      docContainer.innerHTML = ''; // Clear previous content

      const documents = app.documents || [];
      // Backward compatibility: check if doc_submitted exists and isn't already in documents list
      if (app.student.doc_submitted && documents.length === 0) {
        documents.push({ url: app.student.doc_submitted, name: 'Document' });
      }

      if (documents.length > 0) {
        documents.forEach(doc => {
          const fileExt = doc.url.split('.').pop().toLowerCase();
          const docWrapper = document.createElement('div');
          docWrapper.style.marginBottom = '15px';
          docWrapper.style.border = '1px solid #e2e8f0';
          docWrapper.style.borderRadius = '8px';
          docWrapper.style.padding = '10px';

          const title = document.createElement('p');
          title.textContent = doc.name || 'Document';
          title.style.fontWeight = 'bold';
          title.style.marginBottom = '5px';
          docWrapper.appendChild(title);

          if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExt)) {
            docWrapper.innerHTML += `<img src="${doc.url}" alt="Submitted Document" style="max-width: 100%; max-height: 400px; border-radius: 4px;">`;
          } else if (fileExt === 'pdf') {
            docWrapper.innerHTML += `
                <iframe src="${doc.url}" style="width: 100%; height: 500px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px;"></iframe>
                <a href="${doc.url}" target="_blank" class="btn btn-sm btn-secondary" style="display: inline-block;">Open PDF in New Tab</a>
            `;
          } else if (['doc', 'docx'].includes(fileExt)) {
            docWrapper.innerHTML += `
                <div style="padding: 20px; text-align: center; background: #f8fafc; border-radius: 8px;">
                    <i class="fas fa-file-word" style="font-size: 48px; color: #2b579a; margin-bottom: 15px; display: block;"></i>
                    <p style="margin-bottom: 15px;">Word documents cannot be previewed directly.</p>
                    <a href="${doc.url}" download class="btn btn-sm btn-primary">Download Document</a>
                </div>
             `;
          } else {
            docWrapper.innerHTML += `
                <div style="padding: 20px; text-align: center; background: #f8fafc; border-radius: 8px;">
                    <i class="fas fa-file" style="font-size: 48px; color: #718096; margin-bottom: 15px; display: block;"></i>
                    <p style="margin-bottom: 15px;">Preview not available for this file type.</p>
                    <a href="${doc.url}" download class="btn btn-sm btn-primary">Download File</a>
                </div>
             `;
          }
          docContainer.appendChild(docWrapper);
        });
      } else {
        docContainer.textContent = 'No document submitted';
      }

      document.getElementById('app-modal-motivation').textContent = app.remarks || 'No motivation provided.';

      document.getElementById('application-modal').style.display = 'block';
    }

    function closeApplicationModal() {
      document.getElementById('application-modal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
      const modal = document.getElementById('application-modal');
      const popupModal = document.getElementById('popup-modal');
      if (event.target === modal) {
        closeApplicationModal();
      }
      if (event.target === popupModal) {
        closePopupModal();
      }
    }

    let currentAppId = null;
    let currentAction = null;

    function openRemarksModal(appId, action) {
      currentAppId = appId;
      currentAction = action;

      const modal = document.getElementById('remarks-modal');
      const title = document.getElementById('remarks-modal-title');
      const submitBtn = document.getElementById('remarks-submit-btn');

      if (action === 'approve') {
        title.textContent = 'Approve Application';
        submitBtn.textContent = 'Approve';
        submitBtn.className = 'btn btn-success';
      } else {
        title.textContent = 'Reject Application';
        submitBtn.textContent = 'Reject';
        submitBtn.className = 'btn btn-danger';
      }

      document.getElementById('remarks-hidden-input').value = '';
      if (quill) {
        quill.setText('');
      }
      modal.style.display = 'block';
    }

    var quill;
    document.addEventListener('DOMContentLoaded', function () {
      quill = new Quill('#remarks-editor-container', {
        theme: 'snow',
        placeholder: 'Enter admin remarks here...',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline', 'strike'],
            ['blockquote', 'code-block'],
            [{ 'header': 1 }, { 'header': 2 }],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'script': 'sub' }, { 'script': 'super' }],
            [{ 'indent': '-1' }, { 'indent': '+1' }],
            [{ 'direction': 'rtl' }],
            [{ 'size': ['small', false, 'large', 'huge'] }],
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'font': [] }],
            [{ 'align': [] }],
            ['clean']
          ]
        }
      });
    });

    function closeRemarksModal() {
      document.getElementById('remarks-modal').style.display = 'none';
      currentAppId = null;
      currentAction = null;
    }

    function approveProgramApplication(applicationId) {
      openRemarksModal(applicationId, 'approve');
    }

    function rejectProgramApplication(applicationId) {
      openRemarksModal(applicationId, 'reject');
    }

    document.addEventListener('DOMContentLoaded', function () {
      const remarksForm = document.getElementById('remarks-form');
      if (remarksForm) {
        remarksForm.addEventListener('submit', function (e) {
          e.preventDefault();

          if (!currentAppId || !currentAction) return;

          if (!currentAppId || !currentAction) return;

          // Get HTML content from Quill
          const remarks = quill.root.innerHTML;
          const endpoint = `/api/admin/program-applications/${currentAppId}/${currentAction}/`;

          fetch(endpoint, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ remarks: remarks })
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                closeRemarksModal();
                loadProgramApplications();
              } else {
                alert('Error: ' + data.error);
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('An error occurred.');
            });
        });
      }

      // Close modal when clicking outside
      const remarksModal = document.getElementById('remarks-modal');
      if (remarksModal) {
        window.addEventListener('click', function (event) {
          if (event.target === remarksModal) {
            closeRemarksModal();
          }
        });
      }
    });

    function filterProgramApplications() {
      const filter = document.getElementById('program-application-filter').value;
      const applicationItems = document.querySelectorAll('#program-application-list .application-item');

      applicationItems.forEach(item => {
        if (filter === 'all') {
          item.style.display = 'block';
        } else {
          item.style.display = item.classList.contains(`application-${filter}`) ? 'block' : 'none';
        }
      });
    }

    // Form submission
    document.getElementById('popup-form').addEventListener('submit', function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const popupId = formData.get('popup_id');
      const url = popupId ? `/api/admin/popups/${popupId}/edit/` : '/api/admin/popups/create/';
      const method = popupId ? 'PUT' : 'POST';

      fetch(url, {
        method: method,
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title: formData.get('title'),
          message: formData.get('message'),
          popup_type: formData.get('popup_type'),
          is_active: formData.get('is_active') === 'on',
          expires_at: formData.get('expires_at') || null,
        }),
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            closePopupModal();
            loadPopups();
          } else {
            alert('Error saving popup: ' + data.error);
          }
        });
    });

    function getCsrf() {
      const name = 'csrftoken=';
      const c = document.cookie.split(';').map(s => s.trim()).find(s => s.startsWith(name));
      return c ? decodeURIComponent(c.substring(name.length)) : '';
    }

    async function handleCreateProgram(e) {
      e.preventDefault();
      const form = document.getElementById('createProgramForm');
      const endpoint = form.getAttribute('data-endpoint') || '/accounts/create-program/';
      const msg = document.getElementById('createProgramMsg');

      const fd = new FormData(form);

      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          body: fd,
          headers: { 'X-CSRFToken': getCsrf() },
          credentials: 'same-origin'
        });
        const data = await res.json();
        msg.style.display = 'block';
        if (res.ok && data.success) {
          msg.className = 'app-message success';
          msg.textContent = 'Program created.';
          form.reset();
          // optionally refresh program list via another fetch
        } else {
          msg.className = 'app-message error';
          msg.textContent = data.error || 'Failed to create program.';
        }
      } catch (err) {
        msg.style.display = 'block';
        msg.className = 'app-message error';
        msg.textContent = 'Network error.';
      }
    }

    // Utility function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
      const modal = document.getElementById('popup-modal');
      if (event.target === modal) {
        closePopupModal();
      }
    }

    function toggleProgramForm() {
      const form = document.getElementById('programForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    document.querySelector('.program-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const formData = new FormData(this);

      try {
        const response = await fetch('/home/create_program/', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });

        const data = await response.json();
        if (data.success) {
          alert('Program created successfully!');
          this.reset();
          hideCreateProgram();
          await loadPrograms();
          // Optionally reload programs list
        } else {
          alert(data.error || 'Failed to create program');
        }
      } catch (error) {
        alert('Error creating program');
        console.error(error);
      }
    });

    async function loadPrograms() {
      const container = document.querySelector('.programs-list');
      const endpoints = ['/home/programs/', '/programs/'];
      let data = null;
      for (const url of endpoints) {
        try {
          const res = await fetch(url, { credentials: 'same-origin' });
          console.log('Programs fetch', url, res.status);
          if (!res.ok) continue;
          data = await res.json();
          break;
        } catch (e) {
          console.warn('Programs fetch failed for', url, e);
        }
      }
      container.innerHTML = '';
      if (!data || !data.programs) {
        container.innerHTML = '<p class="no-programs">Unable to load programs.</p>';
        return;
      }

      allPrograms = data.programs; // Store for edit modal access

      if (data.programs.length === 0) {
        container.innerHTML = '<p class="no-programs">No programs found.</p>';
        return;
      }
      data.programs.forEach(p => {
        const el = document.createElement('div');
        el.className = 'program-item';
        // Add background image style if available
        const imageStyle = p.program_image ? `background-image: url('${p.program_image}');` : '';
        const hasImageClass = p.program_image ? 'has-image' : '';

        el.innerHTML = `
          ${p.program_image ? `<div class="program-img-header" style="background-image: url('${p.program_image}');"></div>` : ''}
          <div class="program-content">
            <div class="program-header">
              <h4>${p.program_name}</h4>
              <span class="program-type-badge">${p.program_type || 'Other'}</span>
            </div>
            <div class="program-actions-overlay" style="position: absolute; top: 10px; right: 10px; display: flex; gap: 5px;">
              <button class="btn btn-sm btn-secondary" onclick="openEditProgramModal(${p.program_id})"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-danger" onclick="deleteProgram(${p.program_id})"><i class="fas fa-trash"></i></button>
            </div>
            <div class="program-body">
              <p>${p.requirements || ''}</p>
              ${(p.application_start_date || p.application_end_date) ? `
                  <div class="program-period">
                      <i class="fas fa-calendar-alt"></i> 
                      Application Period: 
                      ${p.application_start_date || 'N/A'} to ${p.application_end_date || 'N/A'}
                  </div>
              ` : ''}
            </div>
          </div>
        `;
        container.appendChild(el);
      });
    }
  </script>

  <!-- Inbox / Support Tab -->
  <div id="inbox" class="tab-content" style="display: none;">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Inbox & Support Tickets</h3>
        <div style="display: flex; gap: 10px;">
          <select id="inbox-filter" onchange="filterAdminMessages()" style="padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; font-family: 'Roboto', sans-serif;">
            <option value="all">All Messages</option>
            <option value="unread">Unread Only</option>
          </select>
          <button class="btn btn-primary" onclick="loadAdminMessages()">Refresh</button>
        </div>
      </div>
      <div class="table-container shadow-sm border border-gray-100 rounded-xl">
        <table>
          <thead>
            <tr style="background-color: #f8fafc;">
              <th style="width: 50px;">Status</th>
              <th>Student</th>
              <th>Subject</th>
              <th>Date</th>
              <th style="text-align: center; width: 120px;">Action</th>
            </tr>
          </thead>
          <tbody id="admin-inbox-list">
            <!-- Messages will be injected here -->
            <tr><td colspan="5" style="text-align: center; color: #64748b; padding: 20px;">Loading messages...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
<!-- End of Main Content -->

<!-- View/Reply Message Modal (Admin) -->
<div id="admin-reply-modal" class="modal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h3 id="admin-reply-subject">Message Subject</h3>
      <span class="close" onclick="closeAdminReplyModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e2e8f0;">
        <div style="width: 48px; height: 48px; border-radius: 50%; background-color: #ebf4ff; color: #3182ce; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem;" id="admin-reply-avatar">
          S
        </div>
        <div>
          <div style="font-weight: bold; color: #2d3748; font-size: 1.1rem;" id="admin-reply-sender">Student Name</div>
          <div style="font-size: 0.85rem; color: #718096;" id="admin-reply-date">Jan 1, 2024</div>
        </div>
      </div>
      <div style="background-color: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <p id="admin-reply-body" style="white-space: pre-wrap; margin: 0; color: #4a5568; line-height: 1.6;"></p>
      </div>
      
      <form id="adminReplyForm" onsubmit="handleAdminReplySubmit(event)">
        <input type="hidden" id="admin-reply-student-id">
        <div class="form-group" style="margin-bottom: 15px;">
          <label for="admin-reply-text" style="font-weight: 600; margin-bottom: 8px; display: block; color: #4a5568;">Your Reply</label>
          <textarea id="admin-reply-text" name="body" required rows="4" style="width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 8px; font-family: 'Roboto', sans-serif;" placeholder="Type your response here..."></textarea>
        </div>
        <div id="admin-reply-msg" style="display: none; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center;"></div>
        <div class="modal-actions" style="display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" class="btn" style="background-color: #e2e8f0; color: #4a5568;" onclick="closeAdminReplyModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="adminReplyBtn">Send Reply</button>
        </div>
      </form>
    </div>
  </div>
</div>

  <!-- Popup Modal -->
  <div id="popup-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Create New Popup</h3>
        <span class="close" onclick="closePopupModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="popup-form">
          <input type="hidden" name="popup_id" id="popup_id">

          <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" required>
          </div>

          <div class="form-group">
            <label for="message">Message</label>
            <textarea id="message" name="message" required></textarea>
          </div>

          <div class="form-group">
            <label for="popup_type">Type</label>
            <select id="popup_type" name="popup_type">
              <option value="info">Information</option>
              <option value="warning">Warning</option>
              <option value="success">Success</option>
              <option value="error">Error</option>
            </select>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="is_active" name="is_active" checked>
              Active
            </label>
          </div>

          <div class="form-group">
            <label for="expires_at">Expires At (Optional)</label>
            <input type="datetime-local" id="expires_at" name="expires_at">
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closePopupModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Popup</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Popup Management Functions
    function loadPopups() {
      const filter = document.getElementById('popup-filter') ? document.getElementById('popup-filter').value : 'all';

      fetch('/api/admin/popups/', { credentials: 'same-origin' })
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById('popup-list');
          if (!list) return;

          if (!data.popups || data.popups.length === 0) {
            list.innerHTML = '<p class="no-data">No notifications found.</p>';
            return;
          }

          list.innerHTML = '';
          const filtered = data.popups.filter(p => {
            if (filter === 'all') return true;
            if (filter === 'active') return p.is_active;
            if (filter === 'inactive') return !p.is_active;
            return p.popup_type === filter;
          });

          if (filtered.length === 0) {
            list.innerHTML = '<p class="no-data">No matching notifications.</p>';
            return;
          }

          filtered.forEach(p => {
            const el = document.createElement('div');
            el.className = `popup-item ${p.popup_type} ${p.is_active ? 'active' : 'inactive'}`;
            el.innerHTML = `
              <div class="popup-content">
                <div class="popup-header-row">
                  <span class="popup-type-badge ${p.popup_type}">${p.popup_type}</span>
                  <span class="popup-status ${p.is_active ? 'active' : 'inactive'}">
                    ${p.is_active ? 'Active' : 'Inactive'}
                  </span>
                </div>
                <h4>${p.title}</h4>
                <p>${p.message}</p>
                <small>Created: ${new Date(p.created_at).toLocaleDateString()}</small>
              </div>
              <div class="popup-actions">
                <button class="btn btn-sm btn-outline" onclick="togglePopup(${p.id})">
                  ${p.is_active ? 'Deactivate' : 'Activate'}
                </button>
                <button class="btn btn-sm btn-danger" onclick="deletePopup(${p.id})">Delete</button>
              </div>
            `;
            list.appendChild(el);
          });

          // Update dashboard stat if exists
          const statEl = document.getElementById('active-popups');
          if (statEl) {
            const activeCount = data.popups.filter(p => p.is_active).length;
            statEl.textContent = activeCount;
          }
        })
        .catch(err => console.error('Error loading popups:', err));
    }

    function openPopupModal() {
      const modal = document.getElementById('popup-modal');
      const form = document.getElementById('popup-form');
      if (modal && form) {
        form.reset();
        document.getElementById('popup_id').value = '';
        document.getElementById('modal-title').textContent = 'Create New Popup';
        modal.style.display = 'flex';
      }
    }

    function closePopupModal() {
      const modal = document.getElementById('popup-modal');
      if (modal) modal.style.display = 'none';
    }

    function togglePopup(id) {
      if (!confirm('Toggle this notification status?')) return;
      fetch(`/api/admin/popups/${id}/toggle/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            loadPopups();
          } else {
            alert('Error: ' + data.error);
          }
        });
    }

    function deletePopup(id) {
      if (!confirm('Are you sure you want to delete this notification?')) return;
      fetch(`/api/admin/popups/${id}/delete/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            loadPopups();
          } else {
            alert('Error: ' + data.error);
          }
        });
    }

    function filterPopups() {
      loadPopups();
    }

    let currentStudents = [];

    function loadStudents() {
      console.log('Loading students...');
      fetch('/api/admin/student-applications/', { // Reusing this endpoint as it returns all students
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
      })
        .then(response => response.json())
        .then(data => {
          const list = document.getElementById('student-list');
          if (!list) return;

          list.innerHTML = '';

          if (!data.applications || data.applications.length === 0) {
            list.innerHTML = '<p class="no-data">No students found.</p>';
            return;
          }

          currentStudents = data.applications;

          data.applications.forEach(student => {
            const el = createStudentElement(student);
            list.appendChild(el);
          });
        })
        .catch(err => console.error('Error loading students:', err));
    }

    function createStudentElement(student) {
      const div = document.createElement('div');
      div.className = `student-item student-${student.status}`;
      // Add data attributes for filtering
      div.dataset.name = (student.first_name + ' ' + student.last_name + ' ' + student.username).toLowerCase();
      div.dataset.status = student.status;

      const isActive = student.status === 'active';
      const isInactive = student.status === 'inactive';

      div.innerHTML = `
        <div class="student-header">
            <div class="student-info">
                <h4>${student.first_name} ${student.last_name}</h4> 
                <span class="student-username">(@${student.username})</span>
            </div>
            <span class="status-badge status-${student.status}">${student.status}</span>
        </div>
        <div class="student-body">
            <div class="student-details-grid">
                <div class="detail-item">
                    <span class="label">Program:</span>
                    <span class="value">${student.program_and_yr}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Email:</span>
                    <span class="value">${student.email}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Contact:</span>
                    <span class="value">${student.contact_num}</span>
                </div>
            </div>
            
            <div class="student-actions">
                <button class="btn btn-sm btn-info" onclick='openEditStudentModal(${student.id})'>
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-sm ${isActive ? 'btn-warning' : 'btn-success'}" 
                        onclick="toggleStudentStatus(${student.id}, '${student.status}')">
                    ${isActive ? 'Deactivate' : 'Activate'}
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteStudent(${student.id})">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
      `;
      return div;
    }

    // Inbox & Ticketing System Functions
    let adminMessages = [];

    async function loadAdminMessages() {
      const filter = document.getElementById('inbox-filter').value;
      const list = document.getElementById('admin-inbox-list');
      list.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #64748b; padding: 20px;">Loading messages...</td></tr>';
      
      try {
        const res = await fetch('/api/messages/');
        const data = await res.json();
        
        if (res.ok && data.success) {
          adminMessages = data.messages;
          let filteredMessages = adminMessages;
          
          if (filter === 'unread') {
            filteredMessages = adminMessages.filter(m => !m.is_read && m.sender_type === 'student');
          }

          // Update Badge
          const unreadCount = adminMessages.filter(m => !m.is_read && m.sender_type === 'student').length;
          updateBadge('badge-inbox', unreadCount);

          if (filteredMessages.length === 0) {
            list.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #64748b; padding: 20px;">No messages found.</td></tr>';
            return;
          }

          list.innerHTML = '';
          filteredMessages.forEach(msg => {
            const dateStr = new Date(msg.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const isUnread = !msg.is_read && msg.sender_type === 'student';
            const statusBadge = isUnread 
              ? `<span style="background: #fee2e2; color: #b91c1c; padding: 4px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: bold;">New</span>`
              : `<span style="background: #f1f5f9; color: #64748b; padding: 4px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: bold;">Read</span>`;
            
            const tr = document.createElement('tr');
            tr.style.cursor = 'pointer';
            tr.style.borderBottom = '1px solid #f1f5f9';
            tr.onmouseover = () => tr.style.backgroundColor = '#f8fafc';
            tr.onmouseout = () => tr.style.backgroundColor = 'transparent';
            
            // Note: student_name is used here, but they are all technically "sender" or "target" based on type
            const studentNameDisplay = msg.sender_type === 'student' ? msg.sender_name : msg.target_student_name;
            const directionIcon = msg.sender_type === 'admin' 
              ? '<i class="fas fa-reply" style="color: #64748b; margin-right: 5px;" title="Replied"></i>' 
              : '';

            tr.innerHTML = `
              <td style="padding: 15px;">${statusBadge}</td>
              <td style="padding: 15px; font-weight: ${isUnread ? 'bold' : 'normal'}; color: #334155;">${directionIcon}${studentNameDisplay}</td>
              <td style="padding: 15px; font-weight: ${isUnread ? 'bold' : 'normal'}; color: #334155;">${msg.subject}</td>
              <td style="padding: 15px; color: #64748b; font-size: 0.9em;">${dateStr}</td>
              <td style="padding: 15px; text-align: center;">
                <button class="btn btn-sm btn-secondary" onclick="openAdminReplyModal(${msg.id})">
                  <i class="fas fa-eye"></i> View
                </button>
              </td>
            `;
            list.appendChild(tr);
          });
        }
      } catch (err) {
        console.error('Error loading admin messages:', err);
        list.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #ef4444; padding: 20px;">Error loading messages</td></tr>';
      }
    }

    function filterAdminMessages() {
      loadAdminMessages();
    }

    function openAdminReplyModal(msgId) {
      const msg = adminMessages.find(m => m.id === msgId);
      if (!msg) return;

      const studentName = msg.sender_type === 'student' ? msg.sender_name : msg.target_student_name;
      
      document.getElementById('admin-reply-subject').textContent = msg.subject;
      document.getElementById('admin-reply-sender').textContent = studentName;
      document.getElementById('admin-reply-avatar').textContent = studentName.charAt(0).toUpperCase();
      document.getElementById('admin-reply-date').textContent = new Date(msg.created_at).toLocaleString();
      document.getElementById('admin-reply-body').textContent = msg.body;
      document.getElementById('admin-reply-student-id').value = msg.target_student_id;
      
      document.getElementById('admin-reply-msg').style.display = 'none';
      document.getElementById('admin-reply-text').value = '';

      document.getElementById('admin-reply-modal').style.display = 'flex';

      // Mark as read if it is unread and from a student
      if (!msg.is_read && msg.sender_type === 'student') {
        fetch(`/api/messages/${msgId}/read/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken') },
          credentials: 'same-origin'
        }).then(res => {
          if (res.ok) {
            msg.is_read = true; // Updates local state
            loadAdminMessages(); // Reload inbox styles so badge disappears
          }
        }).catch(err => console.error(err));
      }
    }

    function closeAdminReplyModal() {
      document.getElementById('admin-reply-modal').style.display = 'none';
    }

    async function handleAdminReplySubmit(e) {
      e.preventDefault();
      
      const msgAlert = document.getElementById('admin-reply-msg');
      const submitBtn = document.getElementById('adminReplyBtn');
      msgAlert.style.display = 'none';
      
      const studentId = document.getElementById('admin-reply-student-id').value;
      const originalSubject = document.getElementById('admin-reply-subject').textContent;
      const subject = originalSubject.startsWith('Re: ') ? originalSubject : 'Re: ' + originalSubject;
      const body = document.getElementById('admin-reply-text').value;

      submitBtn.disabled = true;
      submitBtn.innerText = 'Sending...';

      try {
        const res = await fetch('/api/messages/send/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ subject, body, student_id: studentId }),
          credentials: 'same-origin'
        });
        const data = await res.json();
        
        if (res.ok && data.success) {
          msgAlert.textContent = 'Reply sent successfully!';
          msgAlert.style.display = 'block';
          msgAlert.style.backgroundColor = '#d1fae5';
          msgAlert.style.color = '#065f46';
          msgAlert.style.border = '1px solid #34d399';
          
          setTimeout(() => {
            closeAdminReplyModal();
            loadAdminMessages(); // Refresh inbox list
          }, 1500);
        } else {
          msgAlert.textContent = data.error || 'Failed to send reply.';
          msgAlert.style.display = 'block';
          msgAlert.style.backgroundColor = '#fee2e2';
          msgAlert.style.color = '#b91c1c';
          msgAlert.style.border = '1px solid #f87171';
        }
      } catch (err) {
        msgAlert.textContent = 'Network error during reply submission.';
        msgAlert.style.display = 'block';
        msgAlert.style.backgroundColor = '#fee2e2';
        msgAlert.style.color = '#b91c1c';
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerText = 'Send Reply';
      }
    }

    // Hook tab switches to also load inbox if needed
    // Add initialization to existing DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      // Setup tabs
      document.querySelectorAll('.nav-link, .nav-item').forEach(link => {
        link.addEventListener('click', function(e) {
          // Check if this is exactly the inbox tab getting clicked
          if (this.dataset.tab === 'inbox') {
             loadAdminMessages();
          }
        });
      });
      // Initial load
      setTimeout(() => loadAdminMessages(), 1000); 
    });

    function toggleStudentStatus(studentId, currentStatus) {
      const action = currentStatus === 'active' ? 'deactivate' : 'activate';
      if (!confirm(`Are you sure you want to ${action} this student?`)) return;

      fetch(`/api/admin/students/${studentId}/toggle/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Reload list to update UI
            loadStudents();
            // Optionally update stats
            loadDashboardStats();
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(err => {
          console.error('Error toggling student status:', err);
          alert('An error occurred.');
        });
    }

    function deleteStudent(studentId) {
      if (!confirm('Are you sure you want to delete this student? This action cannot be undone and will delete all associated applications and documents.')) return;

      fetch(`/api/admin/students/${studentId}/delete/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert(data.message);
            loadStudents();
            loadDashboardStats();
          } else {
            alert('Error deleting student: ' + data.error);
          }
        })
        .catch(err => {
          console.error('Error deleting student:', err);
          alert('An error occurred while deleting the student.');
        });
    }

    function openEditStudentModal(studentId) {
      const student = currentStudents.find(s => s.id === studentId);
      if (!student) return;

      document.getElementById('edit_student_id').value = student.id;
      document.getElementById('edit_student_first_name').value = student.first_name;
      document.getElementById('edit_student_last_name').value = student.last_name;
      document.getElementById('edit_student_username').value = student.username;
      document.getElementById('edit_student_email').value = student.email;
      document.getElementById('edit_student_contact').value = student.contact_num;
      document.getElementById('edit_student_address').value = student.address;
      document.getElementById('edit_student_program').value = student.program_and_yr;

      // Handle status select if you want to allow status changes via edit:
      const statusSelect = document.getElementById('edit_student_status');
      if (statusSelect) statusSelect.value = student.status;

      document.getElementById('edit-student-modal').style.display = 'block';
    }

    function closeEditStudentModal() {
      document.getElementById('edit-student-modal').style.display = 'none';
    }

    // Edit Student Form Handler
    document.addEventListener('DOMContentLoaded', () => {
      const editStudentForm = document.getElementById('edit-student-form');
      if (editStudentForm) {
        editStudentForm.addEventListener('submit', function (e) {
          e.preventDefault();

          const studentId = document.getElementById('edit_student_id').value;
          const formData = new FormData(this);

          // Convert FormData to JSON object
          const data = {};
          formData.forEach((value, key) => data[key] = value);

          fetch(`/api/admin/students/${studentId}/edit/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data),
            credentials: 'same-origin'
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                alert(data.message);
                closeEditStudentModal();
                loadStudents();
              } else {
                alert('Error updating student: ' + data.error);
              }
            })
            .catch(err => {
              console.error('Error updating student:', err);
              alert('An error occurred while updating the student.');
            });
        });
      }
    });

    function filterStudents() {
      const searchText = document.getElementById('student-search').value.toLowerCase();
      const statusFilter = document.getElementById('student-status-filter').value;
      const items = document.querySelectorAll('.student-item');

      items.forEach(item => {
        const nameMatch = item.dataset.name.includes(searchText);
        const statusMatch = statusFilter === 'all' || item.dataset.status === statusFilter;

        if (nameMatch && statusMatch) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    }
  </script>
  <footer
    style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #e0e0e0; color: #666; font-size: 14px;">
     2024 Lander. All rights reserved.
  </footer>



  <!-- Application Details Modal -->
  <div id="application-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="app-modal-title">Application Details</h3>
        <span class="close" onclick="closeApplicationModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="app-detail-grid">
          <div class="detail-row">
            <span class="detail-label">Student</span>
            <span class="detail-value" id="app-modal-student"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Program</span>
            <span class="detail-value" id="app-modal-program"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Status</span>
            <span class="detail-value" id="app-modal-status"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Email</span>
            <span class="detail-value" id="app-modal-email"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Applied On</span>
            <span class="detail-value" id="app-modal-date"></span>
          </div>
        </div>

        <div style="margin-bottom: 25px;">
          <h4 class="modal-section-title">Documents</h4>
          <div id="app-modal-document"></div>
        </div>

        <div>
          <h4 class="modal-section-title">Motivation / Remarks</h4>
          <div class="motivation-box" id="app-modal-motivation"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeApplicationModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Remarks Modal -->
  <div id="remarks-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="remarks-modal-title">Application Remarks</h3>
        <span class="close" onclick="closeRemarksModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="remarks-form">
          <div class="form-group">
            <label for="remarks-editor" style="font-weight: bold; margin-bottom: 8px; display: block;">Remarks /
              Comments</label>
            <div id="remarks-editor-container" style="background: white;"></div>
            <input type="hidden" name="remarks" id="remarks-hidden-input">
          </div>
          <div class="modal-footer" style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
            <button type="button" class="btn btn-secondary" onclick="closeRemarksModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" id="remarks-submit-btn">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // ... (previous scripts) ...

    function viewApplication(appId) {
      const app = currentApplications.find(a => a.app_id === appId);
      if (!app) return;

      document.getElementById('app-modal-student').textContent = `${app.student.first_name} ${app.student.last_name} (@${app.student.username})`;
      document.getElementById('app-modal-program').textContent = app.program.program_name;
      document.getElementById('app-modal-status').textContent = app.requirement_status;
      document.getElementById('app-modal-email').textContent = app.student.email;
      document.getElementById('app-modal-date').textContent = app.created_at ? new Date(app.created_at).toLocaleString() : 'N/A';

      // Colorize status
      const statusEl = document.getElementById('app-modal-status');
      statusEl.className = `detail-value status-badge status-${app.requirement_status}`;
      statusEl.style.display = 'inline-block';

      const docContainer = document.getElementById('app-modal-document');
      docContainer.innerHTML = ''; // Clear previous content

      const documents = app.documents || [];
      // Backward compatibility: check if doc_submitted exists and isn't already in documents list
      if (app.student.doc_submitted && documents.length === 0) {
        documents.push({ url: app.student.doc_submitted, name: 'Document' });
      }

      if (documents.length > 0) {
        documents.forEach(doc => {
          const fileExt = doc.url.split('.').pop().toLowerCase();
          const docWrapper = document.createElement('div');
          docWrapper.className = 'document-wrapper';

          const title = document.createElement('div');
          title.className = 'document-title';
          title.textContent = doc.name || 'Document';
          docWrapper.appendChild(title);

          if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExt)) {
            docWrapper.innerHTML += `<img src="${doc.url}" alt="Submitted Document" class="document-preview-img">`;
          } else if (fileExt === 'pdf') {
            docWrapper.innerHTML += `
                <iframe src="${doc.url}" class="document-preview-frame"></iframe>
                <div style="text-align: right;">
                  <a href="${doc.url}" target="_blank" class="btn btn-sm btn-secondary"><i class="fas fa-external-link-alt"></i> Open PDF in New Tab</a>
                </div>
            `;
          } else if (['doc', 'docx'].includes(fileExt)) {
            docWrapper.innerHTML += `
                <div class="document-fallback">
                    <i class="fas fa-file-word"></i>
                    <p>Word documents cannot be previewed directly.</p>
                    <a href="${doc.url}" download class="btn btn-sm btn-primary"><i class="fas fa-download"></i> Download Document</a>
                </div>
             `;
          } else {
            docWrapper.innerHTML += `
                <div class="document-fallback">
                    <i class="fas fa-file"></i>
                    <p>Preview not available for this file type.</p>
                    <a href="${doc.url}" download class="btn btn-sm btn-primary"><i class="fas fa-download"></i> Download File</a>
                </div>
             `;
          }
          docContainer.appendChild(docWrapper);
        });
      } else {
        docContainer.innerHTML = '<p class="text-muted" style="padding: 10px; font-style: italic;">No document submitted</p>';
      }

      const motivationEl = document.getElementById('app-modal-motivation');
      motivationEl.innerHTML = app.remarks || 'No motivation provided.';

      document.getElementById('application-modal').style.display = 'block';
    }
  </script>
  <!-- Edit Program Modal -->
  <div id="edit-program-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="edit-program-title">Edit Program</h3>
        <span class="close" onclick="closeEditProgramModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="edit-program-form">
          <input type="hidden" name="program_id" id="edit_program_id">

          <div class="form-group">
            <label for="edit_program_name">Program Name</label>
            <input type="text" id="edit_program_name" name="program_name" required>
          </div>

          <div class="form-group">
            <label for="edit_program_type">Program Type</label>
            <select id="edit_program_type" name="program_type" required>
              <option value="Financial Assistance">Financial Assistance</option>
              <option value="Scholarship">Scholarship</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="edit_requirements">Requirements</label>
            <textarea id="edit_requirements" name="requirements" rows="4"></textarea>
          </div>

          <div class="form-group">
            <label>Application Period</label>
            <div style="display: flex; gap: 10px;">
              <div style="flex: 1;">
                <label for="edit_application_start_date" style="font-size: 0.9em;">Start Date</label>
                <input id="edit_application_start_date" name="application_start_date" type="date">
              </div>
              <div style="flex: 1;">
                <label for="edit_application_end_date" style="font-size: 0.9em;">End Date</label>
                <input id="edit_application_end_date" name="application_end_date" type="date">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="edit_program_image">Background Image (Leave empty to keep current)</label>
            <input type="file" id="edit_program_image" name="program_image" accept="image/*">
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditProgramModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    let allPrograms = []; // Store fetched programs locally

    // ... (previous scripts) ...

    function openEditProgramModal(programId) {
      const program = allPrograms.find(p => p.program_id === programId);
      if (!program) return;

      document.getElementById('edit_program_id').value = program.program_id;
      document.getElementById('edit_program_name').value = program.program_name;
      document.getElementById('edit_program_type').value = program.program_type || 'Other';
      document.getElementById('edit_requirements').value = program.requirements;
      document.getElementById('edit_application_start_date').value = program.application_start_date || '';
      document.getElementById('edit_application_end_date').value = program.application_end_date || '';

      document.getElementById('edit-program-modal').style.display = 'flex';
    }

    function closeEditProgramModal() {
      document.getElementById('edit-program-modal').style.display = 'none';
      document.getElementById('edit-program-form').reset();
    }

    document.getElementById('edit-program-form').addEventListener('submit', function (e) {
      e.preventDefault();
      const programId = document.getElementById('edit_program_id').value;
      const formData = new FormData(this);

      fetch(`/home/edit_program/${programId}/`, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Program updated successfully');
            closeEditProgramModal();
            loadPrograms();
          } else {
            alert('Error updating program: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while updating the program.');
        });
    });

    function deleteProgram(programId) {
      if (!confirm('Are you sure you want to delete this program? This cannot be undone.')) return;

      fetch(`/home/delete_program/${programId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Program deleted successfully');
            loadPrograms();
          } else {
            alert('Error deleting program: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while deleting the program.');
        });
    }
  </script>
  <!-- Edit Student Modal -->
  <div id="edit-student-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="edit-student-title">Edit Student</h3>
        <span class="close" onclick="closeEditStudentModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="edit-student-form">
          <input type="hidden" name="student_id" id="edit_student_id">

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="edit_student_first_name">First Name</label>
              <input type="text" id="edit_student_first_name" name="first_name" required>
            </div>
            <div class="form-group">
              <label for="edit_student_last_name">Last Name</label>
              <input type="text" id="edit_student_last_name" name="last_name" required>
            </div>
          </div>

          <div class="form-group">
            <label for="edit_student_username">Username</label>
            <input type="text" id="edit_student_username" name="username" required>
          </div>

          <div class="form-group">
            <label for="edit_student_email">Email</label>
            <input type="email" id="edit_student_email" name="email" required>
          </div>

          <div class="form-group">
            <label for="edit_student_program">Program & Year</label>
            <input type="text" id="edit_student_program" name="program_and_yr" required>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="edit_student_contact">Contact Number</label>
              <input type="text" id="edit_student_contact" name="contact_num" required>
            </div>
            <div class="form-group">
              <label for="edit_student_status">Status</label>
              <select id="edit_student_status" name="status">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="pending">Pending</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="edit_student_address">Address</label>
            <textarea id="edit_student_address" name="address" rows="2" required></textarea>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditStudentModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</body>

</html>