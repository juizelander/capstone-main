{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lemon+Milk:wght@300;400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<link rel="stylesheet" href="{% static 'accounts/admin_dashboard.css' %}">
<body>
  <header>
    <h1>ScholarSync Subic</h1>
    <p class="welcome-text">Welcome, {{ admin.admin_name }}!</p>
  </header>

  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <nav>
        <a href="#" class="nav-link active" data-tab="dashboard">Dashboard</a>
        <a href="#" class="nav-link" data-tab="student-registrations">Student Account Registration</a>
        <a href="#" class="nav-link" data-tab="student-applications">Student Applications</a>
        <a href="#" class="nav-link" data-tab="notifications">Notification Center</a>
        <a href="#" class="nav-link" data-tab="students">Students</a>
        <a href="#" class="nav-link" data-tab="settings">Settings</a>
        <a href="#" class="nav-item" data-tab="programs">
          <i class="fas fa-graduation-cap"></i>
          Programs
        </a>
      </nav>
      <a href="{% url 'accounts:logout' %}" class="logout-btn">Logout</a>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Dashboard Tab -->
      <div id="dashboard" class="tab-content active">
        <div class="card">
          <h3>Dashboard Overview</h3>
          <p>Welcome to your admin dashboard. Use the sidebar to navigate between different sections.</p>
        </div>
        
        <!-- Statistics Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
              <h4>Total Students</h4>
              <span class="stat-number" id="total-students">Loading...</span>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-bell"></i>
            </div>
            <div class="stat-content">
              <h4>Active Popups</h4>
              <span class="stat-number" id="active-popups">Loading...</span>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
              <h4>Pending Applications</h4>
              <span class="stat-number" id="pending-applications">Loading...</span>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-graduation-cap"></i>
            </div>
            <div class="stat-content">
              <h4>Total Programs</h4>
              <span class="stat-number" id="total-programs">Loading...</span>
            </div>
          </div>
        </div>

        <!-- Chart Section -->
        <div class="card chart-card">
          <div class="card-header">
            <h3>Application Trends</h3>
            <div class="chart-controls">
              <select id="chart-period" onchange="updateChart()">
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 90 Days</option>
              </select>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="applicationsChart" width="400" height="200"></canvas>
          </div>
        </div>

        <!-- Student Statistics Bar Chart -->
        <div class="card chart-card">
          <div class="card-header">
            <h3>Student Statistics</h3>
            <div class="chart-controls">
              <select id="student-chart-type" onchange="updateStudentChart()">
                <option value="status" selected>By Status</option>
                <option value="program">By Program</option>
                <option value="monthly">Monthly Registrations</option>
              </select>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="studentChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Student Account Registration Tab -->
      <div id="student-registrations" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>Student Account Registration</h3>
            <div class="application-filters">
              <select id="registration-filter" onchange="filterRegistrations()">
                <option value="all">All Registrations</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
          </div>
          
          <div class="application-list" id="registration-list">
            <!-- Student registrations will be loaded here via JavaScript -->
          </div>
        </div>
      </div>

      <!-- Student Applications Tab -->
      <div id="student-applications" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>Student Program Applications</h3>
            <div class="application-filters">
              <select id="program-application-filter" onchange="filterProgramApplications()">
                <option value="all">All Applications</option>
                <option value="submitted">Submitted</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
          </div>
          
          <div class="application-list" id="program-application-list">
            <!-- Program applications will be loaded here via JavaScript -->
          </div>
        </div>
      </div>

      <!-- Notification Center Tab -->
      <div id="notifications" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>Notification Center</h3>
            <button class="btn btn-primary" onclick="openPopupModal()">Create New Popup</button>
          </div>
          
          <div class="popup-filters">
            <select id="popup-filter" onchange="filterPopups()">
              <option value="all">All Popups</option>
              <option value="active">Active Only</option>
              <option value="inactive">Inactive Only</option>
              <option value="info">Information</option>
              <option value="warning">Warning</option>
              <option value="success">Success</option>
              <option value="error">Error</option>
            </select>
          </div>

          <div class="popup-list" id="popup-list">
            <!-- Popups will be loaded here via JavaScript -->
          </div>
        </div>
      </div>

      <!-- Students Tab -->
      <div id="students" class="tab-content">
        <div class="card">
          <h3>Student Management</h3>
          <p>Student management features will be implemented here.</p>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="settings" class="tab-content">
        <div class="card">
          <h3>Settings</h3>
          <p>Admin settings and preferences will be implemented here.</p>
        </div>
      </div>

      <!-- Programs Tab Content -->
<div id="programs" class="tab-content">
  <div class="card">
    <h3>Program Management</h3>

    <div class="program-actions">
      <button class="btn btn-primary" onclick="showCreateProgram()">
        Create New Program
      </button>
    </div>

    <div id="createProgramForm" class="program-form-wrapper">
     <form class="program-form" method="POST">
    {% csrf_token %}
    <label for="p_name">Program Name</label>
    <input id="p_name" name="program_name" type="text" required>

    <label for="p_req">Requirements</label>
    <textarea id="p_req" name="requirements" rows="3"></textarea>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Create Program</button>
    </div>
</form>


    </div>

    <div class="programs-list">
      <!-- Programs will load here -->
    </div>
  </div>
</div>

    </div>
  </div>

  <!-- Popup Modal -->
  <div id="popup-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Create New Popup</h3>
        <span class="close" onclick="closePopupModal()">&times;</span>
      </div>
      <form id="popup-form">
        <input type="hidden" id="popup-id" name="popup_id">
        <div class="form-group">
          <label for="popup-title">Title:</label>
          <input type="text" id="popup-title" name="title" required>
        </div>
        <div class="form-group">
          <label for="popup-message">Message:</label>
          <textarea id="popup-message" name="message" rows="4" required></textarea>
        </div>
        <div class="form-group">
          <label for="popup-type">Type:</label>
          <select id="popup-type" name="popup_type">
            <option value="info">Information</option>
            <option value="warning">Warning</option>
            <option value="success">Success</option>
            <option value="error">Error</option>
          </select>
        </div>
        <div class="form-group">
          <label for="popup-expires">Expires At (optional):</label>
          <input type="datetime-local" id="popup-expires" name="expires_at">
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="popup-active" name="is_active" checked>
            Active
          </label>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closePopupModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Popup</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Tab switching functionality
    document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.nav-link, .nav-item');
    const contents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Remove active class from all tabs
            tabs.forEach(t => t.classList.remove('active'));
            
            // Hide all content sections
            contents.forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab
            tab.classList.add('active');
            
            // Show corresponding content
            const targetId = tab.getAttribute('data-tab');
            document.getElementById(targetId)?.classList.add('active');

            // Lazy-load data when tab is opened
            if (targetId === 'student-registrations') {
              loadStudentRegistrations();
            } else if (targetId === 'student-applications') {
              loadProgramApplications();
            } else if (targetId === 'notifications') {
              loadPopups();
            } else if (targetId === 'dashboard') {
              loadDashboardStats();
            } else if (targetId === 'programs') {
              loadPrograms();
            }
        });
    });

    // Initial loads
    loadDashboardStats();
    initChart();
    initStudentChart();
    // Preload student registrations so it's ready when tab opens
    loadStudentRegistrations();
});

    // Program form toggle functions
function showCreateProgram() {
    document.getElementById('createProgramForm').style.display = 'block';
}

function hideCreateProgram() {
    document.getElementById('createProgramForm').style.display = 'none';
}
    // Popup management functions
    function loadPopups() {
      fetch('/admin/popups/')
        .then(response => response.json())
        .then(data => {
          const popupList = document.getElementById('popup-list');
          popupList.innerHTML = '';
          
          if (data.popups.length === 0) {
            popupList.innerHTML = '<p class="no-popups">No popups found.</p>';
            return;
          }
          
          data.popups.forEach(popup => {
            const popupElement = createPopupElement(popup);
            popupList.appendChild(popupElement);
          });
        })
        .catch(error => {
          console.error('Error loading popups:', error);
          document.getElementById('popup-list').innerHTML = '<p class="error">Error loading popups.</p>';
        });
    }

    function createPopupElement(popup) {
      const div = document.createElement('div');
      div.className = `popup-item popup-${popup.popup_type} ${popup.is_active ? 'active' : 'inactive'}`;
      div.innerHTML = `
        <div class="popup-header">
          <h4>${popup.title}</h4>
          <div class="popup-actions">
            <button class="btn btn-sm btn-secondary" onclick="editPopup(${popup.id})">Edit</button>
            <button class="btn btn-sm ${popup.is_active ? 'btn-warning' : 'btn-success'}" onclick="togglePopup(${popup.id})">
              ${popup.is_active ? 'Deactivate' : 'Activate'}
            </button>
            <button class="btn btn-sm btn-danger" onclick="deletePopup(${popup.id})">Delete</button>
          </div>
        </div>
        <div class="popup-content">
          <p>${popup.message}</p>
          <div class="popup-meta">
            <span class="popup-type">${popup.popup_type}</span>
            <span class="popup-date">Created: ${new Date(popup.created_at).toLocaleDateString()}</span>
            ${popup.expires_at ? `<span class="popup-expires">Expires: ${new Date(popup.expires_at).toLocaleDateString()}</span>` : ''}
          </div>
        </div>
      `;
      return div;
    }

    function openPopupModal(popupId = null) {
      const modal = document.getElementById('popup-modal');
      const form = document.getElementById('popup-form');
      const title = document.getElementById('modal-title');
      
      if (popupId) {
        title.textContent = 'Edit Popup';
        // Load popup data for editing
        fetch(`/api/admin/popups/${popupId}/`)
          .then(response => response.json())
          .then(data => {
            document.getElementById('popup-id').value = data.id;
            document.getElementById('popup-title').value = data.title;
            document.getElementById('popup-message').value = data.message;
            document.getElementById('popup-type').value = data.popup_type;
            document.getElementById('popup-active').checked = data.is_active;
            if (data.expires_at) {
              document.getElementById('popup-expires').value = new Date(data.expires_at).toISOString().slice(0, 16);
            }
          });
      } else {
        title.textContent = 'Create New Popup';
        form.reset();
        document.getElementById('popup-id').value = '';
      }
      
      modal.style.display = 'block';
    }

    function closePopupModal() {
      document.getElementById('popup-modal').style.display = 'none';
    }

    function editPopup(popupId) {
      openPopupModal(popupId);
    }

    function togglePopup(popupId) {
      fetch(`/api/admin/popups/${popupId}/toggle/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          loadPopups();
        } else {
          alert('Error toggling popup: ' + data.error);
        }
      });
    }

    function deletePopup(popupId) {
      if (confirm('Are you sure you want to delete this popup?')) {
        fetch(`/api/admin/popups/${popupId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            loadPopups();
          } else {
            alert('Error deleting popup: ' + data.error);
          }
        });
      }
    }

    function filterPopups() {
      const filter = document.getElementById('popup-filter').value;
      const popupItems = document.querySelectorAll('.popup-item');
      
      popupItems.forEach(item => {
        if (filter === 'all') {
          item.style.display = 'block';
        } else if (filter === 'active') {
          item.style.display = item.classList.contains('active') ? 'block' : 'none';
        } else if (filter === 'inactive') {
          item.style.display = item.classList.contains('inactive') ? 'block' : 'none';
        } else {
          item.style.display = item.classList.contains(`popup-${filter}`) ? 'block' : 'none';
        }
      });
    }

    function loadDashboardStats() {
      console.log('Loading dashboard stats...');
      fetch('/api/admin/stats/', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
      })
        .then(response => {
          console.log('Stats response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Stats data:', data);
          document.getElementById('total-students').textContent = data.total_students || 0;
          document.getElementById('active-popups').textContent = data.active_popups || 0;
          document.getElementById('pending-applications').textContent = data.pending_applications || 0;
          document.getElementById('total-programs').textContent = data.total_programs || 0;
        })
        .catch(error => {
          console.error('Error loading stats:', error);
        });
    }

    // Chart functionality
    let applicationsChart = null;
    let studentChart = null;

    function initChart() {
      const ctx = document.getElementById('applicationsChart').getContext('2d');
      
      // Generate sample data for the last 30 days
      const labels = [];
      const data = [];
      const today = new Date();
      
      for (let i = 29; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        // Generate random data for demo (replace with real data)
        data.push(Math.floor(Math.random() * 10) + 1);
      }

      applicationsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Applications',
            data: data,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#667eea',
            pointBorderColor: '#764ba2',
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                stepSize: 1
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          elements: {
            point: {
              hoverBackgroundColor: '#764ba2'
            }
          }
        }
      });
    }

    function updateChart() {
      const period = document.getElementById('chart-period').value;
      const days = parseInt(period);
      
      // Generate new labels and data based on selected period
      const labels = [];
      const data = [];
      const today = new Date();
      
      for (let i = days - 1; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        // Generate random data for demo (replace with real data)
        data.push(Math.floor(Math.random() * 10) + 1);
      }

      if (applicationsChart) {
        applicationsChart.data.labels = labels;
        applicationsChart.data.datasets[0].data = data;
        applicationsChart.update();
      }
    }

    function initStudentChart() {
      const ctx = document.getElementById('studentChart').getContext('2d');
      
      // Generate sample data for student status
      const statusData = {
        labels: ['Active', 'Pending', 'Rejected'],
        datasets: [{
          label: 'Students',
          data: [45, 23, 8],
          backgroundColor: [
            'rgba(102, 126, 234, 0.8)',
            'rgba(243, 156, 18, 0.8)',
            'rgba(231, 76, 60, 0.8)'
          ],
          borderColor: [
            '#667eea',
            '#f39c12',
            '#e74c3c'
          ],
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false,
        }]
      };

      studentChart = new Chart(ctx, {
        type: 'bar',
        data: statusData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                stepSize: 5
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          elements: {
            bar: {
              borderRadius: 8
            }
          }
        }
      });
    }

    function updateStudentChart() {
      const chartType = document.getElementById('student-chart-type').value;
      
      if (!studentChart) return;

      let newData;
      
      switch(chartType) {
        case 'status':
          newData = {
            labels: ['Active', 'Pending', 'Rejected'],
            datasets: [{
              label: 'Students',
              data: [45, 23, 8],
              backgroundColor: [
                'rgba(102, 126, 234, 0.8)',
                'rgba(243, 156, 18, 0.8)',
                'rgba(231, 76, 60, 0.8)'
              ],
              borderColor: ['#667eea', '#f39c12', '#e74c3c'],
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            }]
          };
          break;
        case 'program':
          newData = {
            labels: ['Computer Science', 'Business Admin', 'Engineering', 'Arts'],
            datasets: [{
              label: 'Students',
              data: [32, 28, 15, 12],
              backgroundColor: [
                'rgba(102, 126, 234, 0.8)',
                'rgba(118, 75, 162, 0.8)',
                'rgba(39, 174, 96, 0.8)',
                'rgba(243, 156, 18, 0.8)'
              ],
              borderColor: ['#667eea', '#764ba2', '#27ae60', '#f39c12'],
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            }]
          };
          break;
        case 'monthly':
          newData = {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
              label: 'Registrations',
              data: [12, 19, 8, 15, 22, 18],
              backgroundColor: 'rgba(102, 126, 234, 0.8)',
              borderColor: '#667eea',
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            }]
          };
          break;
      }

      studentChart.data = newData;
      studentChart.update();
    }

    // Student Registration Management Functions
    function loadStudentRegistrations() {
      console.log('Loading student applications...');
      fetch('/api/admin/student-applications/', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
      })
        .then(response => {
          console.log('Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Registrations data:', data);
          const registrationList = document.getElementById('registration-list');
          registrationList.innerHTML = '';
          
          if (data.applications.length === 0) {
            registrationList.innerHTML = '<p class="no-applications">No student registrations found.</p>';
            return;
          }
          
          data.applications.forEach(application => {
            const applicationElement = createApplicationElement(application);
            registrationList.appendChild(applicationElement);
          });
        })
        .catch(error => {
          console.error('Error loading registrations:', error);
          document.getElementById('registration-list').innerHTML = '<p class="error">Error loading registrations: ' + error.message + '</p>';
        });
    }

    function createApplicationElement(application) {
      const div = document.createElement('div');
      div.className = `application-item application-${application.status}`;
      div.innerHTML = `
        <div class="application-header">
          <h4>${application.first_name} ${application.last_name}</h4>
          <div class="application-status">
            <span class="status-badge status-${application.status}">${application.status}</span>
          </div>
        </div>
        <div class="application-content">
          <div class="application-details">
            <div class="detail-row">
              <span class="detail-label">Username:</span>
              <span class="detail-value">${application.username}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Email:</span>
              <span class="detail-value">${application.email}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Program & Year:</span>
              <span class="detail-value">${application.program_and_yr}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Contact:</span>
              <span class="detail-value">${application.contact_num}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Address:</span>
              <span class="detail-value">${application.address}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Birthday:</span>
              <span class="detail-value">${new Date(application.bday).toLocaleDateString()}</span>
            </div>
            ${application.doc_submitted ? `
            <div class="detail-row">
              <span class="detail-label">Document:</span>
              <span class="detail-value">
                <a href="/media/${application.doc_submitted}" target="_blank" class="document-link">View Document</a>
              </span>
            </div>
            ` : ''}
          </div>
          <div class="application-meta">
            <span class="application-date">Applied: ${new Date(application.created_at || Date.now()).toLocaleDateString()}</span>
          </div>
          <div class="application-actions">
            ${application.status === 'pending' ? `
              <button class="btn btn-success btn-sm" onclick="approveStudent(${application.id})">Approve</button>
              <button class="btn btn-danger btn-sm" onclick="rejectStudent(${application.id})">Reject</button>
            ` : `
              <span class="action-completed">Action completed</span>
            `}
          </div>
        </div>
      `;
      return div;
    }

    function approveStudent(studentId) {
      if (confirm('Are you sure you want to approve this student application?')) {
        fetch(`/api/admin/student-applications/${studentId}/approve/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            loadStudentRegistrations();
            loadDashboardStats(); // Refresh stats
          } else {
            alert('Error approving student: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error approving student application');
        });
      }
    }

    function rejectStudent(studentId) {
      if (confirm('Are you sure you want to reject this student application?')) {
        fetch(`/api/admin/student-applications/${studentId}/reject/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            loadStudentRegistrations();
            loadDashboardStats(); // Refresh stats
          } else {
            alert('Error rejecting student: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error rejecting student application');
        });
      }
    }

    function filterRegistrations() {
      const filter = document.getElementById('registration-filter').value;
      const applicationItems = document.querySelectorAll('.application-item');
      
      applicationItems.forEach(item => {
        if (filter === 'all') {
          item.style.display = 'block';
        } else {
          item.style.display = item.classList.contains(`application-${filter}`) ? 'block' : 'none';
        }
      });
    }

    // Program Application Management Functions
    function loadProgramApplications() {
      console.log('Loading program applications...');
      fetch('/api/admin/program-applications/', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
      })
        .then(response => {
          console.log('Program applications response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Program applications data:', data);
          const applicationList = document.getElementById('program-application-list');
          applicationList.innerHTML = '';
          
          if (data.applications.length === 0) {
            applicationList.innerHTML = '<p class="no-applications">No program applications found.</p>';
            return;
          }
          
          data.applications.forEach(application => {
            const applicationElement = createProgramApplicationElement(application);
            applicationList.appendChild(applicationElement);
          });
        })
        .catch(error => {
          console.error('Error loading program applications:', error);
          document.getElementById('program-application-list').innerHTML = '<p class="error">Error loading program applications: ' + error.message + '</p>';
        });
    }

    function createProgramApplicationElement(application) {
      const div = document.createElement('div');
      div.className = `application-item application-${application.requirement_status}`;
      div.innerHTML = `
        <div class="application-header">
          <h4>${application.student.first_name} ${application.student.last_name}</h4>
          <div class="application-status">
            <span class="status-badge status-${application.requirement_status}">${application.requirement_status}</span>
          </div>
        </div>
        <div class="application-content">
          <div class="application-details">
            <div class="detail-row">
              <span class="detail-label">Student:</span>
              <span class="detail-value">${application.student.username}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Program:</span>
              <span class="detail-value">${application.program.program_name}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Motivation:</span>
              <span class="detail-value">${application.remarks || 'No motivation provided'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Applied:</span>
              <span class="detail-value">${application.created_at ? new Date(application.created_at).toLocaleDateString() : 'Date not available'}</span>
            </div>
          </div>
          <div class="application-actions">
            ${application.requirement_status === 'submitted' ? `
              <button class="btn btn-success btn-sm" onclick="approveProgramApplication(${application.app_id})">Approve</button>
              <button class="btn btn-danger btn-sm" onclick="rejectProgramApplication(${application.app_id})">Reject</button>
            ` : `
              <span class="action-completed">Action completed</span>
            `}
          </div>
        </div>
      `;
      return div;
    }

    function approveProgramApplication(applicationId) {
      if (confirm('Are you sure you want to approve this program application?')) {
        fetch(`/api/admin/program-applications/${applicationId}/approve/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            loadProgramApplications();
          } else {
            alert('Error approving program application: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error approving program application');
        });
      }
    }

    function rejectProgramApplication(applicationId) {
      if (confirm('Are you sure you want to reject this program application?')) {
        fetch(`/api/admin/program-applications/${applicationId}/reject/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            loadProgramApplications();
          } else {
            alert('Error rejecting program application: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error rejecting program application');
        });
      }
    }

    function filterProgramApplications() {
      const filter = document.getElementById('program-application-filter').value;
      const applicationItems = document.querySelectorAll('#program-application-list .application-item');
      
      applicationItems.forEach(item => {
        if (filter === 'all') {
          item.style.display = 'block';
        } else {
          item.style.display = item.classList.contains(`application-${filter}`) ? 'block' : 'none';
        }
      });
    }

    // Form submission
    document.getElementById('popup-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const popupId = formData.get('popup_id');
      const url = popupId ? `/api/admin/popups/${popupId}/edit/` : '/api/admin/popups/create/';
      const method = popupId ? 'PUT' : 'POST';
      
      fetch(url, {
        method: method,
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title: formData.get('title'),
          message: formData.get('message'),
          popup_type: formData.get('popup_type'),
          is_active: formData.get('is_active') === 'on',
          expires_at: formData.get('expires_at') || null,
        }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closePopupModal();
          loadPopups();
        } else {
          alert('Error saving popup: ' + data.error);
        }
      });
    });

    function getCsrf() {
      const name = 'csrftoken=';
      const c = document.cookie.split(';').map(s => s.trim()).find(s => s.startsWith(name));
      return c ? decodeURIComponent(c.substring(name.length)) : '';
    }

    async function handleCreateProgram(e) {
      e.preventDefault();
      const form = document.getElementById('createProgramForm');
      const endpoint = form.getAttribute('data-endpoint') || '/accounts/create-program/';
      const msg = document.getElementById('createProgramMsg');

      const fd = new FormData(form);

      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          body: fd,
          headers: { 'X-CSRFToken': getCsrf() },
          credentials: 'same-origin'
        });
        const data = await res.json();
        msg.style.display = 'block';
        if (res.ok && data.success) {
          msg.className = 'app-message success';
          msg.textContent = 'Program created.';
          form.reset();
          // optionally refresh program list via another fetch
        } else {
          msg.className = 'app-message error';
          msg.textContent = data.error || 'Failed to create program.';
        }
      } catch (err) {
        msg.style.display = 'block';
        msg.className = 'app-message error';
        msg.textContent = 'Network error.';
      }
    }

    // Utility function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('popup-modal');
      if (event.target === modal) {
        closePopupModal();
      }
    }

    function toggleProgramForm() {
      const form = document.getElementById('programForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    document.querySelector('.program-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      try {
          const response = await fetch('/home/create_program/', {
              method: 'POST',
              body: formData,
              headers: {
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              }
          });
          
          const data = await response.json();
          if (data.success) {
              alert('Program created successfully!');
              this.reset();
              hideCreateProgram();
              await loadPrograms();
              // Optionally reload programs list
          } else {
              alert(data.error || 'Failed to create program');
          }
      } catch (error) {
          alert('Error creating program');
          console.error(error);
      }
    });

    async function loadPrograms() {
      const container = document.querySelector('.programs-list');
      const endpoints = ['/home/programs/', '/programs/'];
      let data = null;
      for (const url of endpoints) {
        try {
          const res = await fetch(url, { credentials: 'same-origin' });
          console.log('Programs fetch', url, res.status);
          if (!res.ok) continue;
          data = await res.json();
          break;
        } catch (e) {
          console.warn('Programs fetch failed for', url, e);
        }
      }
      container.innerHTML = '';
      if (!data || !data.programs) {
        container.innerHTML = '<p class="no-programs">Unable to load programs.</p>';
        return;
      }
      if (data.programs.length === 0) {
        container.innerHTML = '<p class="no-programs">No programs found.</p>';
        return;
      }
      data.programs.forEach(p => {
        const el = document.createElement('div');
        el.className = 'program-item';
        el.innerHTML = `
          <div class="program-header">
            <h4>${p.program_name}</h4>
          </div>
          <div class="program-body">
            <p>${p.requirements || ''}</p>
          </div>
        `;
        container.appendChild(el);
      });
    }

    // Initial loads
    loadPrograms();
  </script>
  <footer style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #e0e0e0; color: #666; font-size: 14px;">
    Â© 2024 Lander. All rights reserved.
  </footer>

  
</body>
</html>
