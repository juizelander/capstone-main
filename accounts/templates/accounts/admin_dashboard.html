{% load static %}
<!DOCTYPE html>
<html>

<head>
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="icon" type="image/png" href="{% static 'accounts/favicon.png' %}">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        fontFamily: {
          sans: ['Roboto', 'sans-serif'],
          heading: ['Raleway', 'sans-serif'],
        },
        extend: {
          colors: {
            brand: {
              primary: '#10B981',
              secondary: '#F59E0B',
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-out',
            'slide-up': 'slideUp 0.4s ease-out',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            }
          }
        }
      }
    }
  </script>

  <style>
    .ql-editor {
      min-height: 150px;
      font-family: inherit;
      font-size: 14px;
    }

    .program-type-badge {
      display: inline-block;
      padding: 0.25em 0.8em;
      font-size: 0.75em;
      font-weight: 700;
      color: #fff;
      background-color: #4a5568;
      border-radius: 9999px;
      margin-left: 8px;
      vertical-align: middle;
    }
  </style>
</head>
<link rel="stylesheet" href="{% static 'accounts/student_dashboard.css' %}">
<link rel="stylesheet" href="{% static 'accounts/admin_dashboard.css' %}?v=2">

<body>
  <div class="sd-app-layout">
    <!-- Sidebar -->
    <aside class="sd-sidebar">
      <div class="sd-sidebar-header">
        <a href="#" onclick="document.querySelector('[data-tab=dashboard]').click(); return false;" class="flex items-center gap-2" style="text-decoration:none; color:inherit;">
          <img src="{% static 'accounts/favicon.png' %}" alt="Logo">
          <span>ScholarSync</span>
        </a>
      </div>
      <nav class="sd-sidebar-nav">

        <a href="#" class="nav-item active transition-all duration-300 ease-in-out transform hover:translate-x-2" data-tab="dashboard">
          <i class="fas fa-chart-line"></i> Dashboard
        </a>
        <a href="#" class="nav-item transition-all duration-300 ease-in-out transform hover:translate-x-2 relative" data-tab="student-registrations">
          <i class="fas fa-user-plus"></i> Applicant Registration
          <span class="nav-badge" id="badge-registrations" style="display: none; background: #ef4444; color: white; padding: 2px 6px; border-radius: 9999px; font-size: 0.7rem; font-weight: bold; margin-left: auto;">0</span>
        </a>
        <a href="#" class="nav-item transition-all duration-300 ease-in-out transform hover:translate-x-2 relative" data-tab="student-applications">
          <i class="fas fa-file-alt"></i> Program Applications
          <span class="nav-badge" id="badge-applications" style="display: none; background: #ef4444; color: white; padding: 2px 6px; border-radius: 9999px; font-size: 0.7rem; font-weight: bold; margin-left: auto;">0</span>
        </a>
        <a href="#" class="nav-item transition-all duration-300 ease-in-out transform hover:translate-x-2 relative" data-tab="notifications">
          <i class="fas fa-bell"></i> Notifications
          <span class="nav-badge" id="badge-notifications" style="display: none; background: #ef4444; color: white; padding: 2px 6px; border-radius: 9999px; font-size: 0.7rem; font-weight: bold; margin-left: auto;">0</span>
        </a>
        <a href="#" class="nav-item transition-all duration-300 ease-in-out transform hover:translate-x-2" data-tab="students">
          <i class="fas fa-users-cog"></i> Applicant Management
        </a>
        <a href="#" class="nav-item transition-all duration-300 ease-in-out transform hover:translate-x-2" data-tab="admins">
          <i class="fas fa-user-shield"></i> Admins
        </a>
        <a href="#" class="nav-item transition-all duration-300 ease-in-out transform hover:translate-x-2" data-tab="reports">
          <i class="fas fa-chart-bar"></i> Reports
        </a>
        <a href="#" class="nav-item transition-all duration-300 ease-in-out transform hover:translate-x-2" data-tab="programs">
          <i class="fas fa-graduation-cap"></i> Programs
        </a>
        <a href="#" class="nav-item transition-all duration-300 ease-in-out transform hover:translate-x-2 relative" data-tab="inbox">
          <i class="fas fa-inbox"></i> Inbox / Support
          <span class="nav-badge" id="badge-inbox" style="display: none; background: #ef4444; color: white; padding: 2px 6px; border-radius: 9999px; font-size: 0.7rem; font-weight: bold; margin-left: auto;">0</span>
        </a>
      </nav>
      
      <div class="sd-sidebar-footer relative">
        <div class="profile-card cursor-pointer p-4 rounded-xl shadow-md transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 group relative overflow-hidden" onclick="toggleProfileDropdown(event)">
          <div class="absolute inset-0 bg-gradient-to-r from-brand-primary to-brand-secondary transform -translate-x-full group-hover:translate-x-0 transition-transform duration-500 ease-out z-0"></div>
          
          <div class="relative z-10 flex items-center justify-between">
            <div class="flex items-center gap-3 overflow-hidden">
              <div class="avatar-circle w-11 h-11 flex-shrink-0 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 group-hover:bg-white/20 group-hover:text-white transition-colors duration-300">
                <i class="fas fa-user-shield"></i>
              </div>
              <div class="profile-info flex-1 overflow-hidden">
                <div class="font-bold text-base truncate text-gray-900 dark:text-white group-hover:text-white transition-colors duration-300">{{ admin.admin_name }}</div>
                <div class="text-xs font-medium text-gray-600 dark:text-gray-400 group-hover:text-white/90 transition-colors duration-300">Admin Account</div>
              </div>
            </div>
            <i class="fas fa-chevron-up text-sm text-gray-500 dark:text-gray-400 group-hover:text-white/90 transition-all duration-300" id="profile-chevron"></i>
          </div>
        </div>

        <!-- Logout Dropdown -->
        <div class="profile-dropdown absolute bottom-[calc(100%+0.5rem)] left-0 w-full bg-white dark:bg-gray-900 rounded-xl shadow-xl border border-gray-100 dark:border-gray-800 hidden flex-col overflow-hidden animate-slide-up z-50" id="profile-dropdown">
          <form method="post" action="{% url 'accounts:logout' %}" class="m-0">
            {% csrf_token %}
            <button type="submit" class="w-full flex items-center gap-3 p-4 text-sm font-semibold text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
              <i class="fas fa-sign-out-alt w-5 text-center"></i> Logout
            </button>
          </form>
        </div>
      </div>
    </aside>

    <!-- Main Wrapper -->
    <div class="sd-main-wrapper">
      <!-- Topbar -->
      <header class="sd-topbar" style="justify-content: flex-end;">
        <div class="topbar-actions" style="margin-left: auto;">
          <button id="theme-toggle" class="btn btn-outline" style="border: none; padding: 5px; font-size: 1.25rem;">
            <i class="fas fa-moon"></i>
          </button>
        </div>
      </header>
      
      <!-- Main Content Area -->
      <main class="sd-content">
      <!-- Dashboard Tab -->
      <div id="dashboard" class="tab-content active animate-fade-in">
        <div class="welcome-header animate-slide-up bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6 flex justify-between items-center">
          <div>
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Dashboard Overview</h1>
            <p class="text-gray-500 dark:text-gray-400">Welcome to your admin dashboard. Use the sidebar to navigate between different sections.</p>
          </div>
          <button class="btn btn-primary transition-all duration-200 transform hover:scale-105 active:scale-95 bg-brand-primary text-white px-4 py-2 rounded-lg shadow font-medium flex items-center gap-2" onclick="switchTab('programs')">
            <i class="fas fa-plus"></i> New Program
          </button>
        </div>

        <!-- Statistics Cards -->
        <div class="kpi-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="kpi-card highlight transition-all duration-300 transform hover:-translate-y-2 hover:shadow-xl animate-fade-in bg-gradient-to-br from-brand-primary to-green-600 text-white p-6 rounded-xl" style="animation-delay: 100ms;">
            <div class="flex justify-between items-start mb-4">
              <div class="kpi-title font-medium text-white/90">Total Applicants</div>
              <i class="fas fa-users text-2xl text-white/80"></i>
            </div>
            <div class="kpi-value text-4xl font-bold" id="total-students">Loading...</div>
          </div>

          <div class="kpi-card transition-all duration-300 transform hover:-translate-y-2 hover:shadow-xl animate-fade-in bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-100 dark:border-gray-700" style="animation-delay: 200ms;">
            <div class="flex justify-between items-start mb-4">
              <div class="kpi-title font-medium text-gray-500 dark:text-gray-400">Active Announcements</div>
              <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fas fa-bell"></i></div>
            </div>
            <div class="kpi-value kpi-primary text-3xl font-bold text-gray-800 dark:text-white" id="active-popups">Loading...</div>
          </div>

          <div class="kpi-card transition-all duration-300 transform hover:-translate-y-2 hover:shadow-xl animate-fade-in bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-100 dark:border-gray-700" style="animation-delay: 300ms;">
            <div class="flex justify-between items-start mb-4">
              <div class="kpi-title font-medium text-gray-500 dark:text-gray-400">Pending Applications</div>
              <div class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center"><i class="fas fa-clock"></i></div>
            </div>
            <div class="kpi-value kpi-warning text-3xl font-bold text-gray-800 dark:text-white" id="pending-applications">Loading...</div>
          </div>

          <div class="kpi-card transition-all duration-300 transform hover:-translate-y-2 hover:shadow-xl animate-fade-in bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-100 dark:border-gray-700" style="animation-delay: 400ms;">
            <div class="flex justify-between items-start mb-4">
              <div class="kpi-title font-medium text-gray-500 dark:text-gray-400">Total Programs</div>
              <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center"><i class="fas fa-graduation-cap"></i></div>
            </div>
            <div class="kpi-value kpi-success text-3xl font-bold text-gray-800 dark:text-white" id="total-programs">Loading...</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- Chart Section -->
          <div class="card chart-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
            <div class="card-header flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-gray-800 dark:text-white">Application Trends</h3>
              <div class="chart-controls">
                <select id="chart-period" onchange="updateChart()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-brand-primary focus:border-brand-primary block w-full p-2.5">
                  <option value="7">Last 7 Days</option>
                  <option value="30" selected>Last 30 Days</option>
                  <option value="90">Last 90 Days</option>
                </select>
              </div>
            </div>
            <div class="chart-container relative h-64 w-full">
              <canvas id="applicationsChart"></canvas>
            </div>
          </div>

          <!-- Student Statistics Bar Chart -->
          <div class="card chart-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
            <div class="card-header flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-gray-800 dark:text-white">Applicant Statistics</h3>
              <div class="chart-controls">
                <select id="student-chart-type" onchange="updateStudentChart()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-brand-primary focus:border-brand-primary block w-full p-2.5">
                  <option value="status" selected>By Status</option>
                  <option value="program">By Program</option>
                  <option value="monthly">Monthly Registrations</option>
                </select>
              </div>
            </div>
            <div class="chart-container relative h-64 w-full">
              <canvas id="studentChart"></canvas>
            </div>
          </div>
        </div>
        
        <!-- Admin Logs Card -->
        <div class="card tab-card animate-slide-up bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 w-full mb-8">
          <div class="card-header flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Admin Logs</h3>
            <div class="admin-log-filters flex gap-3">
              <select id="admin-logs-filter" onchange="filterAndSortAdminLogs()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-brand-primary focus:border-brand-primary block w-full p-2.5">
                <option value="all" selected>All Actions</option>
                <option value="signed in">Signed In</option>
                <option value="signed out">Signed Out</option>
                <option value="create">Created</option>
                <option value="update">Updated / Edited</option>
                <option value="delete">Deleted / Removed</option>
                <option value="approve">Approved</option>
                <option value="reject">Rejected</option>
              </select>
              <select id="admin-logs-sort" onchange="filterAndSortAdminLogs()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-brand-primary focus:border-brand-primary block w-full p-2.5">
                <option value="newest" selected>Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="admin_asc">Admin Name (A-Z)</option>
                <option value="action_asc">Action (A-Z)</option>
              </select>
            </div>
          </div>
          <div class="overflow-hidden relative max-h-[300px] rounded-lg border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 overflow-y-auto w-full">
            <table class="data-table w-full text-left border-collapse" id="adminLogsTable">
              <thead class="sticky top-0 bg-gray-100 dark:bg-gray-700 z-10 w-full shadow-sm">
                <tr class="border-b border-gray-200 dark:border-gray-600">
                  <th class="p-3 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700/50">Time</th>
                  <th class="p-3 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700/50">Admin</th>
                  <th class="p-3 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700/50">Action</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 dark:divide-gray-700/50 bg-white dark:bg-gray-800 w-full">
                {% for log in admin_logs %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors w-full" data-index="{{ forloop.counter0 }}">
                  <td class="p-3 text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap">{{ log.timestamp|date:"M d, Y" }} <br> {{ log.timestamp|date:"H:i" }}</td>
                  <td class="p-3 text-sm text-gray-800 dark:text-gray-200 font-medium">{% if log.admin.full_name %}{{ log.admin.full_name }}{% else %}{{ log.admin.admin_name }}{% endif %}</td>
                  <td class="p-3 text-sm text-gray-600 dark:text-gray-300">{{ log.action }}</td>
                </tr>
                {% endfor %}
                {% if not admin_logs %}
                <tr><td colspan="3" class="p-4 text-center text-gray-500">No admin logs available.</td></tr>
                {% endif %}
              </tbody>
            </table>
            
            <script>
            document.addEventListener('DOMContentLoaded', () => {
                const tableBody = document.querySelector('#adminLogsTable tbody');
                if (!tableBody) return;
                const rows = Array.from(tableBody.querySelectorAll('tr[data-index]'));
            
                // Apply colors based on action text
                rows.forEach(row => {
                    const actionCell = row.cells[2];
                    if (!actionCell) return;
                    const text = actionCell.textContent.toLowerCase();
                    
                    let colorClass = '';
                    if (text.includes('create') || text.includes('approve') || text.includes('add') || text.includes('active')) {
                        colorClass = 'text-green-700 dark:text-green-400 bg-green-50 dark:bg-green-900/20 px-2 py-1 rounded inline-block';
                    } else if (text.includes('delete') || text.includes('reject') || text.includes('remove') || text.includes('deactivate')) {
                        colorClass = 'text-orange-700 dark:text-orange-400 bg-orange-50 dark:bg-orange-900/20 px-2 py-1 rounded inline-block';
                    } else if (text.includes('edit') || text.includes('update')) {
                        colorClass = 'text-blue-700 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 px-2 py-1 rounded inline-block';
                    }
                    
                    if (colorClass) {
                        actionCell.innerHTML = `<span class="${colorClass} font-medium tracking-wide">${actionCell.textContent}</span>`;
                        actionCell.classList.remove('text-gray-600', 'dark:text-gray-300');
                    }
                });
            });
            
            function filterAndSortAdminLogs() {
                const tbody = document.querySelector('#adminLogsTable tbody');
                const rows = Array.from(tbody.querySelectorAll('tr[data-index]'));
                if (rows.length === 0) return;
            
                const filterType = document.getElementById('admin-logs-filter').value;
                const sortType = document.getElementById('admin-logs-sort').value;
                
                // First apply filtering
                rows.forEach(row => {
                    const actionText = row.cells[2].textContent.trim().toLowerCase();
                    if (filterType === 'all' || actionText.includes(filterType) || (filterType === 'update' && actionText.includes('edit')) || (filterType === 'delete' && actionText.includes('remove'))) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // Then sort all rows
                rows.sort((a, b) => {
                    if (sortType === 'newest') {
                        return parseInt(a.dataset.index) - parseInt(b.dataset.index);
                    } else if (sortType === 'oldest') {
                        return parseInt(b.dataset.index) - parseInt(a.dataset.index);
                    } else if (sortType === 'admin_asc') {
                        const adminA = a.cells[1].textContent.trim().toLowerCase();
                        const adminB = b.cells[1].textContent.trim().toLowerCase();
                        return adminA.localeCompare(adminB);
                    } else if (sortType === 'action_asc') {
                        const actionA = a.cells[2].textContent.trim().toLowerCase();
                        const actionB = b.cells[2].textContent.trim().toLowerCase();
                        return actionA.localeCompare(actionB);
                    }
                    return 0;
                });
            
                tbody.innerHTML = '';
                rows.forEach(row => tbody.appendChild(row));
            }
            </script>
            
          </div>
        </div>

      </div>

      <!-- Student Account Registration Tab -->
      <div id="student-registrations" class="tab-content animate-fade-in">
        <div class="card tab-card animate-slide-up bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
          <div class="card-header flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Applicant Account Registration</h3>
            <div class="application-filters">
              <select id="registration-filter" onchange="filterRegistrations()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-brand-primary focus:border-brand-primary block w-full p-2.5">
                <option value="all">All Registrations</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
          </div>

          <div class="application-list grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="registration-list">
            <!-- Student registrations will be loaded here via JavaScript -->
          </div>
        </div>
      </div>

      <!-- Student Applications Tab -->
      <div id="student-applications" class="tab-content animate-fade-in">
        <div class="card tab-card animate-slide-up bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
          <div class="card-header flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Applicant Program Applications</h3>
            <div class="application-filters">
              <select id="program-application-filter" onchange="filterProgramApplications()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-brand-primary focus:border-brand-primary block w-full p-2.5">
                <option value="all">All Applications</option>
                <option value="submitted">Submitted</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
          </div>

          <div class="application-list grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="program-application-list">
            <!-- Program applications will be loaded here via JavaScript -->
          </div>
        </div>
      </div>

      <!-- Notification Center Tab -->
      <div id="notifications" class="tab-content animate-fade-in">
        <div class="card tab-card animate-slide-up bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
          <div class="card-header flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Notification Center</h3>
            <button class="btn btn-primary bg-brand-primary hover:bg-brand-secondary transition-colors duration-200 text-white font-medium px-4 py-2 rounded-lg shadow-sm flex items-center gap-2" onclick="openPopupModal()">
              <i class="fas fa-plus"></i> Create New Popup
            </button>
          </div>

          <div class="popup-filters mb-6">
            <select id="popup-filter" onchange="filterPopups()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-brand-primary focus:border-brand-primary block w-full sm:max-w-xs p-2.5">
              <option value="all">All Popups</option>
              <option value="active">Active Only</option>
              <option value="inactive">Inactive Only</option>
              <option value="info">Information</option>
              <option value="warning">Warning</option>
              <option value="success">Success</option>
              <option value="error">Error</option>
            </select>
          </div>

          <div class="popup-list grid gap-4 lg:grid-cols-2" id="popup-list">
            <!-- Popups will be loaded here via JavaScript -->
          </div>
        </div>
      </div>

      <!-- Students Tab -->
      <div id="students" class="tab-content animate-fade-in">
        <div id="student-list-card" class="card tab-card animate-slide-up bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
          <div class="card-header flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Applicant Management</h3>
            <div class="application-filters flex flex-col sm:flex-row gap-3 w-full md:w-auto">
              <input type="text" id="student-search" placeholder="Search students..." onkeyup="filterStudents()"
                class="search-input bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-brand-primary focus:border-brand-primary block w-full p-2.5">
              <select id="student-status-filter" onchange="filterStudents()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-brand-primary focus:border-brand-primary block w-full sm:w-auto p-2.5">
                <option value="all">All Students</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="pending">Pending</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
          </div>

          <div class="student-list grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="student-list">
            <!-- Students will be loaded here via JavaScript -->
          </div>
        </div>

        <!-- ====== Student Profile Section (inline, no card, no modal) ====== -->
        <div id="student-profile-section" style="display:none;" class="bg-white dark:bg-gray-800 p-6 md:p-10 shadow-sm border border-gray-100 dark:border-gray-700 w-full min-h-[calc(100vh-120px)] rounded-2xl transition-colors duration-200">

          <!-- Navigation row: Back + counter + arrows -->
          <div class="flex items-center justify-between mb-8 max-w-5xl mx-auto w-full">
            <button onclick="goBackToStudentList()" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-gray-600 dark:text-gray-300 hover:text-brand-primary dark:hover:text-brand-primary transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
              Back
            </button>
            <div class="flex items-center gap-3">
              <button onclick="navigateStudent(-1)" class="flex items-center gap-1 px-3 py-1.5 text-sm font-semibold text-gray-600 dark:text-gray-300 hover:text-brand-primary dark:hover:text-brand-primary transition-colors border border-gray-200 dark:border-gray-700 rounded-lg">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                Prev
              </button>
              <span id="sp-nav-label" class="text-sm font-medium text-gray-400 min-w-[60px] text-center"></span>
              <button onclick="navigateStudent(1)" class="flex items-center gap-1 px-3 py-1.5 text-sm font-semibold text-gray-600 dark:text-gray-300 hover:text-brand-primary dark:hover:text-brand-primary transition-colors border border-gray-200 dark:border-gray-700 rounded-lg">
                Next
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
              </button>
            </div>
          </div>

          <!-- Profile body: avatar col + info col -->
          <div class="flex flex-col lg:flex-row gap-10 max-w-5xl mx-auto w-full">

            <!-- Left: Avatar + status + actions -->
            <div class="flex flex-col items-center lg:items-start gap-4 lg:w-56 shrink-0">
              <div id="sp-avatar" class="w-28 h-28 rounded-full overflow-hidden shadow-lg"></div>
              <div class="text-center lg:text-left">
                <h2 id="sp-name" class="text-2xl font-extrabold text-gray-900 dark:text-white"></h2>
                <p id="sp-username" class="text-sm text-gray-400 mt-0.5"></p>
              </div>
              <span id="sp-status" class="px-3 py-1 text-xs font-bold rounded-full border uppercase tracking-wider"></span>
              <div class="flex flex-col gap-2 w-full mt-2">
                <button id="sp-print-btn" onclick="printStudentProfile()" class="w-full py-2 px-4 rounded-lg text-sm font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 border border-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600 transition flex items-center justify-center gap-2">
                  <i class="fas fa-print"></i> Print Profile
                </button>
                <button id="sp-download-btn" onclick="downloadStudentProfile()" class="w-full py-2 px-4 rounded-lg text-sm font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 border border-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600 transition flex items-center justify-center gap-2">
                  <i class="fas fa-download"></i> Download Profile
                </button>
                <button id="sp-message-btn" class="w-full py-2 px-4 rounded-lg text-sm font-semibold text-white bg-blue-500 hover:bg-blue-600 transition flex items-center justify-center gap-2">
                  <i class="fas fa-envelope"></i> Message
                </button>
                <button id="sp-toggle-btn" class="w-full py-2 px-4 rounded-lg text-sm font-semibold text-white bg-brand-primary hover:opacity-90 transition"></button>
                <button id="sp-delete-btn" class="w-full py-2 px-4 rounded-lg text-sm font-semibold text-white bg-red-500 hover:bg-red-600 transition">Delete Student</button>
              </div>
            </div>

            <!-- Right: Details + Documents -->
            <div class="flex-1 min-w-0">

              <!-- Info fields -->
              <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-x-10 gap-y-6 mb-10">
                <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Email</p><p id="sp-email" class="text-gray-800 dark:text-gray-100 font-medium"></p></div>
                <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Contact</p><p id="sp-contact" class="text-gray-800 dark:text-gray-100 font-medium"></p></div>
                <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Sex</p><p id="sp-sex" class="text-gray-800 dark:text-gray-100 font-medium"></p></div>
                <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Birthday</p><p id="sp-birthday" class="text-gray-800 dark:text-gray-100 font-medium"></p></div>
                <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Student Type</p><p id="sp-student-type" class="text-gray-800 dark:text-gray-100 font-medium"></p></div>
                <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Program / Year</p><p id="sp-program" class="text-gray-800 dark:text-gray-100 font-medium"></p></div>
                <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Barangay</p><p id="sp-barangay" class="text-gray-800 dark:text-gray-100 font-medium"></p></div>
                <div class="sm:col-span-2 xl:col-span-2"><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Address</p><p id="sp-address" class="text-gray-800 dark:text-gray-100 font-medium"></p></div>
              </div>

              <!-- Academic History -->
              <div class="mb-10">
                <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-4 flex items-center gap-2">
                  <i class="fas fa-graduation-cap text-brand-primary"></i> Academic History
                </h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-10 gap-y-6">
                  <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Elementary</p><p id="sp-elem" class="text-gray-800 dark:text-gray-100 font-medium text-sm"></p></div>
                  <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Junior High School</p><p id="sp-jhs" class="text-gray-800 dark:text-gray-100 font-medium text-sm"></p></div>
                  <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Senior High School</p><p id="sp-shs" class="text-gray-800 dark:text-gray-100 font-medium text-sm"></p></div>
                  <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">College</p><p id="sp-college" class="text-gray-800 dark:text-gray-100 font-medium text-sm"></p></div>
                </div>
              </div>

              <!-- Family Background -->
              <div class="mb-10">
                <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-4 flex items-center gap-2">
                  <i class="fas fa-users text-brand-primary"></i> Family Background
                </h4>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-10 gap-y-6">
                  <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Parent Name</p><p id="sp-parent" class="text-gray-800 dark:text-gray-100 font-medium text-sm"></p></div>
                  <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Guardian Name</p><p id="sp-guardian" class="text-gray-800 dark:text-gray-100 font-medium text-sm"></p></div>
                  <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Guardian Contact</p><p id="sp-guardian-contact" class="text-gray-800 dark:text-gray-100 font-medium text-sm"></p></div>
                </div>
              </div>

              <!-- Achievements -->
              <div class="mb-10">
                <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-4 flex items-center gap-2">
                  <i class="fas fa-trophy text-brand-primary"></i> Achievements & Extracurriculars
                </h4>
                <p id="sp-achievements" class="text-sm text-gray-800 dark:text-gray-300 whitespace-pre-wrap leading-relaxed bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl border border-gray-100 dark:border-gray-700"></p>
              </div>

              <!-- Documents checklist -->
              <div>
                <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-4 flex items-center gap-2">
                  <svg class="w-4 h-4 text-brand-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  Uploaded Documents
                </h4>
                <div id="sp-documents" class="flex flex-col gap-2"></div>
              </div>

              <!-- Footer for generated on print/pdf -->
              <div class="mt-12 pt-6 border-t border-gray-200 dark:border-gray-700 text-xs text-gray-400 font-medium tracking-wide">
                <span id="sp-generated-date"></span>
              </div>

            </div>
          </div>
        </div>
        <!-- ====== End Profile Section ====== -->

      </div>

      <!-- Inbox / Support Tab -->
      <div id="inbox" class="tab-content animate-fade-in">
        <div class="card tab-card animate-slide-up bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
          <div class="card-header flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Inbox / Support Tickets</h3>
            <div class="application-filters flex gap-3 items-center w-full md:w-auto mt-4 md:mt-0" style="margin: 0;">
              <button class="btn btn-sm btn-outline px-3 py-2 text-sm text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2" onclick="loadAdminMessages()">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
              <select id="inbox-filter" onchange="filterAdminMessages()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-brand-primary focus:border-brand-primary block w-full sm:w-auto p-2.5">
                <option value="all">All Messages</option>
                <option value="unread">Unread Only</option>
              </select>
            </div>
          </div>
          
          <div class="overflow-x-auto rounded-lg border border-gray-100 dark:border-gray-700 mb-10">
            <table class="data-table w-full text-left border-collapse">
              <thead>
                <tr class="bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700">
                  <th class="p-4 text-sm font-semibold text-gray-700 dark:text-gray-300">Status</th>
                  <th class="p-4 text-sm font-semibold text-gray-700 dark:text-gray-300">Student</th>
                  <th class="p-4 text-sm font-semibold text-gray-700 dark:text-gray-300">Subject</th>
                  <th class="p-4 text-sm font-semibold text-gray-700 dark:text-gray-300">Date</th>
                  <th class="p-4 text-sm font-semibold text-gray-700 dark:text-gray-300 text-center">Action</th>
                </tr>
              </thead>
              <tbody id="admin-inbox-list" class="divide-y divide-gray-100 dark:divide-gray-700">
                <tr><td colspan="5" style="text-align: center; color: #64748b; padding: 20px;">Loading messages...</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Batch Messaging Section -->
          <div class="border-t-2 border-dashed border-gray-200 dark:border-gray-700 pt-8 mt-4">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
              <div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                  <i class="fas fa-users text-brand-primary"></i> Batch Messaging
                </h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Send a message to multiple students simultaneously.</p>
              </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-800/50 p-5 rounded-xl border border-gray-100 dark:border-gray-700 flex flex-col gap-4">
              <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300">1. Filter Recipients</h4>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-group">
                  <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Status</label>
                  <select id="batch-status-filter" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                    <option value="all">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="pending">Pending</option>
                    <option value="inactive">Inactive</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Program</label>
                  <select id="batch-program-filter" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                    <option value="all">All Programs</option>
                    {% for p in programs %}
                    <option value="{{ p.program_name }}">{{ p.program_name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group">
                  <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Student Type</label>
                  <select id="batch-type-filter" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                    <option value="all">All Types</option>
                    <option value="High School">High School</option>
                    <option value="College">College</option>
                    <option value="Board Exam">Board Exam</option>
                  </select>
                </div>
              </div>

              <div class="pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3 mt-2">
                <button type="button" class="btn btn-primary bg-brand-primary hover:bg-brand-secondary text-white px-5 py-2.5 rounded-lg font-medium shadow transition-colors duration-200 flex items-center gap-2" onclick="openBatchComposeModal('email')">
                  <i class="fas fa-envelope"></i> Batch Email
                </button>
                <button type="button" class="btn bg-gray-600 hover:bg-gray-700 text-white px-5 py-2.5 rounded-lg font-medium shadow transition-colors duration-200 flex items-center gap-2" onclick="openBatchComposeModal('system')">
                  <i class="fas fa-comment-dots"></i> Batch System Message
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Admins Tab -->
      <div id="admins" class="tab-content animate-fade-in">
        <div class="grid grid-cols-1 gap-6 max-w-6xl mx-auto">
          
          <!-- Create Admin Card -->
          <div class="card tab-card animate-slide-up bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 w-full">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6">Create New Admin</h3>
            <div class="settings-section">
              <form id="create-admin-form" onsubmit="createAdmin(event)" class="space-y-4">
                <div class="form-group flex flex-col md:flex-row gap-4">
                  <div class="flex-1">
                    <label for="new_admin_username" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Username</label>
                    <input type="text" id="new_admin_username" name="new_admin_username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm" required>
                  </div>
                  <div class="flex-1">
                    <label for="new_admin_fullname" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Full Name</label>
                    <input type="text" id="new_admin_fullname" name="new_admin_fullname" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                  </div>
                </div>
                <div class="form-group flex flex-col md:flex-row gap-4">
                   <div class="flex-1">
                     <label for="new_admin_password" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Password</label>
                     <input type="password" id="new_admin_password" name="new_admin_password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm" required>
                   </div>
                   <div class="flex-1">
                     <label for="new_admin_confirm_password" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Confirm Password</label>
                     <input type="password" id="new_admin_confirm_password" name="new_admin_confirm_password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm" required>
                   </div>
                </div>
                <button type="submit" class="btn btn-primary bg-brand-primary text-white px-5 py-2.5 rounded-lg font-medium shadow hover:bg-brand-secondary transition-colors duration-200">Create Admin</button>
              </form>
            </div>
          </div>
          
          <!-- Change Password Card -->
          <div class="card tab-card animate-slide-up bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 w-full">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6">Change Password</h3>
            <div class="settings-section">
              <form id="change-password-form" onsubmit="changeAdminPassword(event)" class="space-y-4">
                <div class="form-group flex flex-col md:flex-row gap-4">
                  <div class="flex-1">
                    <label for="new_password" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">New Password</label>
                    <input type="password" id="new_password" name="new_password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm" required>
                  </div>
                  <div class="flex-1">
                    <label for="confirm_password" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Retype New Password</label>
                    <input type="password" id="confirm_password" name="confirm_password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm" required>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary bg-brand-primary text-white px-5 py-2.5 rounded-lg font-medium shadow hover:bg-brand-secondary transition-colors duration-200">Update Password</button>
              </form>
            </div>
          </div>
          
          <!-- Admin List Card -->
          <div class="card tab-card animate-slide-up bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 w-full">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6">Admin List</h3>
            <div class="overflow-x-auto overflow-y-auto max-h-[300px] relative rounded-lg border border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800">
              <table class="data-table w-full text-left border-collapse">
                <thead class="sticky top-0 bg-gray-50 dark:bg-gray-700/50 z-10 shadow-sm">
                  <tr class="border-b border-gray-200 dark:border-gray-700">
                    <th class="p-4 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700/50">Username</th>
                    <th class="p-4 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700/50">Full Name</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700 bg-white dark:bg-gray-800">
                  {% for a in admins_list %}
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <td class="p-4 text-sm text-gray-600 dark:text-gray-300 font-medium">{{ a.admin_name }}</td>
                    <td class="p-4 text-sm text-gray-600 dark:text-gray-300">{% if a.full_name %}{{ a.full_name }}{% else %}<span class="text-gray-400 italic">No name set</span>{% endif %}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="2" class="p-4 text-center text-gray-500">No admins found.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          
        </div>
      </div>

      <!-- Programs Tab Content -->
      <div id="programs" class="tab-content animate-fade-in">
        <div class="card tab-card animate-slide-up bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
          <div class="card-header flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Program Management</h3>
            <button class="btn btn-primary bg-brand-primary text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-brand-secondary transition-colors duration-200" onclick="showCreateProgram()">
              <i class="fas fa-plus"></i> Create New Program
            </button>
          </div>

          <div id="createProgramForm" class="program-form-wrapper bg-gray-50 dark:bg-gray-800 p-6 rounded-lg border border-gray-200 dark:border-gray-700 mb-8 max-w-3xl" style="display: none;">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200 dark:border-gray-700">
              <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200">New Program Details</h4>
              <button type="button" class="text-gray-500 hover:text-gray-800 dark:hover:text-white" onclick="hideCreateProgram()"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form class="program-form space-y-4" method="POST" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="form-group">
                <label for="p_name" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Program Name</label>
                <input id="p_name" name="program_name" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm" required>
              </div>

              <div class="form-group">
                <label for="p_type" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Program Type</label>
                <select id="p_type" name="program_type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm bg-white dark:bg-gray-700" required>
                  <option value="Financial Assistance">Financial Assistance</option>
                  <option value="Scholarship">Scholarship</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div class="form-group">
                <label for="p_req" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Description</label>
                <textarea id="p_req" name="requirements" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm"></textarea>
              </div>

              <div class="form-group mt-4">
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Required Documents</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 bg-white dark:bg-gray-700 p-3 rounded-lg border border-gray-300 dark:border-gray-600">
                    <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300"><input type="checkbox" name="document_requirements" value="School ID (Current Semester)" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"><span>School ID (Current Semester)</span></label>
                    <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300"><input type="checkbox" name="document_requirements" value="Valid ID" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"><span>Valid ID</span></label>
                    <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300"><input type="checkbox" name="document_requirements" value="TOR" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"><span>TOR</span></label>
                    <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300"><input type="checkbox" name="document_requirements" value="Voter's Certificate" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"><span>Voter's Certificate</span></label>
                    <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300"><input type="checkbox" name="document_requirements" value="Certificate of Indigency" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"><span>Certificate of Indigency</span></label>
                    <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300"><input type="checkbox" name="document_requirements" value="Letter of Application" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"><span>Letter of Application</span></label>
                    <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300"><input type="checkbox" name="document_requirements" value="Other" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"><span>Other</span></label>
                </div>
              </div>

              <div class="form-group grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="p_start" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Start Date</label>
                  <input id="p_start" name="application_start_date" type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm" required>
                </div>
                <div>
                  <label for="p_end" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">End Date</label>
                  <input id="p_end" name="application_end_date" type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm" required>
                </div>
              </div>

              <div class="form-group">
                <label for="p_img" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Background Image</label>
                <input id="p_img" name="program_image" type="file" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-primary file:text-white hover:file:bg-brand-secondary">
              </div>

              <div class="form-actions pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
                <button type="button" class="px-5 py-2 rounded-lg font-medium text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 transition duration-300 border border-gray-300 dark:border-gray-600" onclick="hideCreateProgram()">Cancel</button>
                <button type="submit" class="btn btn-primary bg-brand-primary text-white px-5 py-2 rounded-lg font-medium shadow hover:bg-brand-secondary transition-colors duration-200">Create Program</button>
              </div>
            </form>
          </div>

          <div class="programs-list grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Programs will load here -->
          </div>
        </div>
      </div>


      <!-- Reports Tab -->
      <div id="reports" class="tab-content animate-fade-in">
        <div class="card tab-card animate-slide-up bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
          <div class="card-header flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Generate Reports</h3>
          </div>

          <div class="report-filters-container bg-white dark:bg-gray-800 p-6 rounded-2xl border border-gray-200 dark:border-gray-700 mb-8 shadow-sm">
            
            <!-- Search Control Rows -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-5 items-end">
              <div class="form-group w-full mb-0">
                <label for="report-type" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Report Type</label>
                <select id="report-type" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm shadow-sm transition-shadow" onchange="toggleReportFilters()">
                  <option value="students">Students</option>
                  <option value="applications">Program Applications</option>
                </select>
              </div>

              <div class="form-group w-full mb-0">
                <label for="report-status" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Status Category</label>
                <select id="report-status" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm shadow-sm transition-shadow">
                  <option value="all">All Statuses</option>
                  <option value="active">Active</option>
                  <option value="pending">Pending</option>
                  <option value="rejected">Rejected</option>
                  <option value="submitted">Submitted (Applications)</option>
                  <option value="approved">Approved (Applications)</option>
                </select>
              </div>

              <div class="form-group w-full mb-0">
                <label for="report-start-date" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Start Date</label>
                <input type="date" id="report-start-date" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm shadow-sm transition-shadow">
              </div>

              <div class="form-group w-full mb-0">
                <label for="report-end-date" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">End Date</label>
                <input type="date" id="report-end-date" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm shadow-sm transition-shadow">
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6 items-end">
              <div class="form-group w-full mb-0" id="report-program-filter" style="display: none;">
                <label for="report-program" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Program Selection</label>
                <select id="report-program" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm shadow-sm transition-shadow">
                  <option value="all">All Programs</option>
                  {% for program in programs %}
                  <option value="{{ program.program_id }}">{{ program.program_name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group w-full flex-1 mb-0">
                <label for="report-barangay" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Barangay Match</label>
                <select id="report-barangay" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm shadow-sm transition-shadow">
                  <option value="all">All Barangays</option>
                  <option value="Aningway-Sacatihan">Aningway-Sacatihan</option>
                  <option value="Asinan (Poblacion)">Asinan (Poblacion)</option>
                  <option value="Asinan Proper">Asinan Proper</option>
                  <option value="Baraca-Camachile (Poblacion)">Baraca-Camachile (Poblacion)</option>
                  <option value="Batiawan">Batiawan</option>
                  <option value="Calapacuan">Calapacuan</option>
                  <option value="Calapandayan (Poblacion)">Calapandayan (Poblacion)</option>
                  <option value="Cawag">Cawag</option>
                  <option value="Ilwas (Poblacion)">Ilwas (Poblacion)</option>
                  <option value="Mangan-Vaca">Mangan-Vaca</option>
                  <option value="Matain">Matain</option>
                  <option value="Naugsol">Naugsol</option>
                  <option value="Pamatawan">Pamatawan</option>
                  <option value="San Isidro">San Isidro</option>
                  <option value="Santo Tomas">Santo Tomas</option>
                  <option value="Wawandue (Poblacion)">Wawandue (Poblacion)</option>
                </select>
              </div>

              <div class="form-group w-full flex-1 mb-0">
                <label for="report-school" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">School Match</label>
                <input type="text" id="report-school" placeholder="e.g. Subic National High School" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm shadow-sm transition-shadow">
              </div>
            </div>

            <!-- Fields Container -->
            <div class="form-group w-full mb-6 bg-gray-50 dark:bg-gray-700/40 p-5 rounded-xl border border-gray-200 dark:border-gray-600 shadow-inner">
              <label class="block text-sm font-bold text-gray-800 dark:text-white mb-4"><i class="fas fa-list-check text-brand-primary mr-2"></i>Fields to Include in Data Export</label>
              <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <label class="inline-flex items-center p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-colors cursor-pointer border border-transparent hover:border-gray-300 dark:hover:border-gray-500 shadow-sm hover:shadow">
                  <input type="checkbox" name="report-fields" value="id" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary dark:bg-gray-600 dark:border-gray-500">
                  <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">ID</span>
                </label>
                <label class="inline-flex items-center p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-colors cursor-pointer border border-transparent hover:border-gray-300 dark:hover:border-gray-500 shadow-sm hover:shadow" id="label-rf-username">
                  <input type="checkbox" name="report-fields" value="username" checked id="rf-username" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary dark:bg-gray-600 dark:border-gray-500">
                  <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">Username</span>
                </label>
                <label class="inline-flex items-center p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-colors cursor-pointer border border-transparent hover:border-gray-300 dark:hover:border-gray-500 shadow-sm hover:shadow">
                  <input type="checkbox" name="report-fields" value="name" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary dark:bg-gray-600 dark:border-gray-500">
                  <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">Name</span>
                </label>
                <label class="inline-flex items-center p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-colors cursor-pointer border border-transparent hover:border-gray-300 dark:hover:border-gray-500 shadow-sm hover:shadow" id="label-rf-email">
                  <input type="checkbox" name="report-fields" value="email" checked id="rf-email" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary dark:bg-gray-600 dark:border-gray-500">
                  <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">Email</span>
                </label>
                <label class="inline-flex items-center p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-colors cursor-pointer border border-transparent hover:border-gray-300 dark:hover:border-gray-500 shadow-sm hover:shadow">
                  <input type="checkbox" name="report-fields" value="program" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary dark:bg-gray-600 dark:border-gray-500">
                  <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">Program</span>
                </label>
                <label class="inline-flex items-center p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-colors cursor-pointer border border-transparent hover:border-gray-300 dark:hover:border-gray-500 shadow-sm hover:shadow">
                  <input type="checkbox" name="report-fields" value="status" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary dark:bg-gray-600 dark:border-gray-500">
                  <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">Status</span>
                </label>
                <label class="inline-flex items-center p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-colors cursor-pointer border border-transparent hover:border-gray-300 dark:hover:border-gray-500 shadow-sm hover:shadow">
                  <input type="checkbox" name="report-fields" value="date" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary dark:bg-gray-600 dark:border-gray-500">
                  <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">Date</span>
                </label>
                <label class="inline-flex items-center p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-colors cursor-pointer border border-transparent hover:border-gray-300 dark:hover:border-gray-500 shadow-sm hover:shadow">
                  <input type="checkbox" name="report-fields" value="barangay" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary dark:bg-gray-600 dark:border-gray-500">
                  <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">Barangay</span>
                </label>
                <label class="inline-flex items-center p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-colors cursor-pointer border border-transparent hover:border-gray-300 dark:hover:border-gray-500 shadow-sm hover:shadow">
                  <input type="checkbox" name="report-fields" value="school" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary dark:bg-gray-600 dark:border-gray-500">
                  <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">School</span>
                </label>
              </div>
            </div>

            <div class="form-actions w-full flex flex-wrap gap-4 pt-4 border-t border-gray-100 dark:border-gray-700 lg:justify-end">
              <button class="btn btn-primary bg-brand-primary text-white px-6 py-3 rounded-xl text-sm font-semibold shadow hover:bg-brand-secondary transition-colors w-full sm:w-auto flex items-center justify-center gap-2" onclick="generateReport()">
                <i class="fas fa-table text-lg"></i>
                Generate Table
              </button>
              <button class="btn btn-success bg-green-500 text-white px-6 py-3 rounded-xl text-sm font-semibold shadow hover:bg-green-600 transition-colors w-full sm:w-auto flex items-center justify-center gap-2 flex-1 md:flex-none" onclick="exportReport('csv')">
                <i class="fas fa-file-csv text-lg"></i>
                Export CSV
              </button>
              <button class="btn btn-info bg-cyan-500 text-white px-6 py-3 rounded-xl text-sm font-semibold shadow hover:bg-cyan-600 transition-colors w-full sm:w-auto flex items-center justify-center gap-2 flex-1 md:flex-none" onclick="exportReport('word')">
                <i class="fas fa-file-word text-lg"></i>
                Export Word
              </button>
            </div>
          </div>

          <div class="report-results overflow-x-auto rounded-lg border border-gray-100 dark:border-gray-700 mt-6">
            <table class="data-table w-full text-left border-collapse" id="report-table" style="display: none;">
              <thead>
                <tr class="bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700">
                  <!-- Headers will be populated by JS -->
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 dark:divide-gray-700 bg-white dark:bg-gray-800">
                <!-- Data will be populated by JS -->
              </tbody>
            </table>
            <p id="no-data-message" class="text-center text-gray-500 dark:text-gray-400 py-8" style="display: none;">No data found for the selected criteria.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Reply Modal -->
  <div id="admin-reply-modal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
    <div class="modal-content !max-w-2xl bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full mx-4 max-h-[90vh] overflow-y-auto relative">
      <div class="modal-header flex justify-between items-center mb-6 pb-4 border-b border-gray-100 dark:border-gray-700">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white m-0">Reply to Ticket</h3>
        <span class="close text-gray-400 hover:text-gray-600 dark:hover:text-white text-2xl cursor-pointer transition-colors" onclick="closeAdminReplyModal()">&times;</span>
      </div>
      
      <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg mb-6 border border-gray-100 dark:border-gray-700">
        <div class="flex gap-4 items-start">
          <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-lg flex-shrink-0" id="admin-reply-avatar">S</div>
          <div class="flex-1 min-w-0">
            <div class="flex flex-wrap items-baseline justify-between gap-2 mb-1">
              <strong class="text-gray-900 dark:text-white font-semibold truncate" id="admin-reply-sender">Student Name</strong>
              <small class="text-gray-500 dark:text-gray-400 text-xs" id="admin-reply-date">Date Time</small>
            </div>
            <strong class="text-gray-700 dark:text-gray-200 block mb-2 text-sm" id="admin-reply-subject">Subject</strong>
            <p class="text-gray-600 dark:text-gray-300 text-sm whitespace-pre-wrap leading-relaxed m-0" id="admin-reply-body">Message body...</p>
          </div>
        </div>
      </div>
      
      <form id="admin-reply-form" onsubmit="handleAdminReplySubmit(event)">
        <input type="hidden" id="admin-reply-student-id">
        <div id="admin-reply-msg" style="display: none;" class="mb-4 p-3 rounded-lg text-sm font-medium"></div>
        
        <div class="form-group mb-6">
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Your Reply</label>
          <textarea id="admin-reply-text" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm resize-y" required placeholder="Type your reply here..."></textarea>
        </div>
        
        <div class="flex justify-end gap-3 pt-4 border-t border-gray-100 dark:border-gray-700">
          <button type="button" class="px-5 py-2.5 rounded-lg font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition duration-300" onclick="closeAdminReplyModal()">Cancel</button>
          <button type="submit" class="btn btn-primary bg-brand-primary text-white px-5 py-2.5 rounded-lg font-medium shadow hover:bg-brand-secondary transition-colors duration-200 flex items-center gap-2" id="adminReplyBtn">
             <i class="fas fa-paper-plane"></i> Send Reply
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Popup Modal -->
  <div id="popup-modal" class="modal" style="display: none;">
    <div class="modal-content !max-w-xl bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl">
      <div class="modal-header flex justify-between items-center mb-6 border-b border-gray-100 dark:border-gray-700 pb-4">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="modal-title">Create New Popup</h3>
        <span class="close text-gray-400 hover:text-gray-600 dark:hover:text-white text-2xl cursor-pointer" onclick="closePopupModal()">&times;</span>
      </div>
      <form id="popup-form" class="space-y-4">
        <input type="hidden" id="popup-id" name="popup_id">
        <div class="form-group">
          <label for="popup-title" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Title:</label>
          <input type="text" id="popup-title" name="title" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm" required>
        </div>
        <div class="form-group">
          <label for="popup-message" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Message:</label>
          <textarea id="popup-message" name="message" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm" required></textarea>
        </div>
        <div class="form-group">
          <label for="popup-type" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Type:</label>
          <select id="popup-type" name="popup_type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
            <option value="info">Information</option>
            <option value="warning">Warning</option>
            <option value="success">Success</option>
            <option value="error">Error</option>
          </select>
        </div>
        <div class="form-group">
          <label for="popup-expires" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Expires At (optional):</label>
          <input type="datetime-local" id="popup-expires" name="expires_at" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm block">
        </div>
        <div class="form-group flex items-center gap-2 mt-2">
          <input type="checkbox" id="popup-active" name="is_active" class="w-4 h-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary dark:focus:ring-brand-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" checked>
          <label for="popup-active" class="text-sm font-medium text-gray-700 dark:text-gray-300">Active</label>
        </div>
        <div class="flex justify-end gap-3 pt-6 mt-6 border-t border-gray-100 dark:border-gray-700">
          <button type="button" class="px-5 py-2.5 rounded-lg font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition duration-300" onclick="closePopupModal()">Cancel</button>
          <button type="submit" class="btn btn-primary bg-brand-primary text-white px-5 py-2.5 rounded-lg font-medium shadow hover:bg-brand-secondary transition-colors duration-200">Save Popup</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Message Choice Modal -->
  <div id="message-choice-modal" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 sm:p-6 w-full h-full" style="display: none; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);">
    <div class="relative bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl flex flex-col w-full max-w-sm mx-auto animate-slide-up overflow-hidden text-center">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Send Message</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">How would you like to message this student?</p>
      
      <div class="flex flex-col gap-3">
        <button class="w-full py-3 px-4 bg-brand-primary hover:bg-brand-secondary text-white rounded-lg font-medium transition flex items-center justify-center gap-2" onclick="openComposeModal('email')">
            <i class="fas fa-envelope"></i> Message via Email
        </button>
        <button class="w-full py-3 px-4 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-white rounded-lg font-medium transition flex items-center justify-center gap-2 border border-gray-200 dark:border-gray-600" onclick="openComposeModal('system')">
            <i class="fas fa-comment-dots"></i> Message via System
        </button>
        <button class="mt-2 text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" onclick="document.getElementById('message-choice-modal').style.display='none'">
            Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Compose Message Modal -->
  <div id="compose-message-modal" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 sm:p-6 w-full h-full" style="display: none; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);">
    <div class="relative bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl flex flex-col w-full max-w-4xl max-h-[90vh] mx-auto animate-slide-up overflow-hidden">
      
      <div class="flex justify-between items-center mb-4 border-b border-gray-100 dark:border-gray-700 pb-3">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2" id="compose-modal-title">
          <i class="fas fa-paper-plane text-brand-primary"></i> Compose Message
        </h3>
        <button class="text-gray-400 hover:text-gray-600 dark:hover:text-white transition-colors" onclick="closeComposeModal()">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div class="overflow-y-auto custom-scrollbar flex-1 pr-2">
        <form id="compose-message-form" class="space-y-4">
          <input type="hidden" id="compose-mode" value=""> <!-- 'email', 'system', 'batch_email', 'batch_system' -->
          <input type="hidden" id="compose-student-id" value="">
          
          <div class="form-group grid grid-cols-[80px_1fr] items-center gap-2 border-b border-gray-100 dark:border-gray-700 pb-3">
            <label class="text-sm font-semibold text-gray-500 dark:text-gray-400">To:</label>
            <div id="compose-recipient-display" class="font-medium text-gray-800 dark:text-gray-200">Student Name</div>
          </div>

          <div class="form-group grid grid-cols-[80px_1fr] items-center gap-2">
            <label for="compose-subject" class="text-sm font-semibold text-gray-500 dark:text-gray-400">Subject:</label>
            <input type="text" id="compose-subject" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm outline-none" placeholder="Enter subject line..." required>
          </div>

          <div class="form-group flex flex-col gap-1 h-[300px]">
            <label class="text-sm font-semibold text-gray-500 dark:text-gray-400 hidden">Message:</label>
            <!-- Quill Editor Container -->
            <div id="compose-editor-container" class="h-full rounded-b-lg border border-t-0 border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200"></div>
          </div>

          <div class="form-group mt-12 pt-2" id="compose-attachment-group">
            <label for="compose-attachment" class="flex items-center gap-2 cursor-pointer text-brand-primary hover:text-brand-secondary text-sm font-medium transition-colors w-max">
              <i class="fas fa-paperclip"></i> Attach File (Image/PDF)
            </label>
            <input type="file" id="compose-attachment" class="hidden" accept="image/*,.pdf">
            <div id="compose-attachment-name" class="text-xs text-gray-500 mt-1 hidden max-w-xs truncate"></div>
          </div>
        </form>
      </div>

      <div class="pt-4 mt-4 border-t border-gray-100 dark:border-gray-700 flex justify-end gap-3">
        <button type="button" class="px-5 py-2 rounded-lg font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition duration-300" onclick="closeComposeModal()">Cancel</button>
        <button type="button" class="px-6 py-2 rounded-lg font-medium text-white bg-brand-primary hover:bg-brand-secondary transition duration-300 shadow-sm flex items-center gap-2" id="compose-send-btn" onclick="sendComposedMessage()">
          <i class="fas fa-paper-plane"></i> Send
        </button>
      </div>

    </div>
  </div>


  <script>
    function toggleProfileDropdown(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('profile-dropdown');
      const chevron = document.getElementById('profile-chevron');
      if(dropdown && chevron) {
        dropdown.classList.toggle('hidden');
        dropdown.classList.toggle('flex');
        chevron.classList.toggle('rotate-180');
      }
    }

    // Close Dropdown when clicking outside
    document.addEventListener('click', (event) => {
      const dropdown = document.getElementById('profile-dropdown');
      const chevron = document.getElementById('profile-chevron');
      const profileCard = document.querySelector('.profile-card');
      if (dropdown && profileCard && !profileCard.contains(event.target)) {
        dropdown.classList.add('hidden');
        dropdown.classList.remove('flex');
        chevron.classList.remove('rotate-180');
      }
    });

    // Theme toggle
    document.addEventListener('DOMContentLoaded', () => {
      const themeToggleBtn = document.getElementById('theme-toggle');
      if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', () => {
          document.body.classList.toggle('dark-mode');
          document.documentElement.classList.toggle('dark');
          const icon = themeToggleBtn.querySelector('i');
          if (document.body.classList.contains('dark-mode')) {
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
            localStorage.setItem('theme', 'dark');
          } else {
            icon.classList.remove('fa-sun');
            icon.classList.add('fa-moon');
            localStorage.setItem('theme', 'light');
          }
        });
        // Check initial theme
        if (localStorage.getItem('theme') === 'dark') {
          document.body.classList.add('dark-mode');
          document.documentElement.classList.add('dark');
          const icon = themeToggleBtn.querySelector('i');
          if (icon) {
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
          }
        }
      }
    });

    // Tab switching functionality
    document.addEventListener('DOMContentLoaded', function () {
      const tabs = document.querySelectorAll('.nav-link, .nav-item');
      const contents = document.querySelectorAll('.tab-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          e.preventDefault();

          // Remove active class from all tabs
          tabs.forEach(t => t.classList.remove('active'));

          // Hide all content sections
          contents.forEach(c => c.classList.remove('active'));

          // Add active class to clicked tab
          tab.classList.add('active');

          // Show corresponding content
          const targetId = tab.getAttribute('data-tab');
          document.getElementById(targetId)?.classList.add('active');

          // Lazy-load data when tab is opened
          if (targetId === 'student-registrations') {
            loadStudentRegistrations();
          } else if (targetId === 'student-applications') {
            loadProgramApplications();
          } else if (targetId === 'notifications') {
            loadPopups();
          } else if (targetId === 'dashboard') {
            loadDashboardStats();
          } else if (targetId === 'programs') {
            loadPrograms();
          } else if (targetId === 'students') {
            loadStudents();
          }
        });
      });

      // Initial loads
      loadDashboardStats();
      initChart();
      initStudentChart();
      // Preload student registrations so it's ready when tab opens
      loadStudentRegistrations();

      // Initialize report filters visibility
      toggleReportFilters();
    });

    // Report Functions
    function toggleReportFilters() {
      const type = document.getElementById('report-type').value;
      const programFilter = document.getElementById('report-program-filter');
      const statusSelect = document.getElementById('report-status');

      // Show/Hide Program filter
      if (type === 'applications') {
        programFilter.style.display = 'block';
        document.getElementById('label-rf-username').style.display = 'none';
        document.getElementById('label-rf-email').style.display = 'none';

        // Update status options for applications
        statusSelect.innerHTML = `
                <option value="all">All Statuses</option>
                <option value="submitted">Submitted</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
            `;
      } else {
        programFilter.style.display = 'none';
        document.getElementById('label-rf-username').style.display = '';
        document.getElementById('label-rf-email').style.display = '';

        // Update status options for students
        statusSelect.innerHTML = `
                <option value="all">All Statuses</option>
                <option value="active">Active</option>
                <option value="pending">Pending</option>
                <option value="rejected">Rejected</option>
                <option value="inactive">Inactive</option>
            `;
      }
    }

    function generateReport() {
      const type = document.getElementById('report-type').value;
      const startDate = document.getElementById('report-start-date').value;
      const endDate = document.getElementById('report-end-date').value;
      const status = document.getElementById('report-status').value;
      const program = document.getElementById('report-program').value;
      const barangay = document.getElementById('report-barangay').value;
      const school = document.getElementById('report-school').value;

      let queryParams = new URLSearchParams({
        type: type,
        start_date: startDate,
        end_date: endDate,
        status: status,
        barangay: barangay,
        school: school
      });

      if (type === 'applications') {
        queryParams.append('program', program);
      }

      const fields = Array.from(document.querySelectorAll('input[name="report-fields"]:checked')).map(cb => cb.value);
      if (fields.length > 0) {
        queryParams.append('fields', fields.join(','));
      }

      fetch(`/api/admin/reports/?${queryParams.toString()}`)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            Swal.fire('Error', 'Error generating report: ' + data.error, 'error');
            return;
          }
          renderReportTable(data.data, type, fields);
        })
        .catch(error => {
          console.error('Error:', error);
          Swal.fire('Error', 'An error occurred while generating the report.', 'error');
        });
    }

    function renderReportTable(data, type, selectedFields) {
      const table = document.getElementById('report-table');
      const thead = table.querySelector('thead tr');
      const tbody = table.querySelector('tbody');
      const noDataMsg = document.getElementById('no-data-message');

      thead.innerHTML = '';
      tbody.innerHTML = '';

      if (!data || data.length === 0) {
        table.style.display = 'none';
        noDataMsg.style.display = 'block';
        return;
      }

      table.style.display = 'table';
      noDataMsg.style.display = 'none';

      if (!selectedFields || selectedFields.length === 0) {
        selectedFields = ['id', 'username', 'name', 'email', 'program', 'status', 'date', 'barangay', 'school'];
      }

      // Set Headers
      let headers = [];
      if (type === 'students') {
        if (selectedFields.includes('id')) headers.push('Student ID');
        if (selectedFields.includes('username')) headers.push('Username');
        if (selectedFields.includes('name')) headers.push('Name');
        if (selectedFields.includes('email')) headers.push('Email');
        if (selectedFields.includes('program')) headers.push('Program');
        if (selectedFields.includes('barangay')) headers.push('Barangay');
        if (selectedFields.includes('school')) headers.push('School');
        if (selectedFields.includes('status')) headers.push('Status');
        if (selectedFields.includes('date')) headers.push('Date Joined');
      } else {
        if (selectedFields.includes('id')) headers.push('App ID');
        if (selectedFields.includes('name')) headers.push('Student');
        if (selectedFields.includes('program')) headers.push('Program');
        if (selectedFields.includes('barangay')) headers.push('Barangay');
        if (selectedFields.includes('school')) headers.push('School');
        if (selectedFields.includes('status')) headers.push('Status');
        if (selectedFields.includes('date')) headers.push('Date Submitted');
      }

      headers.forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        th.style.padding = '12px';
        th.style.textAlign = 'left';
        th.style.fontWeight = '600';
        thead.appendChild(th);
      });

      // Set Rows
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #e9ecef';

        let cells = [];
        if (type === 'students') {
           if (selectedFields.includes('id')) cells.push(row.id);
           if (selectedFields.includes('username')) cells.push(row.username);
           if (selectedFields.includes('name')) cells.push(`${row.first_name} ${row.last_name}`);
           if (selectedFields.includes('email')) cells.push(row.email);
           if (selectedFields.includes('program')) cells.push(row.program);
           if (selectedFields.includes('barangay')) cells.push(row.barangay || 'N/A');
           if (selectedFields.includes('school')) cells.push(row.school || 'N/A');
           if (selectedFields.includes('status')) cells.push(`<span class="badge badge-${row.status.toLowerCase()}">${row.status}</span>`);
           if (selectedFields.includes('date')) cells.push(row.created_at);
        } else {
           if (selectedFields.includes('id')) cells.push(row.id);
           if (selectedFields.includes('name')) cells.push(row.student);
           if (selectedFields.includes('program')) cells.push(row.program);
           if (selectedFields.includes('barangay')) cells.push(row.barangay || 'N/A');
           if (selectedFields.includes('school')) cells.push(row.school || 'N/A');
           if (selectedFields.includes('status')) cells.push(`<span class="badge badge-${row.status.toLowerCase()}">${row.status}</span>`);
           if (selectedFields.includes('date')) cells.push(row.created_at);
        }

        cells.forEach(cellContent => {
          const td = document.createElement('td');
          td.innerHTML = cellContent; // Use innerHTML for badge spans
          td.style.padding = '12px';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function exportReport(format = 'csv') {
      const type = document.getElementById('report-type').value;
      const startDate = document.getElementById('report-start-date').value;
      const endDate = document.getElementById('report-end-date').value;
      const status = document.getElementById('report-status').value;
      const program = document.getElementById('report-program').value;
      const barangay = document.getElementById('report-barangay').value;
      const school = document.getElementById('report-school').value;

      let queryParams = new URLSearchParams({
        type: type,
        start_date: startDate,
        end_date: endDate,
        status: status,
        barangay: barangay,
        school: school,
        export: format
      });

      if (type === 'applications') {
        queryParams.append('program', program);
      }

      const fields = Array.from(document.querySelectorAll('input[name="report-fields"]:checked')).map(cb => cb.value);
      if (fields.length > 0) {
        queryParams.append('fields', fields.join(','));
      }

      // Trigger download
      window.location.href = `/api/admin/reports/?${queryParams.toString()}`;
    }

    // Program form toggle functions
    function showCreateProgram() {
      document.getElementById('createProgramForm').style.display = 'block';
    }

    function hideCreateProgram() {
      document.getElementById('createProgramForm').style.display = 'none';
    }
    // Popup management functions
    function loadPopups() {
      fetch('/admin/popups/')
        .then(response => response.json())
        .then(data => {
          const popupList = document.getElementById('popup-list');
          popupList.innerHTML = '';

          if (data.popups.length === 0) {
            popupList.innerHTML = '<p class="no-popups">No popups found.</p>';
            return;
          }

          data.popups.forEach(popup => {
            const popupElement = createPopupElement(popup);
            popupList.appendChild(popupElement);
          });
        })
        .catch(error => {
          console.error('Error loading popups:', error);
          document.getElementById('popup-list').innerHTML = '<p class="error">Error loading popups.</p>';
        });
    }

    function createPopupElement(popup) {
      const div = document.createElement('div');
      div.className = `popup-item popup-${popup.popup_type} ${popup.is_active ? 'active' : 'inactive'}`;
      div.innerHTML = `
        <div class="popup-header">
          <h4>${popup.title}</h4>
          <div class="popup-actions">
            <button class="btn btn-sm btn-secondary" onclick="editPopup(${popup.id})">Edit</button>
            <button class="btn btn-sm ${popup.is_active ? 'btn-warning' : 'btn-success'}" onclick="togglePopup(${popup.id})">
              ${popup.is_active ? 'Deactivate' : 'Activate'}
            </button>
            <button class="btn btn-sm btn-danger" onclick="deletePopup(${popup.id})">Delete</button>
          </div>
        </div>
        <div class="popup-content">
          <p>${popup.message}</p>
          <div class="popup-meta">
            <span class="popup-type">${popup.popup_type}</span>
            <span class="popup-date">Created: ${new Date(popup.created_at).toLocaleDateString()}</span>
            ${popup.expires_at ? `<span class="popup-expires">Expires: ${new Date(popup.expires_at).toLocaleDateString()}</span>` : ''}
          </div>
        </div>
      `;
      return div;
    }

    function openPopupModal(popupId = null) {
      const modal = document.getElementById('popup-modal');
      const form = document.getElementById('popup-form');
      const title = document.getElementById('modal-title');

      if (popupId) {
        title.textContent = 'Edit Popup';
        // Load popup data for editing
        fetch(`/api/admin/popups/${popupId}/`)
          .then(response => response.json())
          .then(data => {
            document.getElementById('popup-id').value = data.id;
            document.getElementById('popup-title').value = data.title;
            document.getElementById('popup-message').value = data.message;
            document.getElementById('popup-type').value = data.popup_type;
            document.getElementById('popup-active').checked = data.is_active;
            if (data.expires_at) {
              document.getElementById('popup-expires').value = new Date(data.expires_at).toISOString().slice(0, 16);
            }
          });
      } else {
        title.textContent = 'Create New Popup';
        form.reset();
        document.getElementById('popup-id').value = '';
      }

      modal.style.display = 'block';
    }

    function closePopupModal() {
      document.getElementById('popup-modal').style.display = 'none';
    }

    function editPopup(popupId) {
      openPopupModal(popupId);
    }

    function togglePopup(popupId) {
      fetch(`/api/admin/popups/${popupId}/toggle/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
          'Content-Type': 'application/json',
        },
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            loadPopups();
          } else {
            Swal.fire('Error', 'Error toggling popup: ' + data.error, 'error');
          }
        });
    }

    function createAdmin(event) {
      event.preventDefault();
      
      const new_admin_username = document.getElementById('new_admin_username').value;
      const new_admin_fullname = document.getElementById('new_admin_fullname').value;
      const new_admin_password = document.getElementById('new_admin_password').value;
      const new_admin_confirm_password = document.getElementById('new_admin_confirm_password').value;

      if (new_admin_password !== new_admin_confirm_password) {
        Swal.fire('Error', 'Passwords do not match!', 'error');
        return;
      }

      const btn = event.target.querySelector('button[type="submit"]');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
      btn.disabled = true;

      fetch('/api/admin/create-admin/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify({
          username: new_admin_username,
          full_name: new_admin_fullname,
          password: new_admin_password,
          confirm_password: new_admin_confirm_password
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire({
            title: 'Success!',
            text: 'Admin created successfully!',
            icon: 'success',
            confirmButtonColor: '#10B981'
          }).then(() => {
            window.location.reload();
          });
        } else {
          Swal.fire('Error', 'Error: ' + data.error, 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'An error occurred during admin creation.', 'error');
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
    }

    function changeAdminPassword(event) {
      event.preventDefault();

      const newPassword = document.getElementById('new_password').value;
      const confirmPassword = document.getElementById('confirm_password').value;

      if (newPassword !== confirmPassword) {
        Swal.fire('Error', 'Passwords do not match!', 'error');
        return;
      }

      fetch('/api/admin/change-password/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify({
          new_password: newPassword,
          confirm_password: confirmPassword
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              title: 'Success!',
              text: data.message,
              icon: 'success',
              confirmButtonColor: '#10B981'
            });
            document.getElementById('change-password-form').reset();
          } else {
            Swal.fire('Error', data.error, 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          Swal.fire('Error', 'An error occurred while changing the password.', 'error');
        });
    }

    function deletePopup(popupId) {
      Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#10B981',
        cancelButtonColor: '#ef4444',
        confirmButtonText: 'Yes, delete it!'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/api/admin/popups/${popupId}/delete/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json',
            },
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                loadPopups();
                Swal.fire('Deleted!', 'The popup has been deleted.', 'success');
              } else {
                Swal.fire('Error', 'Error deleting popup: ' + data.error, 'error');
              }
            });
        }
      });
    }

    function filterPopups() {
      const filter = document.getElementById('popup-filter').value;
      const popupItems = document.querySelectorAll('.popup-item');

      popupItems.forEach(item => {
        if (filter === 'all') {
          item.style.display = 'block';
        } else if (filter === 'active') {
          item.style.display = item.classList.contains('active') ? 'block' : 'none';
        } else if (filter === 'inactive') {
          item.style.display = item.classList.contains('inactive') ? 'block' : 'none';
        } else {
          item.style.display = item.classList.contains(`popup-${filter}`) ? 'block' : 'none';
        }
      });
    }

    function loadDashboardStats() {
      console.log('Loading dashboard stats...');
      fetch('/api/admin/stats/', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
      })
        .then(response => {
          console.log('Stats response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Stats data:', data);
          document.getElementById('total-students').textContent = data.total_students || 0;
          document.getElementById('active-popups').textContent = data.active_popups || 0;
          document.getElementById('pending-applications').textContent = data.pending_program_applications || 0;
          document.getElementById('total-programs').textContent = data.total_programs || 0;

          // Update Badges
          updateBadge('badge-registrations', data.pending_student_registrations);
          updateBadge('badge-applications', data.pending_program_applications);
          updateBadge('badge-notifications', data.active_popups);
          updateBadge('badge-inbox', data.unread_messages);
        })
        .catch(error => {
          console.error('Error loading stats:', error);
        });
    }

    function updateBadge(elementId, count) {
      const badge = document.getElementById(elementId);
      if (badge) {
        badge.textContent = count || 0;
        if (count > 0) {
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    // Chart functionality
    let applicationsChart = null;
    let studentChart = null;

    function initChart() {
      const ctx = document.getElementById('applicationsChart').getContext('2d');
      fetchApplicationTrends(30, ctx);
    }

    function updateChart() {
      const period = document.getElementById('chart-period').value;
      fetchApplicationTrends(period);
    }

    function fetchApplicationTrends(days, ctx = null) {
      fetch(`/api/admin/charts/application-trends/?period=${days}`)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error('Error fetching application trends:', data.error);
            return;
          }

          if (ctx) {
            // Initialize Chart
            applicationsChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: data.labels,
                datasets: [{
                  label: 'Applications',
                  data: data.data,
                  borderColor: '#10B981',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  pointBackgroundColor: '#10B981',
                  pointBorderColor: '#F59E0B',
                  pointBorderWidth: 2,
                  pointRadius: 5,
                  pointHoverRadius: 7
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: {
                      color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                      stepSize: 1
                    }
                  },
                  x: {
                    grid: {
                      display: false
                    }
                  }
                },
                elements: {
                  point: {
                    hoverBackgroundColor: '#764ba2'
                  }
                }
              }
            });
          } else if (applicationsChart) {
            // Update Chart
            applicationsChart.data.labels = data.labels;
            applicationsChart.data.datasets[0].data = data.data;
            applicationsChart.update();
          }
        })
        .catch(error => console.error('Error:', error));
    }

    function initStudentChart() {
      const ctx = document.getElementById('studentChart').getContext('2d');
      fetchStudentStats('status', ctx);
    }

    function updateStudentChart() {
      const chartType = document.getElementById('student-chart-type').value;
      fetchStudentStats(chartType);
    }

    function fetchStudentStats(type, ctx = null) {
      fetch(`/api/admin/charts/student-statistics/?type=${type}`)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error('Error fetching student stats:', data.error);
            return;
          }

          const configData = {
            labels: data.labels,
            datasets: [{
              label: type === 'monthly' ? 'Registrations' : 'Students',
              data: data.data,
              backgroundColor: data.colors || 'rgba(16, 185, 129, 0.8)',
              borderColor: data.colors ? data.colors.map(c => c.replace('0.8', '1')) : '#10B981',
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            }]
          };

          if (ctx) {
            studentChart = new Chart(ctx, {
              type: 'bar',
              data: configData,
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: {
                      color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                      stepSize: 1 // Changed from 5 to 1 for better visibility with low usage
                    }
                  },
                  x: {
                    grid: {
                      display: false
                    }
                  }
                },
                elements: {
                  bar: {
                    borderRadius: 8
                  }
                }
              }
            });
          } else if (studentChart) {
            studentChart.data = configData;
            studentChart.update();
          }
        })
        .catch(error => console.error('Error:', error));
    }

    // Student Registration Management Functions
    function loadStudentRegistrations() {
      console.log('Loading student applications...');
      fetch('/api/admin/student-applications/', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
      })
        .then(response => {
          console.log('Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Registrations data:', data);
          const registrationList = document.getElementById('registration-list');
          registrationList.innerHTML = '';

          if (data.applications.length === 0) {
            registrationList.innerHTML = '<p class="no-applications">No student registrations found.</p>';
            return;
          }

          data.applications.forEach(application => {
            const applicationElement = createApplicationElement(application);
            registrationList.appendChild(applicationElement);
          });
        })
        .catch(error => {
          console.error('Error loading registrations:', error);
          document.getElementById('registration-list').innerHTML = '<p class="error">Error loading registrations: ' + error.message + '</p>';
        });
    }

    function createApplicationElement(application) {
      const div = document.createElement('div');
      div.className = `application-item application-${application.status} bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow duration-200 flex flex-col gap-4`;
      
      const statusColors = {
        'approved': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 border-green-200',
        'pending': 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400 border-yellow-200',
        'rejected': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 border-red-200'
      };
      
      const statusClass = statusColors[application.status.toLowerCase()] || statusColors['pending'];

      div.innerHTML = `
        <div class="flex justify-between items-start border-b border-gray-100 dark:border-gray-700 pb-3">
            <div class="flex-1 min-w-0 pr-2">
                <h4 class="text-base font-bold text-gray-900 dark:text-white truncate" title="${application.first_name} ${application.last_name}">${application.first_name} ${application.last_name}</h4> 
                <span class="text-xs text-gray-500 dark:text-gray-400 truncate block">@${application.username}</span>
            </div>
            <div class="flex flex-col items-end gap-1.5 shrink-0">
              <span class="px-2.5 py-1 text-xs font-semibold rounded-full border ${statusClass} uppercase tracking-wider">${application.status}</span>
              <button class="flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 dark:bg-blue-900/20 dark:text-blue-400 dark:border-blue-800 rounded-lg text-xs font-medium transition-colors" onclick="viewStudentFromRegistration(${application.id})">
                  <i class="fas fa-user text-[10px]"></i> View Profile
              </button>
            </div>
        </div>
        
        <div class="flex flex-col gap-2 flex-1 text-sm text-gray-700 dark:text-gray-300">
            <div class="grid grid-cols-[100px_1fr] gap-2">
              <span class="text-xs font-semibold text-gray-500 uppercase">Email:</span>
              <span class="truncate" title="${application.email}">${application.email}</span>
            </div>
            <div class="grid grid-cols-[100px_1fr] gap-2">
              <span class="text-xs font-semibold text-gray-500 uppercase">Program:</span>
              <span class="truncate" title="${application.program_and_yr}">${application.program_and_yr}</span>
            </div>
            <div class="grid grid-cols-[100px_1fr] gap-2">
              <span class="text-xs font-semibold text-gray-500 uppercase">Contact:</span>
              <span>${application.contact_num}</span>
            </div>
            <div class="grid grid-cols-[100px_1fr] gap-2">
              <span class="text-xs font-semibold text-gray-500 uppercase">Applied:</span>
              <span>${new Date(application.created_at || Date.now()).toLocaleDateString()}</span>
            </div>
            ${(application.student_documents && application.student_documents.length > 0) ? `
            <div class="grid grid-cols-[100px_1fr] flex-col gap-2 mt-1">
              <span class="text-xs font-semibold text-gray-500 uppercase">Documents:</span>
              <div class="flex flex-col gap-1">
                 ${application.student_documents.map(doc => `<a href="${doc.url}" target="_blank" class="text-brand-primary hover:underline flex items-center gap-1"><i class="fas fa-file-alt"></i> ${doc.name || 'View'}</a>`).join('')}
              </div>
            </div>
            ` : (application.doc_submitted ? `
            <div class="grid grid-cols-[100px_1fr] gap-2 mt-1">
              <span class="text-xs font-semibold text-gray-500 uppercase">Document:</span>
              <a href="${application.doc_submitted}" target="_blank" class="text-brand-primary hover:underline flex items-center gap-1"><i class="fas fa-file-alt"></i> View</a>
            </div>
            ` : '')}
        </div>
        
        <div class="flex gap-2 pt-3 border-t border-gray-100 dark:border-gray-700 mt-auto">
            ${application.status === 'pending' ? `
              <button class="flex-1 text-center py-2 px-3 bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 dark:bg-green-900/20 dark:text-green-400 dark:border-green-800 rounded-lg text-sm font-medium transition-colors" onclick="approveStudent(${application.id})">
                  <i class="fas fa-check mr-1"></i> Approve
              </button>
              <button class="flex-1 text-center py-2 px-3 bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 dark:bg-red-900/20 dark:text-red-400 dark:border-red-800 rounded-lg text-sm font-medium transition-colors" onclick="rejectStudent(${application.id})">
                  <i class="fas fa-times mr-1"></i> Reject
              </button>
            ` : `
              <div class="flex-1 text-center py-2 px-3 bg-gray-50 text-gray-500 border border-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-700 rounded-lg text-sm font-medium">
                  <i class="fas fa-check-circle mr-1 text-green-500"></i> Action Completed
              </div>
            `}
        </div>
      `;
      return div;
    }

    function approveStudent(studentId) {
      Swal.fire({
        title: 'Approve Application?',
        text: "Are you sure you want to approve this student application?",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10B981',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, approve it!'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/api/admin/student-applications/${studentId}/approve/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json',
            },
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                loadStudentRegistrations();
                loadDashboardStats(); // Refresh stats
                Swal.fire('Approved!', 'The student application has been approved.', 'success');
              } else {
                Swal.fire('Error', 'Error approving student: ' + data.error, 'error');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              Swal.fire('Error', 'Error approving student application', 'error');
            });
        }
      });
    }

    function rejectStudent(studentId) {
      Swal.fire({
        title: 'Reject Application?',
        text: "Are you sure you want to reject this student application?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, reject it!'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/api/admin/student-applications/${studentId}/reject/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json',
            },
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                loadStudentRegistrations();
                loadDashboardStats(); // Refresh stats
                Swal.fire('Rejected!', 'The student application has been rejected.', 'success');
              } else {
                Swal.fire('Error', 'Error rejecting student: ' + data.error, 'error');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              Swal.fire('Error', 'Error rejecting student application', 'error');
            });
        }
      });
    }

    function filterRegistrations() {
      const filter = document.getElementById('registration-filter').value;
      const applicationItems = document.querySelectorAll('.application-item');

      applicationItems.forEach(item => {
        if (filter === 'all') {
          item.style.display = 'block';
        } else {
          item.style.display = item.classList.contains(`application-${filter}`) ? 'block' : 'none';
        }
      });
    }

    // Admin Logs Sorting
    function sortAdminLogs() {
      const select = document.getElementById('admin-logs-sort');
      const table = document.getElementById('adminLogsTable');
      if (!select || !table) return;
      
      const tbody = table.querySelector('tbody');
      // Get all valid rows (skip the empty placeholder row if it has the "No admin logs" text)
      const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.cells.length === 3 && row.cells[0].colSpan !== 3);
      
      if (rows.length === 0) return;
      
      const sortValue = select.value;
      
      rows.sort((a, b) => {
        if (sortValue === 'newest' || sortValue === 'oldest') {
          // Parse dates from the first cell
          // Cell content looks like: "Feb 21, 2026 \n 15:25"
          const dateA = new Date(a.cells[0].innerText.replace('\n', ' '));
          const dateB = new Date(b.cells[0].innerText.replace('\n', ' '));
          
          if (sortValue === 'newest') return dateB - dateA;
          if (sortValue === 'oldest') return dateA - dateB;
        } else if (sortValue === 'admin_asc') {
          const textA = a.cells[1].innerText.toLowerCase();
          const textB = b.cells[1].innerText.toLowerCase();
          return textA.localeCompare(textB);
        } else if (sortValue === 'action_asc') {
          const textA = a.cells[2].innerText.toLowerCase();
          const textB = b.cells[2].innerText.toLowerCase();
          return textA.localeCompare(textB);
        }
      });
      
      // Re-append rows in sorted order
      rows.forEach(row => tbody.appendChild(row));
    }

    // Program Application Management Functions
    let currentApplications = []; // Store fetched applications

    function loadProgramApplications() {
      console.log('Loading program applications...');
      fetch('/api/admin/program-applications/', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
      })
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then(data => {
          currentApplications = data.applications || []; // Store for modal access
          const applicationList = document.getElementById('program-application-list');
          applicationList.innerHTML = '';

          if (currentApplications.length === 0) {
            applicationList.innerHTML = '<p class="no-applications">No program applications found.</p>';
            return;
          }

          currentApplications.forEach(application => {
            const applicationElement = createProgramApplicationElement(application);
            applicationList.appendChild(applicationElement);
          });
        })
        .catch(error => {
          console.error('Error loading program applications:', error);
          document.getElementById('program-application-list').innerHTML = '<p class="error">Error loading program applications.</p>';
        });
    }

    function createProgramApplicationElement(application) {
      const div = document.createElement('div');
      div.className = `application-item application-${application.requirement_status} bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow duration-200 flex flex-col gap-4`;
      
      const statusColors = {
        'approved': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 border-green-200',
        'pending': 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400 border-yellow-200',
        'rejected': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 border-red-200',
        'submitted': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 border-blue-200',
      };
      
      const statusClass = statusColors[application.requirement_status.toLowerCase()] || statusColors['pending'];

      div.innerHTML = `
        <div class="flex justify-between items-start border-b border-gray-100 dark:border-gray-700 pb-3">
            <div class="flex-1 min-w-0 pr-2">
                <h4 class="text-base font-bold text-gray-900 dark:text-white truncate" title="${application.student.first_name} ${application.student.last_name}">${application.student.first_name} ${application.student.last_name}</h4> 
                <span class="text-xs text-gray-500 dark:text-gray-400 truncate block">@${application.student.username}</span>
            </div>
            <span class="px-2.5 py-1 text-xs font-semibold rounded-full border ${statusClass} uppercase tracking-wider">${application.requirement_status}</span>
        </div>
        
        <div class="flex flex-col gap-2 flex-1 text-sm text-gray-700 dark:text-gray-300">
            <div class="grid grid-cols-[80px_1fr] gap-2">
              <span class="text-xs font-semibold text-gray-500 uppercase">Program:</span>
              <span class="flex items-center gap-1 font-medium text-brand-primary truncate" title="${application.program.program_name}"><i class="fas fa-graduation-cap"></i> ${application.program.program_name}</span>
            </div>
            <div class="grid grid-cols-[80px_1fr] gap-2">
              <span class="text-xs font-semibold text-gray-500 uppercase">Applied:</span>
              <span>${application.created_at ? new Date(application.created_at).toLocaleDateString() : 'N/A'}</span>
            </div>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-2 pt-3 border-t border-gray-100 dark:border-gray-700 mt-auto">
            <button class="flex-1 text-center py-2 px-3 bg-brand-primary/10 text-brand-primary hover:bg-brand-primary/20 dark:bg-brand-primary/20 dark:text-brand-primary border border-brand-primary/20 rounded-lg text-sm font-medium transition-colors" onclick="viewApplication(${application.app_id})">
                <i class="fas fa-eye mr-1"></i> View Details
            </button>
            
            ${application.requirement_status === 'submitted' ? `
              <div class="flex gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                  <button class="flex-1 sm:px-4 py-2 bg-green-500 text-white hover:bg-green-600 rounded-lg text-sm font-medium transition-colors shadow-sm" onclick="approveProgramApplication(${application.app_id})">
                      <i class="fas fa-check"></i>
                  </button>
                  <button class="flex-1 sm:px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded-lg text-sm font-medium transition-colors shadow-sm" onclick="rejectProgramApplication(${application.app_id})">
                      <i class="fas fa-times"></i>
                  </button>
              </div>
            ` : ''}
        </div>
      `;
      return div;
    }

    function viewApplication(appId) {
      const app = currentApplications.find(a => a.app_id === appId);
      if (!app) return;

      document.getElementById('app-modal-student').textContent = `${app.student.first_name} ${app.student.last_name} (@${app.student.username})`;
      document.getElementById('app-modal-program').textContent = app.program.program_name;
      document.getElementById('app-modal-status').textContent = app.requirement_status;
      document.getElementById('app-modal-email').textContent = app.student.email;
      document.getElementById('app-modal-date').textContent = app.created_at ? new Date(app.created_at).toLocaleString() : 'N/A';

      const docContainer = document.getElementById('app-modal-document');
      docContainer.innerHTML = ''; // Clear previous content

      const documents = app.documents || [];
      if (app.student.student_documents && app.student.student_documents.length > 0) {
        app.student.student_documents.forEach(s_doc => {
            documents.push({ url: s_doc.url, name: s_doc.name });
        });
      }
      // Backward compatibility: check if doc_submitted exists and isn't already in documents list
      if (app.student.doc_submitted && documents.length === 0) {
        documents.push({ url: app.student.doc_submitted, name: 'Document' });
      }

      if (documents.length > 0) {
        documents.forEach(doc => {
          const fileExt = doc.url.split('.').pop().toLowerCase();
          const docWrapper = document.createElement('div');
          docWrapper.style.marginBottom = '15px';
          docWrapper.style.border = '1px solid #e2e8f0';
          docWrapper.style.borderRadius = '8px';
          docWrapper.style.padding = '10px';

          const title = document.createElement('p');
          title.textContent = doc.name || 'Document';
          title.style.fontWeight = 'bold';
          title.style.marginBottom = '5px';
          docWrapper.appendChild(title);

          if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExt)) {
            docWrapper.innerHTML += `<img src="${doc.url}" alt="Submitted Document" style="max-width: 100%; max-height: 400px; border-radius: 4px;">`;
          } else if (fileExt === 'pdf') {
            docWrapper.innerHTML += `
                <iframe src="${doc.url}" style="width: 100%; height: 500px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px;"></iframe>
                <a href="${doc.url}" target="_blank" class="btn btn-sm btn-secondary" style="display: inline-block;">Open PDF in New Tab</a>
            `;
          } else if (['doc', 'docx'].includes(fileExt)) {
            docWrapper.innerHTML += `
                <div style="padding: 20px; text-align: center; background: #f8fafc; border-radius: 8px;">
                    <i class="fas fa-file-word" style="font-size: 48px; color: #2b579a; margin-bottom: 15px; display: block;"></i>
                    <p style="margin-bottom: 15px;">Word documents cannot be previewed directly.</p>
                    <a href="${doc.url}" download class="btn btn-sm btn-primary">Download Document</a>
                </div>
             `;
          } else {
            docWrapper.innerHTML += `
                <div style="padding: 20px; text-align: center; background: #f8fafc; border-radius: 8px;">
                    <i class="fas fa-file" style="font-size: 48px; color: #718096; margin-bottom: 15px; display: block;"></i>
                    <p style="margin-bottom: 15px;">Preview not available for this file type.</p>
                    <a href="${doc.url}" download class="btn btn-sm btn-primary">Download File</a>
                </div>
             `;
          }
          docContainer.appendChild(docWrapper);
        });
      } else {
        docContainer.textContent = 'No document submitted';
      }

      // Motivation removed

      document.getElementById('application-modal').style.display = 'block';
    }

    function closeApplicationModal() {
      document.getElementById('application-modal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
      const modal = document.getElementById('application-modal');
      const popupModal = document.getElementById('popup-modal');
      if (event.target === modal) {
        closeApplicationModal();
      }
      if (event.target === popupModal) {
        closePopupModal();
      }
    }

    let currentAppId = null;
    let currentAction = null;

    function openRemarksModal(appId, action) {
      currentAppId = appId;
      currentAction = action;

      const modal = document.getElementById('remarks-modal');
      const title = document.getElementById('remarks-modal-title');
      const submitBtn = document.getElementById('remarks-submit-btn');

      if (action === 'approve') {
        title.textContent = 'Approve Application';
        submitBtn.textContent = 'Approve';
        submitBtn.className = 'btn btn-success';
      } else {
        title.textContent = 'Reject Application';
        submitBtn.textContent = 'Reject';
        submitBtn.className = 'btn btn-danger';
      }

      document.getElementById('remarks-hidden-input').value = '';
      if (quill) {
        quill.setText('');
      }
      modal.style.display = 'block';
    }

    var quill;
    var composeQuill;
    document.addEventListener('DOMContentLoaded', function () {
      quill = new Quill('#remarks-editor-container', {
        theme: 'snow',
        placeholder: 'Enter admin remarks here...',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline', 'strike'],
            ['blockquote', 'code-block'],
            [{ 'header': 1 }, { 'header': 2 }],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'script': 'sub' }, { 'script': 'super' }],
            [{ 'indent': '-1' }, { 'indent': '+1' }],
            [{ 'direction': 'rtl' }],
            [{ 'size': ['small', false, 'large', 'huge'] }],
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'font': [] }],
            [{ 'align': [] }],
            ['clean']
          ]
        }
      });

      // Initialize Compose Editor
      const composeContainer = document.getElementById('compose-editor-container');
      if (composeContainer) {
        composeQuill = new Quill(composeContainer, {
          theme: 'snow',
          placeholder: 'Write your message here...',
          modules: {
            toolbar: [
              ['bold', 'italic', 'underline', 'strike'],
              ['blockquote', 'code-block', 'link'],
              [{ 'header': 1 }, { 'header': 2 }],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'color': [] }, { 'background': [] }],
              ['clean']
            ]
          }
        });
      }

      // Handle Attachment Display
      const attachmentInput = document.getElementById('compose-attachment');
      const attachmentName = document.getElementById('compose-attachment-name');
      if (attachmentInput && attachmentName) {
        attachmentInput.addEventListener('change', function() {
          if (this.files && this.files.length > 0) {
            attachmentName.textContent = this.files[0].name;
            attachmentName.classList.remove('hidden');
          } else {
            attachmentName.classList.add('hidden');
          }
        });
      }
    });

    function closeRemarksModal() {
      document.getElementById('remarks-modal').style.display = 'none';
      currentAppId = null;
      currentAction = null;
    }

    // Compose Messaging Logic
    function openComposeModal(mode) {
      const choiceModal = document.getElementById('message-choice-modal');
      choiceModal.style.display = 'none';

      const sId = choiceModal.dataset.studentId;
      const sName = choiceModal.dataset.studentName;
      const sEmail = choiceModal.dataset.studentEmail;

      const composeModal = document.getElementById('compose-message-modal');
      document.getElementById('compose-mode').value = mode; // 'email' or 'system'
      document.getElementById('compose-student-id').value = sId;
      document.getElementById('compose-recipient-display').textContent = `${sName} ${mode === 'email' ? '(<'+sEmail+'>)' : ''}`;
      
      const titleSpan = document.getElementById('compose-modal-title');
      if (mode === 'email') {
        titleSpan.innerHTML = '<i class="fas fa-envelope text-brand-primary"></i> Compose Email';
        document.getElementById('compose-attachment-group').style.display = 'block';
      } else {
        titleSpan.innerHTML = '<i class="fas fa-comment-dots text-brand-primary"></i> Direct System Message';
        document.getElementById('compose-attachment-group').style.display = 'none';
      }

      // Reset form
      document.getElementById('compose-subject').value = '';
      if (composeQuill) composeQuill.setText('');
      document.getElementById('compose-attachment').value = '';
      document.getElementById('compose-attachment-name').classList.add('hidden');

      composeModal.style.display = 'block';
    }

    function openBatchComposeModal(mode) {
      const statusFilter = document.getElementById('batch-status-filter').value;
      const programFilter = document.getElementById('batch-program-filter').value;
      const typeFilter = document.getElementById('batch-type-filter').value;
      const barangayFilter = document.getElementById('batch-barangay-filter').value;
      const schoolFilter = document.getElementById('batch-school-filter').value;

      let summaryFilters = `Status: ${statusFilter}, Program: ${programFilter}, Type: ${typeFilter}, Brgy: ${barangayFilter}`;
      if (schoolFilter.trim()) summaryFilters += `, School: ${schoolFilter}`;

      const summaryText = `All students matching [${summaryFilters}]`;

      const composeModal = document.getElementById('compose-message-modal');
      document.getElementById('compose-mode').value = mode === 'email' ? 'batch_email' : 'batch_system';
      document.getElementById('compose-student-id').value = JSON.stringify({ status: statusFilter, program: programFilter, student_type: typeFilter, barangay: barangayFilter, school: schoolFilter });
      document.getElementById('compose-recipient-display').innerHTML = `<strong>Batch:</strong> ${summaryText}`;
      
      const titleSpan = document.getElementById('compose-modal-title');
      if (mode === 'email') {
        titleSpan.innerHTML = '<i class="fas fa-envelope-open-text text-brand-primary"></i> Compose Mass Email';
        document.getElementById('compose-attachment-group').style.display = 'block';
      } else {
        titleSpan.innerHTML = '<i class="fas fa-bullhorn text-brand-primary"></i> Compose Mass System Message';
        document.getElementById('compose-attachment-group').style.display = 'none';
      }

      // Reset form
      document.getElementById('compose-subject').value = '';
      if (composeQuill) composeQuill.setText('');
      document.getElementById('compose-attachment').value = '';
      document.getElementById('compose-attachment-name').classList.add('hidden');

      composeModal.style.display = 'block';
    }

    function closeComposeModal() {
      document.getElementById('compose-message-modal').style.display = 'none';
    }

    async function sendComposedMessage() {
      const mode = document.getElementById('compose-mode').value;
      const studentIdOrFilters = document.getElementById('compose-student-id').value;
      const subject = document.getElementById('compose-subject').value.trim();
      const body = composeQuill ? composeQuill.root.innerHTML : '';
      const textLength = composeQuill ? composeQuill.getText().trim().length : 0;

      if (!subject || textLength === 0) {
        Swal.fire('Error', 'Please fill out both subject and message.', 'error');
        return;
      }

      const btn = document.getElementById('compose-send-btn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
      btn.disabled = true;

      try {
        let endpoint = '';
        let formData = new FormData();
        
        if (mode === 'email' || mode === 'system') {
          endpoint = mode === 'email' ? '/api/admin/messages/send-email/' : '/api/admin/messages/send-system/';
          formData.append('student_id', studentIdOrFilters);
        } else if (mode === 'batch_email' || mode === 'batch_system') {
          endpoint = '/api/admin/messages/send-batch/';
          const filters = JSON.parse(studentIdOrFilters);
          formData.append('mode', mode === 'batch_email' ? 'email' : 'system');
          formData.append('status', filters.status);
          formData.append('program', filters.program);
          formData.append('student_type', filters.student_type);
          formData.append('barangay', filters.barangay);
          formData.append('school', filters.school);
        }

        formData.append('subject', subject);
        formData.append('body', body);

        if (mode === 'email' || mode === 'batch_email') {
          const fileInput = document.getElementById('compose-attachment');
          if (fileInput.files.length > 0) {
            formData.append('attachment', fileInput.files[0]);
          }
        }

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: formData
        });

        const data = await response.json();
        if (data.success) {
          Swal.fire('Success', 'Message sent successfully!', 'success').then(() => {
            closeComposeModal();
          });
        } else {
          Swal.fire('Error', 'Error: ' + (data.error || 'Failed to send message.'), 'error');
        }
      } catch (error) {
        console.error('Error sending message:', error);
        Swal.fire('Error', 'An error occurred while sending the message.', 'error');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    function approveProgramApplication(applicationId) {
      openRemarksModal(applicationId, 'approve');
    }

    function rejectProgramApplication(applicationId) {
      openRemarksModal(applicationId, 'reject');
    }

    document.addEventListener('DOMContentLoaded', function () {
      const remarksForm = document.getElementById('remarks-form');
      if (remarksForm) {
        remarksForm.addEventListener('submit', function (e) {
          e.preventDefault();

          if (!currentAppId || !currentAction) return;

          if (!currentAppId || !currentAction) return;

          // Get HTML content from Quill
          const remarks = quill.root.innerHTML;
          const endpoint = `/api/admin/program-applications/${currentAppId}/${currentAction}/`;

          fetch(endpoint, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ remarks: remarks })
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                closeRemarksModal();
                loadProgramApplications();
                Swal.fire('Success!', 'Remarks have been saved.', 'success');
              } else {
                Swal.fire('Error', 'Error: ' + data.error, 'error');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              Swal.fire('Error', 'An error occurred.', 'error');
            });
        });
      }

      // Close modal when clicking outside
      const remarksModal = document.getElementById('remarks-modal');
      if (remarksModal) {
        window.addEventListener('click', function (event) {
          if (event.target === remarksModal) {
            closeRemarksModal();
          }
        });
      }
    });

    function filterProgramApplications() {
      const filter = document.getElementById('program-application-filter').value;
      const applicationItems = document.querySelectorAll('#program-application-list .application-item');

      applicationItems.forEach(item => {
        if (filter === 'all') {
          item.style.display = 'block';
        } else {
          item.style.display = item.classList.contains(`application-${filter}`) ? 'block' : 'none';
        }
      });
    }

    // Form submission
    document.getElementById('popup-form').addEventListener('submit', function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const popupId = formData.get('popup_id');
      const url = popupId ? `/api/admin/popups/${popupId}/edit/` : '/api/admin/popups/create/';
      const method = popupId ? 'PUT' : 'POST';

      fetch(url, {
        method: method,
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title: formData.get('title'),
          message: formData.get('message'),
          popup_type: formData.get('popup_type'),
          is_active: formData.get('is_active') === 'on',
          expires_at: formData.get('expires_at') || null,
        }),
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            closePopupModal();
            loadPopups();
            Swal.fire('Success', 'Popup saved successfully', 'success');
          } else {
            Swal.fire('Error', 'Error saving popup: ' + data.error, 'error');
          }
        });
    });

    function getCsrf() {
      const name = 'csrftoken=';
      const c = document.cookie.split(';').map(s => s.trim()).find(s => s.startsWith(name));
      return c ? decodeURIComponent(c.substring(name.length)) : '';
    }

    async function handleCreateProgram(e) {
      e.preventDefault();
      const form = document.getElementById('createProgramForm');
      const endpoint = form.getAttribute('data-endpoint') || '/accounts/create-program/';
      const msg = document.getElementById('createProgramMsg');

      const fd = new FormData(form);

      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          body: fd,
          headers: { 'X-CSRFToken': getCsrf() },
          credentials: 'same-origin'
        });
        const data = await res.json();
        msg.style.display = 'block';
        if (res.ok && data.success) {
          msg.className = 'app-message success';
          msg.textContent = 'Program created.';
          form.reset();
          // optionally refresh program list via another fetch
        } else {
          msg.className = 'app-message error';
          msg.textContent = data.error || 'Failed to create program.';
        }
      } catch (err) {
        msg.style.display = 'block';
        msg.className = 'app-message error';
        msg.textContent = 'Network error.';
      }
    }

    // Utility function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
      const modal = document.getElementById('popup-modal');
      if (event.target === modal) {
        closePopupModal();
      }
    }

    function toggleProgramForm() {
      const form = document.getElementById('programForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    document.querySelector('.program-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const formData = new FormData(this);

      try {
        const response = await fetch('/home/create_program/', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });

        const data = await response.json();
        if (data.success) {
          Swal.fire('Success', 'Program created successfully!', 'success');
          this.reset();
          hideCreateProgram();
          await loadPrograms();
          // Optionally reload programs list
        } else {
          Swal.fire('Error', data.error || 'Failed to create program', 'error');
        }
      } catch (error) {
        Swal.fire('Error', 'Error creating program', 'error');
        console.error(error);
      }
    });

    async function loadPrograms() {
      const container = document.querySelector('.programs-list');
      const endpoints = ['/home/programs/', '/programs/'];
      let data = null;
      for (const url of endpoints) {
        try {
          const res = await fetch(url, { credentials: 'same-origin' });
          console.log('Programs fetch', url, res.status);
          if (!res.ok) continue;
          data = await res.json();
          break;
        } catch (e) {
          console.warn('Programs fetch failed for', url, e);
        }
      }
      container.innerHTML = '';
      if (!data || !data.programs) {
        container.innerHTML = '<p class="no-programs">Unable to load programs.</p>';
        return;
      }

      allPrograms = data.programs; // Store for edit modal access

      if (data.programs.length === 0) {
        container.innerHTML = '<p class="no-programs">No programs found.</p>';
        return;
      }
      data.programs.forEach(p => {
        const el = document.createElement('div');
        el.className = 'program-item bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-300 border border-gray-100 dark:border-gray-700 flex flex-col relative';

        el.innerHTML = `
          <div class="w-full h-32 bg-cover bg-center relative ${!p.program_image ? 'bg-gradient-to-tr from-brand-primary to-blue-400' : ''}" style="${p.program_image ? `background-image: url('${p.program_image}');` : ''}">
            <div class="absolute top-3 right-3 flex gap-2">
              <button class="bg-blue-600/70 hover:bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-sm transition-colors shadow-sm" onclick="openProgramApplicantsModal(${p.program_id}, '${p.program_type}')" title="View Applicants"><i class="fas fa-users text-xs"></i></button>
              <button class="bg-gray-900/60 hover:bg-gray-900 text-white w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-sm transition-colors shadow-sm" onclick="openEditProgramModal(${p.program_id})" title="Edit Program"><i class="fas fa-edit text-xs"></i></button>
              <button class="bg-red-600/70 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-sm transition-colors shadow-sm" onclick="deleteProgram(${p.program_id})" title="Delete Program"><i class="fas fa-trash text-xs"></i></button>
            </div>
          </div>
          <div class="p-5 flex flex-col flex-1">
            <div class="flex justify-between flex-nowrap items-start mb-3 gap-2">
              <h4 class="text-lg font-bold text-gray-800 dark:text-white truncate" title="${p.program_name}">${p.program_name}</h4>
              <span class="px-2 py-0.5 whitespace-nowrap text-xs font-bold text-white bg-gray-600 dark:bg-gray-700 rounded-full">${p.program_type || 'Other'}</span>
            </div>
            
            <div class="text-sm text-gray-600 dark:text-gray-300 line-clamp-3 mb-3 flex-none">
              <p>${p.requirements || 'No description listed.'}</p>
            </div>

            ${(p.document_requirements && p.document_requirements.length > 0) ? `
              <div class="mb-4 flex-1">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1 block">Req. Documents:</span>
                <div class="flex flex-wrap gap-1">
                  ${p.document_requirements.map(doc => `<span class="inline-block px-1.5 py-0.5 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 border border-blue-100 dark:border-blue-800 rounded text-[10px] whitespace-nowrap">${doc}</span>`).join('')}
                </div>
              </div>
            ` : `
               <div class="mb-4 flex-1">
                <span class="text-[11px] italic text-gray-400">No specific document requirements set.</span>
               </div>
            `}
            
            ${(p.application_start_date || p.application_end_date) ? `
                <div class="mt-auto pt-3 border-t border-gray-100 dark:border-gray-700 flex items-center text-xs text-gray-500 dark:text-gray-400">
                    <i class="fas fa-calendar-alt text-brand-primary mr-2"></i> 
                    ${p.application_start_date || 'N/A'} - ${p.application_end_date || 'N/A'}
                </div>
            ` : ''}
          </div>
        `;
        container.appendChild(el);
      });
    }
  </script>

  <!-- Inbox / Support Tab -->
  <div id="inbox" class="tab-content" style="display: none;">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Inbox & Support Tickets</h3>
        <div style="display: flex; gap: 10px;">
          <select id="inbox-filter" onchange="filterAdminMessages()" style="padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; font-family: 'Roboto', sans-serif;">
            <option value="all">All Messages</option>
            <option value="unread">Unread Only</option>
          </select>
          <button class="btn btn-primary" onclick="loadAdminMessages()">Refresh</button>
        </div>
      </div>
      <div class="table-container shadow-sm border border-gray-100 rounded-xl">
        <table>
          <thead>
            <tr style="background-color: #f8fafc;">
              <th style="width: 50px;">Status</th>
              <th>Student</th>
              <th>Subject</th>
              <th>Date</th>
              <th style="text-align: center; width: 120px;">Action</th>
            </tr>
          </thead>
          <tbody id="admin-inbox-list">
            <!-- Messages will be injected here -->
            <tr><td colspan="5" style="text-align: center; color: #64748b; padding: 20px;">Loading messages...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
<!-- End of Main Content -->

<!-- Removed duplicate admin-reply-modal and popup-modal -->
  <script>
    // Popup Management Functions
    function loadPopups() {
      const filter = document.getElementById('popup-filter') ? document.getElementById('popup-filter').value : 'all';

      fetch('/api/admin/popups/', { credentials: 'same-origin' })
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById('popup-list');
          if (!list) return;

          if (!data.popups || data.popups.length === 0) {
            list.innerHTML = '<p class="no-data">No notifications found.</p>';
            return;
          }

          list.innerHTML = '';
          const filtered = data.popups.filter(p => {
            if (filter === 'all') return true;
            if (filter === 'active') return p.is_active;
            if (filter === 'inactive') return !p.is_active;
            return p.popup_type === filter;
          });

          if (filtered.length === 0) {
            list.innerHTML = '<p class="no-data">No matching notifications.</p>';
            return;
          }

          filtered.forEach(p => {
            const el = document.createElement('div');
            el.className = `popup-item ${p.popup_type} ${p.is_active ? 'active' : 'inactive'}`;
            el.innerHTML = `
              <div class="popup-content">
                <div class="popup-header-row">
                  <span class="popup-type-badge ${p.popup_type}">${p.popup_type}</span>
                  <span class="popup-status ${p.is_active ? 'active' : 'inactive'}">
                    ${p.is_active ? 'Active' : 'Inactive'}
                  </span>
                </div>
                <h4>${p.title}</h4>
                <p>${p.message}</p>
                <small>Created: ${new Date(p.created_at).toLocaleDateString()}</small>
              </div>
              <div class="popup-actions">
                <button class="btn btn-sm btn-outline" onclick="togglePopup(${p.id})">
                  ${p.is_active ? 'Deactivate' : 'Activate'}
                </button>
                <button class="btn btn-sm btn-danger" onclick="deletePopup(${p.id})">Delete</button>
              </div>
            `;
            list.appendChild(el);
          });

          // Update dashboard stat if exists
          const statEl = document.getElementById('active-popups');
          if (statEl) {
            const activeCount = data.popups.filter(p => p.is_active).length;
            statEl.textContent = activeCount;
          }
        })
        .catch(err => console.error('Error loading popups:', err));
    }

    function openPopupModal() {
      const modal = document.getElementById('popup-modal');
      const form = document.getElementById('popup-form');
      if (modal && form) {
        form.reset();
        document.getElementById('popup_id').value = '';
        document.getElementById('modal-title').textContent = 'Create New Popup';
        modal.style.display = 'flex';
      }
    }

    function closePopupModal() {
      const modal = document.getElementById('popup-modal');
      if (modal) modal.style.display = 'none';
    }

    function togglePopup(id) {
      Swal.fire({
        title: 'Toggle Status?',
        text: "Are you sure you want to toggle this notification's status?",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10B981',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, toggle it!'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/api/admin/popups/${id}/toggle/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                loadPopups();
                Swal.fire('Toggled!', 'The notification status has been updated.', 'success');
              } else {
                Swal.fire('Error', 'Error: ' + data.error, 'error');
              }
            });
        }
      });
    }

    function deletePopup(id) {
      Swal.fire({
        title: 'Are you sure?',
        text: "Are you sure you want to delete this notification?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, delete it!'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/api/admin/popups/${id}/delete/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                loadPopups();
                Swal.fire('Deleted!', 'The notification has been deleted.', 'success');
              } else {
                Swal.fire('Error', 'Error: ' + data.error, 'error');
              }
            });
        }
      });
    }

    function filterPopups() {
      loadPopups();
    }

    let currentStudents = [];

    function loadStudents() {
      console.log('Loading students...');
      fetch('/api/admin/student-applications/', { // Reusing this endpoint as it returns all students
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
      })
        .then(response => response.json())
        .then(data => {
          const list = document.getElementById('student-list');
          if (!list) return;

          list.innerHTML = '';

          if (!data.applications || data.applications.length === 0) {
            list.innerHTML = '<p class="no-data">No students found.</p>';
            return;
          }

          currentStudents = data.applications;

          data.applications.forEach(student => {
            const el = createStudentElement(student);
            list.appendChild(el);
          });
        })
        .catch(err => console.error('Error loading students:', err));
    }

    function createStudentElement(student) {
      const div = document.createElement('div');
      div.className = `student-item student-${student.status} bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow duration-200 flex flex-col gap-4`;
      div.dataset.name = (student.first_name + ' ' + student.last_name + ' ' + student.username).toLowerCase();
      div.dataset.status = student.status;

      const isActive = student.status === 'active';
      
      const statusColors = {
        'active': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 border-green-200',
        'inactive': 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300 border-gray-200',
        'pending': 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400 border-yellow-200',
        'rejected': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 border-red-200'
      };
      
      const statusClass = statusColors[student.status.toLowerCase()] || statusColors['pending'];

      div.innerHTML = `
        <div class="flex justify-between items-start border-b border-gray-100 dark:border-gray-700 pb-3">
            <div class="flex-1 min-w-0 pr-2">
                <h4 class="text-base font-bold text-gray-900 dark:text-white truncate" title="${student.first_name} ${student.last_name}">${student.first_name} ${student.last_name}</h4> 
                <span class="text-xs text-gray-500 dark:text-gray-400 truncate block">@${student.username}</span>
            </div>
            <span class="px-2.5 py-1 text-xs font-semibold rounded-full border ${statusClass} uppercase tracking-wider">${student.status}</span>
        </div>
        <div class="flex flex-col gap-2 flex-1 text-sm">
            <div class="flex flex-col">
                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Program</span>
                <span class="text-gray-800 dark:text-gray-200 truncate" title="${student.program_and_yr}">${student.program_and_yr || 'N/A'}</span>
            </div>
            <div class="flex flex-col">
                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Email</span>
                <span class="text-gray-800 dark:text-gray-200 truncate" title="${student.email}">${student.email || 'N/A'}</span>
            </div>
            <div class="flex flex-col">
                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Contact</span>
                <span class="text-gray-800 dark:text-gray-200 truncate">${student.contact_num || 'N/A'}</span>
            </div>
        </div>
        
        <div class="flex flex-wrap gap-2 pt-3 border-t border-gray-100 dark:border-gray-700 mt-auto">
            <button class="flex-1 text-center py-1.5 px-2 bg-blue-50 text-blue-600 hover:bg-blue-100 dark:bg-blue-900/20 dark:text-blue-400 border border-blue-200 dark:border-blue-800 rounded text-xs font-medium transition-colors" onclick='viewStudentProfile(${student.id})'>
                <i class="fas fa-eye mr-1"></i> View
            </button>
            <button class="flex-1 text-center py-1.5 px-2 ${isActive ? 'bg-orange-50 text-orange-600 border-orange-200 hover:bg-orange-100 dark:bg-orange-900/20 dark:text-orange-400 dark:border-orange-800' : 'bg-brand-primary/10 text-brand-primary border-brand-primary/20 hover:bg-brand-primary/20 dark:bg-brand-primary/20'} rounded text-xs font-medium transition-colors" 
                    onclick="toggleStudentStatus(${student.id}, '${student.status}')">
                ${isActive ? 'Deactivate' : 'Activate'}
            </button>
            <button class="flex-1 text-center py-1.5 px-2 bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 dark:bg-red-900/20 dark:text-red-400 dark:border-red-800 rounded text-xs font-medium transition-colors" onclick="deleteStudent(${student.id})">
                <i class="fas fa-trash mr-1"></i> Del
            </button>
        </div>
      `;
      return div;
    }
    let _spCurrentIndex = 0;

    function _spGetVisible() {
      const search = (document.getElementById('student-search').value || '').toLowerCase();
      const status = document.getElementById('student-status-filter').value;
      return currentStudents.filter(s =>
        (s.first_name + ' ' + s.last_name + ' ' + s.username).toLowerCase().includes(search) &&
        (status === 'all' || s.status === status)
      );
    }

    function renewStudent(studentId) {
      Swal.fire({
        title: 'Renew Account?',
        text: "This will extend the account expiry for another 6 months.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3b82f6',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, renew it!'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/api/admin/students/${studentId}/renew/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                Swal.fire('Renewed!', 'Account has been renewed.', 'success');
                loadStudents();
                setTimeout(() => viewStudentProfile(studentId), 500);
              } else {
                Swal.fire('Error', 'Error: ' + data.error, 'error');
              }
            });
        }
      });
    }

    function viewStudentProfile(studentId) {
      const visible = _spGetVisible();
      const idx = visible.findIndex(s => s.id === studentId);
      _renderStudentProfile(idx < 0 ? 0 : idx, visible);
    }

    // Called from Applicant Registration cards  switches to Students tab and opens the profile
    function viewStudentFromRegistration(studentId) {
      // Manually activate the Students tab
      document.querySelectorAll('.nav-link, .nav-item').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const studentsNav = document.querySelector('[data-tab="students"]');
      if (studentsNav) studentsNav.classList.add('active');
      const studentsContent = document.getElementById('students');
      if (studentsContent) studentsContent.classList.add('active');

      // Clear current students so polling knows when new data arrives
      currentStudents = [];
      loadStudents();

      // Poll until students are loaded, then open the profile
      const tryOpen = (attempts) => {
        if (currentStudents.length > 0) {
          viewStudentProfile(studentId);
        } else if (attempts > 0) {
          setTimeout(() => tryOpen(attempts - 1), 300);
        }
      };
      setTimeout(() => tryOpen(20), 200);
    }

    function navigateStudent(dir) {
      const visible = _spGetVisible();
      const next = Math.max(0, Math.min(_spCurrentIndex + dir, visible.length - 1));
      _renderStudentProfile(next, visible);
    }

    function goBackToStudentList() {
      document.getElementById('student-profile-section').style.display = 'none';
      document.getElementById('student-list-card').style.display = '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function _renderStudentProfile(index, students) {
      if (!students || !students.length) return;
      _spCurrentIndex = index;
      const s = students[index];

      // Hide list card, show profile section (like Apply view)
      document.getElementById('student-list-card').style.display = 'none';
      const section = document.getElementById('student-profile-section');
      section.style.display = 'block';
      section.style.removeProperty('border-top');
      section.style.removeProperty('margin-top');
      section.style.removeProperty('padding-top');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      document.getElementById('sp-nav-label').textContent = `${index + 1} of ${students.length}`;

      // Sex-based SVG avatar
      const isMale = s.sex && s.sex.toLowerCase() === 'male';
      const isFemale = s.sex && s.sex.toLowerCase() === 'female';
      const avatarEl = document.getElementById('sp-avatar');
      if (isMale) {
        avatarEl.style.background = 'linear-gradient(135deg,#bfdbfe,#3b82f6)';
        avatarEl.innerHTML = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" class="w-full h-full"><circle cx="50" cy="38" r="22" fill="#93c5fd"/><ellipse cx="50" cy="96" rx="35" ry="28" fill="#3b82f6"/><circle cx="50" cy="38" r="17" fill="#fde68a"/><path d="M33 36 Q50 21 67 36" stroke="#92400e" stroke-width="3" fill="none"/></svg>`;
      } else if (isFemale) {
        avatarEl.style.background = 'linear-gradient(135deg,#fbcfe8,#ec4899)';
        avatarEl.innerHTML = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" class="w-full h-full"><circle cx="50" cy="38" r="22" fill="#f9a8d4"/><ellipse cx="50" cy="96" rx="35" ry="28" fill="#ec4899"/><circle cx="50" cy="38" r="17" fill="#fde68a"/><path d="M30 28 Q50 8 70 28 Q68 17 50 14 Q32 17 30 28Z" fill="#92400e"/><path d="M29 30 Q19 38 28 48" stroke="#92400e" stroke-width="4" fill="none"/><path d="M71 30 Q81 38 72 48" stroke="#92400e" stroke-width="4" fill="none"/></svg>`;
      } else {
        avatarEl.style.background = 'linear-gradient(135deg,#e5e7eb,#6b7280)';
        avatarEl.innerHTML = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" class="w-full h-full"><circle cx="50" cy="38" r="22" fill="#d1d5db"/><ellipse cx="50" cy="96" rx="35" ry="28" fill="#6b7280"/><circle cx="50" cy="38" r="17" fill="#fde68a"/></svg>`;
      }

      const statusColors = {
        active:   'bg-green-100 text-green-700 border-green-300',
        inactive: 'bg-gray-100 text-gray-600 border-gray-300',
        pending:  'bg-yellow-100 text-yellow-700 border-yellow-300',
        rejected: 'bg-red-100 text-red-700 border-red-300'
      };

      const mname = s.mname ? ` ${s.mname} ` : ' ';
      document.getElementById('sp-name').textContent = `${s.first_name}${mname}${s.last_name}`;
      document.getElementById('sp-username').textContent = `@${s.username}`;
      
      const now = new Date();
      let expiryInfo = '';
      if (s.approved_at) {
        const approvedAt = new Date(s.approved_at);
        const expiryDate = new Date(approvedAt.getTime() + (180 * 24 * 60 * 60 * 1000));
        const daysLeft = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
        
        let expiryColor = 'text-gray-500';
        if (daysLeft < 30) expiryColor = 'text-red-500 font-bold';
        else if (daysLeft < 60) expiryColor = 'text-orange-500 font-bold';
        
        expiryInfo = `<span class="ml-4 ${expiryColor}">Expiring: ${expiryDate.toLocaleDateString()} (${daysLeft > 0 ? daysLeft + ' days left' : 'Expired'})</span>`;
      }
      document.getElementById('sp-generated-date').innerHTML = `Generated on: ${now.toLocaleDateString()} ${now.toLocaleTimeString()} ${expiryInfo}`;

      const statusEl = document.getElementById('sp-status');
      statusEl.textContent = s.status || 'N/A';
      statusEl.className = `px-3 py-1 text-xs font-bold rounded-full border uppercase tracking-wider ${statusColors[s.status] || statusColors.pending}`;
      document.getElementById('sp-email').textContent = s.email || 'N/A';
      document.getElementById('sp-contact').textContent = s.contact_num || 'N/A';
      document.getElementById('sp-sex').textContent = s.sex || 'N/A';
      document.getElementById('sp-birthday').textContent = s.birthday || 'N/A';
      document.getElementById('sp-student-type').textContent = s.student_type || 'N/A';
      document.getElementById('sp-program').textContent = s.program_and_yr || 'N/A';
      document.getElementById('sp-barangay').textContent = s.barangay || 'N/A';
      document.getElementById('sp-address').textContent = s.address || 'N/A';

      // Extended Profile Fields
      document.getElementById('sp-elem').textContent = s.elem_school ? `${s.elem_school} (${s.elem_year || 'N/A'})` : 'N/A';
      document.getElementById('sp-jhs').textContent = s.jhs_school ? `${s.jhs_school} (${s.jhs_year || 'N/A'})` : 'N/A';
      document.getElementById('sp-shs').textContent = s.shs_school ? `${s.shs_school} (${s.shs_year || 'N/A'})` : 'N/A';
      document.getElementById('sp-college').textContent = s.college_school ? `${s.college_school} (${s.college_year || 'N/A'})` : 'N/A';

      document.getElementById('sp-parent').textContent = s.parent_name || 'N/A';
      document.getElementById('sp-guardian').textContent = s.guardian_name || 'N/A';
      document.getElementById('sp-guardian-contact').textContent = s.guardian_contact || 'N/A';
      document.getElementById('sp-achievements').textContent = s.achievements || 'None registered.';

      const isActive = s.status === 'active';
      const isPending = s.status === 'pending';
      const toggleBtn = document.getElementById('sp-toggle-btn');

      if (isPending) {
        // Pending students cannot be manually activated  they must first be approved via Applicant Registration
        toggleBtn.textContent = 'Activate';
        toggleBtn.disabled = true;
        toggleBtn.className = 'w-full py-2 px-4 rounded-lg text-sm font-semibold text-white transition bg-gray-400 cursor-not-allowed opacity-60';
        toggleBtn.title = 'Student must be approved in Applicant Registration first.';
        toggleBtn.onclick = null;
      } else {
        toggleBtn.disabled = false;
        toggleBtn.textContent = isActive ? 'Deactivate' : 'Activate';
        toggleBtn.className = `w-full py-2 px-4 rounded-lg text-sm font-semibold text-white transition ${isActive ? 'bg-orange-500 hover:bg-orange-600' : 'bg-brand-primary hover:opacity-90'}`;
        toggleBtn.title = '';
        toggleBtn.onclick = () => toggleStudentStatus(s.id, s.status);
      }

      let renewBtn = document.getElementById('sp-renew-btn');
      if (!renewBtn) {
          renewBtn = document.createElement('button');
          renewBtn.id = 'sp-renew-btn';
          toggleBtn.parentNode.insertBefore(renewBtn, toggleBtn.nextSibling);
      }
      
      if (s.status === 'active' || s.status === 'inactive') {
          renewBtn.style.display = 'block';
          renewBtn.textContent = 'Renew Account';
          renewBtn.className = 'w-full py-2 px-4 rounded-lg text-sm font-semibold text-white transition bg-blue-500 hover:bg-blue-600 mt-2';
          renewBtn.onclick = () => renewStudent(s.id);
      } else {
          renewBtn.style.display = 'none';
      }

      document.getElementById('sp-delete-btn').onclick = () => deleteStudent(s.id);
      
      const msgBtn = document.getElementById('sp-message-btn');
      msgBtn.onclick = () => {
          // Store student data in the modal for later use
          const choiceModal = document.getElementById('message-choice-modal');
          choiceModal.dataset.studentId = s.id;
          choiceModal.dataset.studentName = s.first_name + ' ' + s.last_name;
          choiceModal.dataset.studentEmail = s.email;
          choiceModal.style.display = 'block';
      };

      _loadStudentDocs(s.id);
    }

    async function _loadStudentDocs(studentId) {
      const container = document.getElementById('sp-documents');
      container.innerHTML = '<p class="text-xs text-gray-400">Loading...</p>';
      try {
        const res = await fetch(`/api/admin/students/${studentId}/documents/`, { credentials: 'same-origin' });
        const data = await res.json();
        if (!data.success) throw new Error(data.error);

        container.innerHTML = '';

        const requiredDocs = data.required_documents || [];
        const uploadedNames = new Set(data.uploaded_names || []);

        // Build a lookup: document name  uploaded doc object (for view link)
        const uploadedMap = {};
        (data.documents || []).forEach(d => { if (d.name) uploadedMap[d.name] = d; });

        if (requiredDocs.length > 0) {
          // Show all required docs with check/uncheck state
          requiredDocs.forEach(docName => {
            const isUploaded = uploadedNames.has(docName);
            const uploadedDoc = uploadedMap[docName];
            const row = document.createElement('div');
            row.className = 'flex items-center gap-3 py-2.5 border-b border-gray-100 dark:border-gray-700 last:border-0';
            row.innerHTML = `
              <div class="w-5 h-5 rounded shrink-0 flex items-center justify-center border-2 ${isUploaded ? 'bg-brand-primary border-brand-primary' : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700'}">
                ${isUploaded ? '<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>' : ''}
              </div>
              <span class="flex-1 text-sm font-medium ${isUploaded ? 'text-gray-800 dark:text-gray-200' : 'text-gray-400 dark:text-gray-500'}">${docName}</span>
              ${isUploaded && uploadedDoc ? `<a href="${uploadedDoc.url}" target="_blank" class="text-brand-primary text-xs font-semibold hover:underline shrink-0 ml-2">View</a>` : '<span class="text-xs text-gray-300 dark:text-gray-600 shrink-0 ml-2">Not uploaded</span>'}
            `;
            container.appendChild(row);
          });
          // If there are extra uploaded docs not in the required list, show them too
          (data.documents || []).forEach(doc => {
            if (doc.name && !uploadedNames.has(doc.name) === false && !requiredDocs.includes(doc.name)) {
              const date = new Date(doc.uploaded_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
              const row = document.createElement('div');
              row.className = 'flex items-center gap-3 py-2.5 border-b border-gray-100 dark:border-gray-700 last:border-0';
              row.innerHTML = `
                <div class="w-5 h-5 rounded shrink-0 flex items-center justify-center border-2 bg-brand-primary border-brand-primary">
                  <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                </div>
                <span class="flex-1 text-sm font-medium text-gray-800 dark:text-gray-200">${doc.name}</span>
                <span class="text-xs text-gray-400 shrink-0">${date}</span>
                <a href="${doc.url}" target="_blank" class="text-brand-primary text-xs font-semibold hover:underline shrink-0 ml-2">View</a>
              `;
              container.appendChild(row);
            }
          });
        } else if (data.documents && data.documents.length > 0) {
          // No required docs list  just show uploaded ones
          data.documents.forEach(doc => {
            const date = new Date(doc.uploaded_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const row = document.createElement('div');
            row.className = 'flex items-center gap-3 py-2.5 border-b border-gray-100 dark:border-gray-700 last:border-0';
            row.innerHTML = `
              <div class="w-5 h-5 rounded shrink-0 flex items-center justify-center border-2 bg-brand-primary border-brand-primary">
                <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
              </div>
              <span class="flex-1 text-sm font-medium text-gray-800 dark:text-gray-200">${doc.name || 'Document'}</span>
              <span class="text-xs text-gray-400 shrink-0">${date}</span>
              <a href="${doc.url}" target="_blank" class="text-brand-primary text-xs font-semibold hover:underline shrink-0 ml-2">View</a>
            `;
            container.appendChild(row);
          });
        } else {
          container.innerHTML = '<p class="text-xs text-gray-400 italic">No documents or program requirements found.</p>';
        }
      } catch(e) {
        container.innerHTML = '<p class="text-xs text-red-400 italic">Could not load documents.</p>';
      }
    }


    // Inbox & Ticketing System Functions
    let adminMessages = [];

    async function loadAdminMessages() {
      const filter = document.getElementById('inbox-filter').value;
      const list = document.getElementById('admin-inbox-list');
      list.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #64748b; padding: 20px;">Loading messages...</td></tr>';
      
      try {
        const res = await fetch('/api/messages/');
        const data = await res.json();
        
        if (res.ok && data.success) {
          adminMessages = data.messages;
          let filteredMessages = adminMessages;
          
          if (filter === 'unread') {
            filteredMessages = adminMessages.filter(m => !m.is_read && m.sender_type === 'student');
          }

          // Update Badge
          const unreadCount = adminMessages.filter(m => !m.is_read && m.sender_type === 'student').length;
          updateBadge('badge-inbox', unreadCount);

          if (filteredMessages.length === 0) {
            list.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #64748b; padding: 20px;">No messages found.</td></tr>';
            return;
          }

          list.innerHTML = '';
          filteredMessages.forEach(msg => {
            const dateStr = new Date(msg.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const isUnread = !msg.is_read && msg.sender_type === 'student';
            const statusBadge = isUnread 
              ? `<span style="background: #fee2e2; color: #b91c1c; padding: 4px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: bold;">New</span>`
              : `<span style="background: #f1f5f9; color: #64748b; padding: 4px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: bold;">Read</span>`;
            
            const tr = document.createElement('tr');
            tr.style.cursor = 'pointer';
            tr.style.borderBottom = '1px solid #f1f5f9';
            tr.onmouseover = () => tr.style.backgroundColor = '#f8fafc';
            tr.onmouseout = () => tr.style.backgroundColor = 'transparent';
            
            // Note: student_name is used here, but they are all technically "sender" or "target" based on type
            const studentNameDisplay = msg.sender_type === 'student' ? msg.sender_name : msg.target_student_name;
            const directionIcon = msg.sender_type === 'admin' 
              ? '<i class="fas fa-reply" style="color: #64748b; margin-right: 5px;" title="Replied"></i>' 
              : '';

            tr.innerHTML = `
              <td style="padding: 15px;">${statusBadge}</td>
              <td style="padding: 15px; font-weight: ${isUnread ? 'bold' : 'normal'}; color: #334155;">${directionIcon}${studentNameDisplay}</td>
              <td style="padding: 15px; font-weight: ${isUnread ? 'bold' : 'normal'}; color: #334155;">${msg.subject}</td>
              <td style="padding: 15px; color: #64748b; font-size: 0.9em;">${dateStr}</td>
              <td style="padding: 15px; text-align: center;">
                <button class="btn btn-sm btn-secondary" onclick="openAdminReplyModal(${msg.id})">
                  <i class="fas fa-eye"></i> View
                </button>
              </td>
            `;
            list.appendChild(tr);
          });
        }
      } catch (err) {
        console.error('Error loading admin messages:', err);
        list.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #ef4444; padding: 20px;">Error loading messages</td></tr>';
      }
    }

    function filterAdminMessages() {
      loadAdminMessages();
    }

    function openAdminReplyModal(msgId) {
      const msg = adminMessages.find(m => m.id === msgId);
      if (!msg) return;

      const studentName = msg.sender_type === 'student' ? msg.sender_name : msg.target_student_name;
      
      document.getElementById('admin-reply-subject').textContent = msg.subject;
      document.getElementById('admin-reply-sender').textContent = studentName;
      document.getElementById('admin-reply-avatar').textContent = studentName.charAt(0).toUpperCase();
      document.getElementById('admin-reply-date').textContent = new Date(msg.created_at).toLocaleString();
      document.getElementById('admin-reply-body').textContent = msg.body;
      document.getElementById('admin-reply-student-id').value = msg.target_student_id;
      
      document.getElementById('admin-reply-msg').style.display = 'none';
      document.getElementById('admin-reply-text').value = '';

      document.getElementById('admin-reply-modal').style.display = 'flex';

      // Mark as read if it is unread and from a student
      if (!msg.is_read && msg.sender_type === 'student') {
        fetch(`/api/messages/${msgId}/read/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken') },
          credentials: 'same-origin'
        }).then(res => {
          if (res.ok) {
            msg.is_read = true; // Updates local state
            loadAdminMessages(); // Reload inbox styles so badge disappears
          }
        }).catch(err => console.error(err));
      }
    }

    function closeAdminReplyModal() {
      document.getElementById('admin-reply-modal').style.display = 'none';
    }

    async function handleAdminReplySubmit(e) {
      e.preventDefault();
      
      const msgAlert = document.getElementById('admin-reply-msg');
      const submitBtn = document.getElementById('adminReplyBtn');
      msgAlert.style.display = 'none';
      
      const studentId = document.getElementById('admin-reply-student-id').value;
      const originalSubject = document.getElementById('admin-reply-subject').textContent;
      const subject = originalSubject.startsWith('Re: ') ? originalSubject : 'Re: ' + originalSubject;
      const body = document.getElementById('admin-reply-text').value;

      submitBtn.disabled = true;
      submitBtn.innerText = 'Sending...';

      try {
        const res = await fetch('/api/messages/send/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ subject, body, student_id: studentId }),
          credentials: 'same-origin'
        });
        const data = await res.json();
        
        if (res.ok && data.success) {
          msgAlert.textContent = 'Reply sent successfully!';
          msgAlert.style.display = 'block';
          msgAlert.style.backgroundColor = '#d1fae5';
          msgAlert.style.color = '#065f46';
          msgAlert.style.border = '1px solid #34d399';
          
          setTimeout(() => {
            closeAdminReplyModal();
            loadAdminMessages(); // Refresh inbox list
          }, 1500);
        } else {
          msgAlert.textContent = data.error || 'Failed to send reply.';
          msgAlert.style.display = 'block';
          msgAlert.style.backgroundColor = '#fee2e2';
          msgAlert.style.color = '#b91c1c';
          msgAlert.style.border = '1px solid #f87171';
        }
      } catch (err) {
        msgAlert.textContent = 'Network error during reply submission.';
        msgAlert.style.display = 'block';
        msgAlert.style.backgroundColor = '#fee2e2';
        msgAlert.style.color = '#b91c1c';
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerText = 'Send Reply';
      }
    }

    // Hook tab switches to also load inbox if needed
    // Add initialization to existing DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      // Setup tabs
      document.querySelectorAll('.nav-link, .nav-item').forEach(link => {
        link.addEventListener('click', function(e) {
          // Check if this is exactly the inbox tab getting clicked
          if (this.dataset.tab === 'inbox') {
             loadAdminMessages();
          }
        });
      });
      // Initial load
      setTimeout(() => loadAdminMessages(), 1000); 
    });

    function toggleStudentStatus(studentId, currentStatus) {
      const action = currentStatus === 'active' ? 'deactivate' : 'activate';
      Swal.fire({
        title: 'Are you sure?',
        text: `Are you sure you want to ${action} this student?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: currentStatus === 'active' ? '#f59e0b' : '#10b981',
        cancelButtonColor: '#6b7280',
        confirmButtonText: `Yes, ${action}!`
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/api/admin/students/${studentId}/toggle/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                // Reload list to update UI
                loadStudents();
                // Optionally update stats
                loadDashboardStats();
                Swal.fire('Updated!', `The student has been ${action}d.`, 'success');
              } else {
                Swal.fire('Error', 'Error: ' + data.error, 'error');
              }
            })
            .catch(err => {
              console.error('Error toggling student status:', err);
              Swal.fire('Error', 'An error occurred.', 'error');
            });
        }
      });
    }

    function deleteStudent(studentId) {
      Swal.fire({
        title: 'Delete Student?',
        text: "Are you sure you want to delete this student? This action cannot be undone and will delete all associated applications and documents.",
        icon: 'error',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, delete!'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/api/admin/students/${studentId}/delete/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                Swal.fire('Deleted!', data.message, 'success');
                loadStudents();
                loadDashboardStats();
              } else {
                Swal.fire('Error', 'Error deleting student: ' + data.error, 'error');
              }
            })
            .catch(err => {
              console.error('Error deleting student:', err);
              Swal.fire('Error', 'An error occurred while deleting the student.', 'error');
            });
        }
      });
    }

    function openEditStudentModal(studentId) {
      const student = currentStudents.find(s => s.id === studentId);
      if (!student) return;

      document.getElementById('edit_student_id').value = student.id;
      document.getElementById('edit_student_first_name').value = student.first_name;
      document.getElementById('edit_student_mname').value = student.mname || '';
      document.getElementById('edit_student_last_name').value = student.last_name;
      document.getElementById('edit_student_username').value = student.username;
      document.getElementById('edit_student_email').value = student.email;
      document.getElementById('edit_student_contact').value = student.contact_num;
      document.getElementById('edit_student_barangay').value = student.barangay || '';
      document.getElementById('edit_student_type').value = student.student_type || '';
      document.getElementById('edit_student_address').value = student.address || '';
      document.getElementById('edit_student_program').value = student.program_and_yr || '';
      
      document.getElementById('edit_student_elem').value = student.elem_school || '';
      document.getElementById('edit_student_elem_year').value = student.elem_year || '';
      document.getElementById('edit_student_jhs').value = student.jhs_school || '';
      document.getElementById('edit_student_jhs_year').value = student.jhs_year || '';
      document.getElementById('edit_student_shs').value = student.shs_school || '';
      document.getElementById('edit_student_shs_year').value = student.shs_year || '';
      document.getElementById('edit_student_college').value = student.college_school || '';
      document.getElementById('edit_student_college_year').value = student.college_year || '';
      document.getElementById('edit_student_achievements').value = student.achievements || '';
      document.getElementById('edit_student_parent').value = student.parent_name || '';
      document.getElementById('edit_student_guardian').value = student.guardian_name || '';
      document.getElementById('edit_student_guardian_contact').value = student.guardian_contact || '';
      handleAdminStudentTypeChange();

      // Handle status select if you want to allow status changes via edit:
      const statusSelect = document.getElementById('edit_student_status');
      if (statusSelect) statusSelect.value = student.status;

      document.getElementById('edit-student-modal').style.display = 'block';
    }

    function closeEditStudentModal() {
      document.getElementById('edit-student-modal').style.display = 'none';
    }

    function handleAdminStudentTypeChange() {
      const typeSelect = document.getElementById('edit_student_type');
      const container = document.getElementById('edit_program_yr_container');
      const input = document.getElementById('edit_student_program');
      
      if (typeSelect.value === 'Undergraduate') {
        container.style.display = 'block';
        input.setAttribute('required', 'required');
      } else {
        container.style.display = 'none';
        input.removeAttribute('required');
        input.value = '';
      }
    }

    // Edit Student Form Handler
    document.addEventListener('DOMContentLoaded', () => {
      const editStudentForm = document.getElementById('edit-student-form');
      if (editStudentForm) {
        editStudentForm.addEventListener('submit', function (e) {
          e.preventDefault();

          const studentId = document.getElementById('edit_student_id').value;
          const formData = new FormData(this);

          // Convert FormData to JSON object
          const data = {};
          formData.forEach((value, key) => data[key] = value);

          fetch(`/api/admin/students/${studentId}/edit/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data),
            credentials: 'same-origin'
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                Swal.fire('Success', data.message, 'success');
                closeEditStudentModal();
                loadStudents();
              } else {
                Swal.fire('Error', 'Error updating student: ' + data.error, 'error');
              }
            })
            .catch(err => {
              console.error('Error updating student:', err);
              Swal.fire('Error', 'An error occurred while updating the student.', 'error');
            });
        });
      }
    });

    function filterStudents() {
      const searchText = document.getElementById('student-search').value.toLowerCase();
      const statusFilter = document.getElementById('student-status-filter').value;
      const items = document.querySelectorAll('.student-item');

      items.forEach(item => {
        const nameMatch = item.dataset.name.includes(searchText);
        const statusMatch = statusFilter === 'all' || item.dataset.status === statusFilter;

        if (nameMatch && statusMatch) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    }
  </script>
      </main>
    </div>
  </div>

  <footer style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #e0e0e0; color: #666; font-size: 14px;">
     2024 Lander. All rights reserved.
  </footer>



  <!-- Application Details Modal -->
  <div id="application-modal" class="fixed inset-0 z-[2000] flex items-center justify-center p-4 sm:p-6 w-full h-full" style="display: none; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);">
    <div class="relative bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl flex flex-col w-full max-w-3xl max-h-[90vh] mx-auto animate-slide-up overflow-hidden">
      <div class="modal-header flex justify-between items-center mb-6 pb-4 border-b border-gray-100 dark:border-gray-700">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="app-modal-title">Application Details</h3>
        <span class="close text-gray-400 hover:text-gray-600 dark:hover:text-white text-2xl cursor-pointer" onclick="closeApplicationModal()">&times;</span>
      </div>
      <div class="modal-body space-y-6 overflow-y-auto custom-scrollbar flex-1">
        <div class="app-detail-grid grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 dark:bg-gray-700/50 p-5 rounded-lg border border-gray-100 dark:border-gray-700">
          <div class="detail-row flex flex-col gap-1">
            <span class="detail-label text-xs font-semibold text-gray-500 uppercase tracking-wider">Student</span>
            <span class="detail-value text-gray-900 dark:text-white font-medium" id="app-modal-student"></span>
          </div>
          <div class="detail-row flex flex-col gap-1">
            <span class="detail-label text-xs font-semibold text-gray-500 uppercase tracking-wider">Program</span>
            <span class="detail-value text-gray-900 dark:text-white font-medium" id="app-modal-program"></span>
          </div>
          <div class="detail-row flex flex-col gap-1">
            <span class="detail-label text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</span>
            <span class="detail-value text-gray-900 dark:text-white font-medium" id="app-modal-status"></span>
          </div>
          <div class="detail-row flex flex-col gap-1">
            <span class="detail-label text-xs font-semibold text-gray-500 uppercase tracking-wider">Email</span>
            <span class="detail-value text-gray-900 dark:text-white font-medium" id="app-modal-email"></span>
          </div>
          <div class="detail-row flex flex-col gap-1">
            <span class="detail-label text-xs font-semibold text-gray-500 uppercase tracking-wider">Applied On</span>
            <span class="detail-value text-gray-900 dark:text-white font-medium" id="app-modal-date"></span>
          </div>
        </div>

        <div>
          <h4 class="modal-section-title text-base font-semibold text-gray-800 dark:text-white mb-3 flex items-center gap-2"><i class="fas fa-file-alt text-brand-primary"></i> Documents</h4>
          <div id="app-modal-document" class="space-y-4"></div>
        </div>


      </div>
      <div class="modal-footer mt-8 pt-4 border-t border-gray-100 dark:border-gray-700 flex justify-end">
        <button class="btn btn-secondary px-5 py-2.5 rounded-lg font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition duration-300" onclick="closeApplicationModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Remarks Modal -->
  <div id="remarks-modal" class="modal" style="display: none;">
    <div class="modal-content !max-w-2xl bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl">
      <div class="modal-header flex justify-between items-center mb-6 border-b border-gray-100 dark:border-gray-700 pb-4">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="remarks-modal-title">Application Remarks</h3>
        <span class="close text-gray-400 hover:text-gray-600 dark:hover:text-white text-2xl cursor-pointer" onclick="closeRemarksModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="remarks-form">
          <div class="form-group mb-6">
            <label for="remarks-editor" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Remarks / Comments</label>
            <style>
              .dark .ql-toolbar { background-color: #374151; border-color: #4b5563; }
              .dark .ql-container { border-color: #4b5563; color: #f3f4f6; }
              .dark .ql-snow .ql-stroke { stroke: #d1d5db; }
              .dark .ql-snow .ql-fill { fill: #d1d5db; }
              .dark .ql-snow .ql-picker { color: #d1d5db; }
            </style>
            <div id="remarks-editor-container" class="bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg pb-[3rem]"></div>
            <input type="hidden" name="remarks" id="remarks-hidden-input">
          </div>
          <div class="modal-footer flex justify-end gap-3 pt-6 mt-[2rem] border-t border-gray-100 dark:border-gray-700">
            <button type="button" class="btn btn-secondary px-5 py-2.5 rounded-lg font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition duration-300 border border-gray-300 dark:border-gray-600" onclick="closeRemarksModal()">Cancel</button>
            <button type="submit" class="btn btn-primary px-5 py-2.5 rounded-lg font-medium shadow transition-colors duration-200 bg-brand-primary text-white hover:bg-brand-secondary" id="remarks-submit-btn">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // ... (previous scripts) ...

    function viewApplication(appId) {
      const app = currentApplications.find(a => a.app_id === appId);
      if (!app) return;

      document.getElementById('app-modal-student').textContent = `${app.student.first_name} ${app.student.last_name} (@${app.student.username})`;
      document.getElementById('app-modal-program').textContent = app.program.program_name;
      document.getElementById('app-modal-status').textContent = app.requirement_status;
      document.getElementById('app-modal-email').textContent = app.student.email;
      document.getElementById('app-modal-date').textContent = app.created_at ? new Date(app.created_at).toLocaleString() : 'N/A';

      // Colorize status
      const statusEl = document.getElementById('app-modal-status');
      statusEl.className = `detail-value status-badge status-${app.requirement_status}`;
      statusEl.style.display = 'inline-block';

      const docContainer = document.getElementById('app-modal-document');
      docContainer.innerHTML = ''; // Clear previous content

      const documents = app.documents || [];
      // Backward compatibility: check if doc_submitted exists and isn't already in documents list
      if (app.student.doc_submitted && documents.length === 0) {
        documents.push({ url: app.student.doc_submitted, name: 'Document' });
      }

      if (documents.length > 0) {
        documents.forEach(doc => {
          const fileExt = doc.url.split('.').pop().toLowerCase();
          const docWrapper = document.createElement('div');
          docWrapper.className = 'document-wrapper';

          const title = document.createElement('div');
          title.className = 'document-title';
          title.textContent = doc.name || 'Document';
          docWrapper.appendChild(title);

          if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExt)) {
            docWrapper.innerHTML += `<img src="${doc.url}" alt="Submitted Document" class="document-preview-img">`;
          } else if (fileExt === 'pdf') {
            docWrapper.innerHTML += `
                <iframe src="${doc.url}" class="document-preview-frame"></iframe>
                <div style="text-align: right;">
                  <a href="${doc.url}" target="_blank" class="btn btn-sm btn-secondary"><i class="fas fa-external-link-alt"></i> Open PDF in New Tab</a>
                </div>
            `;
          } else if (['doc', 'docx'].includes(fileExt)) {
            docWrapper.innerHTML += `
                <div class="document-fallback">
                    <i class="fas fa-file-word"></i>
                    <p>Word documents cannot be previewed directly.</p>
                    <a href="${doc.url}" download class="btn btn-sm btn-primary"><i class="fas fa-download"></i> Download Document</a>
                </div>
             `;
          } else {
            docWrapper.innerHTML += `
                <div class="document-fallback">
                    <i class="fas fa-file"></i>
                    <p>Preview not available for this file type.</p>
                    <a href="${doc.url}" download class="btn btn-sm btn-primary"><i class="fas fa-download"></i> Download File</a>
                </div>
             `;
          }
          docContainer.appendChild(docWrapper);
        });
      } else {
        docContainer.innerHTML = '<p class="text-muted" style="padding: 10px; font-style: italic;">No document submitted</p>';
      }

      // Motivation removed

      document.getElementById('application-modal').style.display = 'block';
    }
  </script>
  <!-- Edit Program Modal -->
  <div id="edit-program-modal" class="modal" style="display: none;">
    <div class="modal-content !max-w-2xl bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="modal-header flex justify-between items-center mb-6 pb-4 border-b border-gray-100 dark:border-gray-700">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="edit-program-title">Edit Program</h3>
        <span class="close text-gray-400 hover:text-gray-600 dark:hover:text-white text-2xl cursor-pointer" onclick="closeEditProgramModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="edit-program-form" class="space-y-4">
          <input type="hidden" name="program_id" id="edit_program_id">

          <div class="form-group">
            <label for="edit_program_name" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Program Name</label>
            <input type="text" id="edit_program_name" name="program_name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm" required>
          </div>

          <div class="form-group">
            <label for="edit_program_type" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Program Type</label>
            <select id="edit_program_type" name="program_type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm bg-white dark:bg-gray-700" required>
              <option value="Financial Assistance">Financial Assistance</option>
              <option value="Scholarship">Scholarship</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="edit_requirements" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Description</label>
            <textarea id="edit_requirements" name="requirements" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm"></textarea>
          </div>

          <div class="form-group mt-4">
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Required Documents</label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 bg-white dark:bg-gray-700 p-3 rounded-lg border border-gray-300 dark:border-gray-600" id="edit_document_requirements_container">
                <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300"><input type="checkbox" name="document_requirements" value="School ID (Current Semester)" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"><span>School ID (Current Semester)</span></label>
                <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300"><input type="checkbox" name="document_requirements" value="Valid ID" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"><span>Valid ID</span></label>
                <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300"><input type="checkbox" name="document_requirements" value="TOR" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"><span>TOR</span></label>
                <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300"><input type="checkbox" name="document_requirements" value="Voter's Certificate" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"><span>Voter's Certificate</span></label>
                <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300"><input type="checkbox" name="document_requirements" value="Certificate of Indigency" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"><span>Certificate of Indigency</span></label>
                <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300"><input type="checkbox" name="document_requirements" value="Letter of Application" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"><span>Letter of Application</span></label>
                <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300"><input type="checkbox" name="document_requirements" value="Other" class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"><span>Other</span></label>
            </div>
          </div>

          <div class="form-group grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="edit_application_start_date" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Start Date</label>
              <input id="edit_application_start_date" name="application_start_date" type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
            </div>
            <div>
              <label for="edit_application_end_date" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">End Date</label>
              <input id="edit_application_end_date" name="application_end_date" type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
            </div>
          </div>

          <div class="form-group">
            <label for="edit_program_image" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Background Image (Leave empty to keep current)</label>
            <input type="file" id="edit_program_image" name="program_image" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-primary file:text-white hover:file:bg-brand-secondary">
          </div>

          <div class="modal-footer flex justify-end gap-3 pt-6 mt-6 border-t border-gray-100 dark:border-gray-700">
            <button type="button" class="btn btn-secondary px-5 py-2.5 rounded-lg font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition duration-300 border border-gray-300 dark:border-gray-600" onclick="closeEditProgramModal()">Cancel</button>
            <button type="submit" class="btn btn-primary bg-brand-primary text-white px-5 py-2.5 rounded-lg font-medium shadow hover:bg-brand-secondary transition-colors duration-200">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    let allPrograms = []; // Store fetched programs locally

    // ... (previous scripts) ...

    function openEditProgramModal(programId) {
      const program = allPrograms.find(p => p.program_id === programId);
      if (!program) return;

      document.getElementById('edit_program_id').value = program.program_id;
      document.getElementById('edit_program_name').value = program.program_name;
      document.getElementById('edit_program_type').value = program.program_type || 'Other';
      document.getElementById('edit_requirements').value = program.requirements;
      document.getElementById('edit_application_start_date').value = program.application_start_date || '';
      document.getElementById('edit_application_end_date').value = program.application_end_date || '';

      // Check document requirements
      const checkboxes = document.querySelectorAll('#edit_document_requirements_container input[type="checkbox"]');
      const requiredDocs = program.document_requirements || [];
      checkboxes.forEach(cb => {
         cb.checked = requiredDocs.includes(cb.value);
      });

      document.getElementById('edit-program-modal').style.display = 'flex';
    }

    function closeEditProgramModal() {
      document.getElementById('edit-program-modal').style.display = 'none';
      document.getElementById('edit-program-form').reset();
    }

    document.getElementById('edit-program-form').addEventListener('submit', function (e) {
      e.preventDefault();
      const programId = document.getElementById('edit_program_id').value;
      const formData = new FormData(this);

      fetch(`/home/edit_program/${programId}/`, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire('Success', 'Program updated successfully', 'success');
            closeEditProgramModal();
            loadPrograms();
          } else {
            Swal.fire('Error', 'Error updating program: ' + (data.error || 'Unknown error'), 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          Swal.fire('Error', 'An error occurred while updating the program.', 'error');
        });
    });

    function deleteProgram(programId) {
      Swal.fire({
        title: 'Delete Program?',
        text: "Are you sure you want to delete this program? This cannot be undone.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, delete!'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/home/delete_program/${programId}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json'
            }
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                Swal.fire('Deleted', 'Program deleted successfully', 'success');
                loadPrograms();
              } else {
                Swal.fire('Error', 'Error deleting program: ' + (data.error || 'Unknown error'), 'error');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              Swal.fire('Error', 'An error occurred while deleting the program.', 'error');
            });
        }
      });
    }
  </script>
  <!-- Edit Student Modal -->
  <div id="edit-student-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="edit-student-title">Edit Student</h3>
        <span class="close" onclick="closeEditStudentModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="edit-student-form">
          <input type="hidden" name="student_id" id="edit_student_id">

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="edit_student_first_name">First Name</label>
              <input type="text" id="edit_student_first_name" name="first_name" required>
            </div>
            <div class="form-group">
              <label for="edit_student_mname">Middle Name</label>
              <input type="text" id="edit_student_mname" name="mname">
            </div>
            <div class="form-group">
              <label for="edit_student_last_name">Last Name</label>
              <input type="text" id="edit_student_last_name" name="last_name" required>
            </div>
          </div>

          <div class="form-group">
            <label for="edit_student_username">Username</label>
            <input type="text" id="edit_student_username" name="username" required>
          </div>

          <div class="form-group">
            <label for="edit_student_email">Email</label>
            <input type="email" id="edit_student_email" name="email" required>
          </div>

          <div class="form-group">
            <label for="edit_student_type">Type of Student</label>
            <select id="edit_student_type" name="student_type" required onchange="handleAdminStudentTypeChange()">
              <option value="" disabled selected>Select student type</option>
              <optgroup label="High School">
                <option value="Junior High School">Junior High School</option>
                <option value="Senior High School">Senior High School</option>
              </optgroup>
              <optgroup label="College">
                <option value="Undergraduate">Undergraduate</option>
                <option value="Master's">Master's</option>
                <option value="Doctoral">Doctoral</option>
              </optgroup>
              <optgroup label="Other">
                <option value="Board Exam">Board Exam</option>
              </optgroup>
            </select>
          </div>

          <div class="form-group" id="edit_program_yr_container" style="display: none;">
            <label for="edit_student_program">Program & Year</label>
            <input type="text" id="edit_student_program" name="program_and_yr">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="edit_student_contact">Contact Number</label>
              <input type="text" id="edit_student_contact" name="contact_num" required>
            </div>
            <div class="form-group">
              <label for="edit_student_status">Status</label>
              <select id="edit_student_status" name="status">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="pending">Pending</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="edit_student_barangay">Barangay</label>
            <select id="edit_student_barangay" name="barangay" required>
              <option value="" disabled selected>Select your barangay</option>
              <option value="Aningway-Sacatihan">Aningway-Sacatihan</option>
              <option value="Asinan (Poblacion)">Asinan (Poblacion)</option>
              <option value="Asinan Proper">Asinan Proper</option>
              <option value="Baraca-Camachile (Poblacion)">Baraca-Camachile (Poblacion)</option>
              <option value="Batiawan">Batiawan</option>
              <option value="Calapacuan">Calapacuan</option>
              <option value="Calapandayan (Poblacion)">Calapandayan (Poblacion)</option>
              <option value="Cawag">Cawag</option>
              <option value="Ilwas (Poblacion)">Ilwas (Poblacion)</option>
              <option value="Mangan-Vaca">Mangan-Vaca</option>
              <option value="Matain">Matain</option>
              <option value="Naugsol">Naugsol</option>
              <option value="Pamatawan">Pamatawan</option>
              <option value="San Isidro">San Isidro</option>
              <option value="Santo Tomas">Santo Tomas</option>
              <option value="Wawandue (Poblacion)">Wawandue (Poblacion)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="edit_student_address">Address</label>
            <textarea id="edit_student_address" name="address" rows="2" required></textarea>
          </div>

          <hr style="margin: 15px 0;">
          <h4 style="margin-bottom: 10px; font-weight: 600;">Academic History</h4>
          <!-- Elem -->
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="edit_student_elem">Elementary</label>
              <input type="text" id="edit_student_elem" name="elem_school">
            </div>
            <div class="form-group">
              <label for="edit_student_elem_year">Year Graduated</label>
              <input type="text" id="edit_student_elem_year" name="elem_year">
            </div>
          </div>
          <!-- JHS -->
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="edit_student_jhs">Junior High School</label>
              <input type="text" id="edit_student_jhs" name="jhs_school">
            </div>
            <div class="form-group">
              <label for="edit_student_jhs_year">Year Graduated</label>
              <input type="text" id="edit_student_jhs_year" name="jhs_year">
            </div>
          </div>
          <!-- SHS -->
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="edit_student_shs">Senior High School</label>
              <input type="text" id="edit_student_shs" name="shs_school">
            </div>
            <div class="form-group">
              <label for="edit_student_shs_year">Year Graduated</label>
              <input type="text" id="edit_student_shs_year" name="shs_year">
            </div>
          </div>
          <!-- College -->
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="edit_student_college">College</label>
              <input type="text" id="edit_student_college" name="college_school">
            </div>
            <div class="form-group">
              <label for="edit_student_college_year">Year Graduated</label>
              <input type="text" id="edit_student_college_year" name="college_year">
            </div>
          </div>

          <hr style="margin: 15px 0;">
          <h4 style="margin-bottom: 10px; font-weight: 600;">Certificates & Achievements</h4>
          <div class="form-group">
            <textarea id="edit_student_achievements" name="achievements" rows="3"></textarea>
          </div>

          <hr style="margin: 15px 0;">
          <h4 style="margin-bottom: 10px; font-weight: 600;">Family Background</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="edit_student_parent">Parent Name</label>
              <input type="text" id="edit_student_parent" name="parent_name">
            </div>
            <div class="form-group">
              <label for="edit_student_guardian">Guardian Name</label>
              <input type="text" id="edit_student_guardian" name="guardian_name">
            </div>
            <div class="form-group">
              <label for="edit_student_guardian_contact">Contact</label>
              <input type="text" id="edit_student_guardian_contact" name="guardian_contact">
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditStudentModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script>
    // Clear forms on load and disable autocomplete for all inputs
    document.addEventListener('DOMContentLoaded', function() {
      const forms = document.querySelectorAll('form');
      forms.forEach(form => form.reset());
      
      const inputs = document.querySelectorAll('input, textarea');
      inputs.forEach(input => {
        input.setAttribute('autocomplete', 'off');
      });
    });
  </script>

  <!-- Program Applicants Modal -->
  <div id="program-applicants-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-gray-900/50 backdrop-blur-sm" style="display: none;">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col transform transition-all">
      <div class="modal-header flex justify-between items-center p-6 border-b border-gray-100 dark:border-gray-700">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white">Program Applicants</h3>
        <button type="button" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors" onclick="closeProgramApplicantsModal()">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex flex-col sm:flex-row gap-4">
        <input type="text" id="applicants-search" placeholder="Search by name or username..." class="flex-1 p-2 border border-gray-300 rounded-lg text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" onkeyup="renderApplicants()">
        <select id="applicants-status-filter" class="p-2 border border-gray-300 rounded-lg text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" onchange="renderApplicants()">
          <option value="all">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>
      
      <div class="overflow-y-auto flex-1 p-0">
        <table class="w-full text-left border-collapse">
            <thead class="sticky top-0 bg-gray-50 dark:bg-gray-700/50">
                <tr>
                    <th class="p-3 text-xs font-semibold text-gray-500 uppercase tracking-wider border-b border-gray-200 dark:border-gray-600">Student</th>
                    <th class="p-3 text-xs font-semibold text-gray-500 uppercase tracking-wider border-b border-gray-200 dark:border-gray-600">Status</th>
                    <th class="p-3 text-xs font-semibold text-gray-500 uppercase tracking-wider border-b border-gray-200 dark:border-gray-600">Applied Date</th>
                    <th class="p-3 text-xs font-semibold text-gray-500 uppercase tracking-wider text-right border-b border-gray-200 dark:border-gray-600">Actions</th>
                </tr>
            </thead>
            <tbody id="applicants-list-container" class="divide-y divide-gray-100 dark:divide-gray-700">
                <!-- Data injected via JS -->
            </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Program Applicants Modal Logic
    let currentApplicants = [];
    let currentProgramType = 'Other';

    async function openProgramApplicantsModal(programId, programType) {
        currentProgramType = programType;
        document.getElementById('applicants-search').value = '';
        document.getElementById('applicants-status-filter').value = 'all';
        document.getElementById('program-applicants-modal').style.display = 'flex';
        
        const container = document.getElementById('applicants-list-container');
        container.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Loading applicants...</td></tr>';
        
        try {
            const response = await fetch(`/api/admin/programs/${programId}/applicants/`);
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    currentApplicants = data.applications;
                    renderApplicants();
                } else {
                    container.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Error: ${data.error}</td></tr>`;
                }
            } else {
                container.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Failed to fetch applicants.</td></tr>';
            }
        } catch (error) {
            console.error('Error fetching applicants:', error);
            container.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Error fetching applicants.</td></tr>';
        }
    }

    function closeProgramApplicantsModal() {
        document.getElementById('program-applicants-modal').style.display = 'none';
        currentApplicants = [];
    }

    function renderApplicants() {
        const container = document.getElementById('applicants-list-container');
        const searchTerm = document.getElementById('applicants-search').value.toLowerCase();
        const statusFilter = document.getElementById('applicants-status-filter').value;
        
        const filtered = currentApplicants.filter(app => {
            const matchesSearch = app.student_name.toLowerCase().includes(searchTerm) || app.username.toLowerCase().includes(searchTerm);
            const matchesStatus = statusFilter === 'all' || app.requirement_status === statusFilter;
            return matchesSearch && matchesStatus;
        });
        
        if (filtered.length === 0) {
            container.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500 dark:text-gray-400">No applicants found.</td></tr>';
            return;
        }
        
        container.innerHTML = filtered.map(app => {
            let statusBadge = '';
            if (app.requirement_status === 'approved') statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full dark:bg-green-900 dark:text-green-200">Approved</span>';
            else if (app.requirement_status === 'rejected') statusBadge = '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full dark:bg-red-900 dark:text-red-200">Rejected</span>';
            else statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full dark:bg-yellow-900 dark:text-yellow-200">Pending</span>';
            
            let actionBtn = '';
            if (app.requirement_status === 'approved' && currentProgramType === 'Financial Assistance') {
                actionBtn = `<button class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-xs font-bold" title="Print Receipt" onclick="printFinancialReceipt(${app.app_id})"><i class="fas fa-print"></i> Print Receipt</button>`;
            }
            
            return `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <td class="p-3 text-sm text-gray-800 dark:text-gray-200">
                        <div class="font-medium">${app.student_name}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">${app.username}</div>
                    </td>
                    <td class="p-3">${statusBadge}</td>
                    <td class="p-3 text-sm text-gray-500 dark:text-gray-400 whitespace-nowrap">${app.created_at || 'N/A'}</td>
                    <td class="p-3 text-right">${actionBtn}</td>
                </tr>
            `;
        }).join('');
    }

    function printFinancialReceipt(applicationId) {
        let amount = prompt("Please enter the PHP amount for the receipt (e.g. 5000):", "0");
        if (amount !== null && amount.trim() !== "") {
            window.open(`/admin-receipt/${applicationId}/?amount=${encodeURIComponent(amount)}`, '_blank');
        }
    }

    function printStudentProfile() {
        document.body.classList.add('printing-profile');
        window.print();
        setTimeout(() => {
            document.body.classList.remove('printing-profile');
        }, 1000);
    }

    function downloadStudentProfile() {
        // Temporarily style it for PDF printing
        document.body.classList.add('printing-profile');
        const element = document.getElementById('student-profile-section');
        
        // Setup html2pdf options
        const opt = {
          margin:       0.5,
          filename:     `Student_Profile_${document.getElementById('sp-name').innerText.replace(/\s+/g, '_')}.pdf`,
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2, useCORS: true },
          jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        
        // Generate PDF
        html2pdf().set(opt).from(element).save().then(() => {
            document.body.classList.remove('printing-profile');
        }).catch(err => {
            console.error("PDF generation error:", err);
            document.body.classList.remove('printing-profile');
        });
    }
  </script>

</body>

</html>